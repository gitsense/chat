/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let h=require("../../../../devboard/utils/html.js"),svg=require("../../../../devboard/utils/svg.js"),GSFileUploader=require("@gitsense/file-uploader"),History=require("./history.js").History,{deleteChat,newChat,newChatTree,set:setChat}=require("./chat.js"),getOptions=require("./options.js").get,createResizableTextArea=require("./textarea_resizer.js").createResizableTextArea,DropDownMenu=require("../../../../devboard/components/drop-down-menu.js"),QuickChatButtons=require("./components/chat-builder/QuickChatButtons"),PromptMenu=require("./components/chat-builder/menus/PromptMenu"),ModelMenu=require("./components/chat-builder/menus/ModelMenu"),TemperatureMenu=require("./components/chat-builder/menus/TemperatureMenu"),RenameChatModal=require("./components/chat-builder/modals/RenameChatModal"),DropDown=require("./components/ui/dropdown").DropDown,parseSlashSearchCommand=require("./components/search/frontend/utils/slashCommandParser").parseSlashCommand,SEND_ON_ENTER_ID="gs-chat-home-submit-on-enter";function HomePage(v,e,t,n,f){let o=820,b=null;this.render=function(e){(async e=>{b=await getOptions(v);var{titleBody:e,sloganBody:t,chatBody:d,helpBody:n,quickChatButtonsBody:i,historyBody:a}=(e=>{var t=h.createDiv({style:{marginTop:"75px",textAlign:"center"}}),n=h.createDiv({style:{fontSize:"16px",textAlign:"center"}}),i=h.createDiv({cls:"gs-chat-container",style:{width:f?null:o+"px"}}),a=h.createDiv({cls:"gs-chat-container",style:{width:f?null:o+"px",fontWeight:500,marginTop:"30px"}}),l=h.createDiv({cls:"gs-chat-container",style:{marginTop:"25px",width:f?null:o-50+"px"}}),r=h.createDiv({cls:"gs-chat-container",style:{marginTop:"25px",width:f?null:o+"px"}}),s=h.createDiv({append:[r]});return e.style.textAlign="center",e.appendChild(t),e.appendChild(n),e.appendChild(i),e.appendChild(a),e.appendChild(l),e.appendChild(s),{titleBody:t,sloganBody:n,chatBody:i,helpBody:a,quickChatButtonsBody:l,historyBody:r}})(e),l=h.createSpan({text:"GitSense Chat",style:{fontSize:"36px",fontWeight:500}});e.appendChild(l),t.innerText=" Master Context. Search Smarter. Manage Knowledge. Build Faster.";{var c=d;let{promptsBody:e,inputBody:t,errorsBody:y,menusBody:n,filesBody:i,selectFilesBody:a,submitOptionsBody:l,resizeLeft:r,resizeRight:s}=(()=>{var e=h.createDiv({style:{paddingTop:"15px",paddingBottom:"10px"}}),t=h.createDiv({}),n=h.createDiv({style:{display:"none",marginBottom:"17px"}}),i=h.createDiv({style:{display:"inline-block",width:"calc(100% - 300px)",textAlign:"center"}}),a=h.createDiv({append:[svg.grabber()],style:{display:"inline-block",width:"20px",cursor:"ns-resize",textAlign:"center"}}),l=h.createDiv({append:[svg.grabber()],style:{display:"inline-block",width:"20px",cursor:"ns-resize",textAlign:"center"}}),r=h.createDiv({append:[a,h.createDiv({style:{display:"inline-block",width:"calc(100% - 40px)"}}),l],style:{padding:"0px 7px 10px 7px"}}),s=h.createDiv({style:{padding:"12px 15px"}}),o=h.createDiv({style:{textAlign:"left"}}),d=h.createDiv({style:{display:"inline-block",width:"150px",textAlign:"left",paddingLeft:"5px"}}),p=h.createDiv({style:{display:"inline-block",width:"150px",textAlign:"right",paddingRight:"5px"}}),r=h.createDiv({cls:"gs-chat-input-container",append:[e,t,n,r,o,h.createDiv({append:[d,i,p],style:{padding:"10px",borderTop:"1px solid #666"}})],style:{boxShadow:"0 5px 5px rgba(0, 0, 0, 0.1)"}});return c.appendChild(r),{promptsBody:e,inputBody:t,errorsBody:n,menusBody:i,inputOptionsBody:s,filesBody:o,selectFilesBody:d,submitOptionsBody:p,resizeLeft:a,resizeRight:l}})(),u=new PromptMenu([...b.prompts]),o=(u.render(e),new function(a,l){let r=this;function n(t){var e;t&&({selectFilesBody:t,submitOptionsBody:n}=(t=t,n=h.createDiv({style:{display:"inline-block",width:"50%",textAlign:"left"}}),e=h.createDiv({style:{display:"inline-block",width:"50%",textAlign:"right"}}),t.appendChild(n),t.appendChild(e),{selectFilesBody:n,submitOptionsBody:e}),a=t,l=n),e=a,t=h.createLink({append:[svg.paperclip({style:{verticalAlign:"middle",marginRight:"6px"}}),h.createSpan({text:"Add text files",style:{verticalAlign:"middle"}})],style:{color:"black",cursor:"pointer",textDecoration:"none"}}),e.appendChild(t),t.onclick=()=>{m.triggerFileInput()};{var n=l;let e=h.createCheckbox({style:{verticalAlign:"middle"}});r.sendOnEnter&&(e.checked=!0,r.sendOnEnter=!0);var t=h.createSpan({text:"Enter to send",style:{marginLeft:"6px",verticalAlign:"middle",cursor:"pointer"}}),i=h.createDiv({append:[e,t],style:{display:"inline-block"}});n.appendChild(i),t.onclick=()=>{e.click()},e.onclick=()=>{e.checked?r.sendOnEnter=!0:r.sendOnEnter=!1}}}r.sendOnEnter=null==localStorage.getItem(SEND_ON_ENTER_ID)||"true"===localStorage.getItem(SEND_ON_ENTER_ID),this.render=function(e,t){n()}}(a,l)),g=(o.render(),new function(t,n,i,a){let l=null,r=null,s=null;function o(){var e=r.value.trim(),t=l.getFiles();""===e&&0===t.length?s.style.display="none":s.style.display="inline-block"}this.render=function(e){e=e,r=h.createTextArea({cls:"gs-chat-input",placeholder:"Ask anything...",style:{paddingRight:"40px",fontSize:"15px"}}),(s=h.createButton({cls:"gs-chat-enter-button",append:[svg.arrowUp({})],style:{}})).onclick=()=>{p()},e.appendChild(r),e.appendChild(s),r.addEventListener("keydown",e=>{"Enter"===e.key&&i.sendOnEnter&&!e.shiftKey&&(e.preventDefault(),a())}),r.addEventListener("keyup",e=>{o()}),r.addEventListener("paste",e=>{o()}),r.focus(),e={maxHeight:1e3,minHeight:75,dragDirection:"down"},createResizableTextArea(r,t,e),createResizableTextArea(r,n,e)},this.getMessage=function(){return r.value.trim()},this.getInput=function(){return r},this.setGFU=function(e){l=e},this.updateButton=function(){if(!l)throw new Error("GFU has not been defined");o()}}(r,s,o,()=>{""===g.getMessage()?(y.innerHTML="",y.style.display="none"):p()})),m=(g.render(t),new GSFileUploader({dropZone:t,filesContainer:i,onFileChange:e=>{var{action:e,totals:t}=e;"uploaded"!==e&&"removed"!==e||(e=t.totalFiles,i.style.borderTop=0===e?null:"1px solid #aaa",g.updateButton())},onError:e=>{var{}=e}})),x=(m.init(),g.setGFU(m),new function(e){let i=null;this.render=function(e){e=e=e,t=h.createDiv({style:{display:"inline-block",textAlign:"left"}}),n=h.createDiv({style:{display:"none",marginLeft:"20px",textAlign:"left"}}),e.appendChild(t),e.appendChild(n);var{modelsBody:e,tempsBody:t}={modelsBody:t,tempsBody:n},n=[...b.models];n.find(e=>e.default)||(n[0].default=!0),(i=new ModelMenu(b.models,{fakeLLMs:b.fakeLLMs})).render(e),(tempMenu=new TemperatureMenu).render(t)},this.getAllSelected=function(){return{model:i.getSelected(),temperature:tempMenu.getSelected(),analysis:{type:"none"}}}});async function p(){let a=g.getMessage(),e=null;var t=u.getSelected(),n=m.getFiles(),{model:i,temperature:l,analysis:r}=x.getAllSelected(),{type:s,options:o}=r;let d=(o||{}).models;var o=parseSlashSearchCommand(a,i),p=o;let c=s.match(/validate/i);s=s.match(/models/i);if((c||s)&&0===d.length)s=c?"Disable validation or select one or more models to validate with":"Disable insights or select one or more models to ask",y.style.display=null,y.appendChild(h.createSpan({text:s,style:{backgroundColor:"#ffebe9",border:"1px solid #fa4549",color:"#fa4549",padding:"5px 10px",borderRadius:"5px"}}));else{p?(a=null,e=[{role:"system",message:"<replace with system message>"},{role:"user",message:""},{role:"assistant",message:p}]):n.forEach((e,t)=>{var{name:e,content:n,language:i}=e;a+="\n\n#### File: `"+e+"`\n\n```"+i.toLowerCase()+`
${n}
`+"```"}),y.innerHTML="",y.style.display="";var s={name:o?"Ask or Search":"",stream:!p,model:i,temperature:l,prompt:t,message:a,messages:e,analysis:r},{uuid:n,main_model:o}=await newChat(v,s),{pathname:p,search:i}=window.location,l=new URLSearchParams(i);if(f){t=l.get("chats").split(",");let e=l.get("models").split(",");r="left"===f?0:1;t[r]=n,e[r]=o,l.set("chats",t.join(",")),l.set("models",e.join(","))}else l.set("chat",n);s=(""===p?"/":p)+"?"+l.toString();window.location.assign(s)}}x.render(n)}e=n,t=h.createLink({append:[svg.rocket({style:{marginRight:"5px"}}),h.createSpan({text:"Start GitSense Chat Demos",style:{verticalAlign:"middle"}})],href:"#",style:{color:"black",fontSize:"1.05em",textDecoration:"none"},onclick:e=>{e.preventDefault();let t=h.createDiv({});document.body.appendChild(t);var e={settings:b,widget:v,inSideBySide:f},n={type:"demos",onSuccess:()=>{t.remove()}},e=new QuickChatButtons([n],e);e.render(t),e.click(n)}}),d=h.createLink({append:[svg.book({style:{marginRight:"5px"}}),h.createSpan({text:"Load Personal Help Guide",style:{verticalAlign:"middle"}})],href:"#",style:{color:"black",fontSize:"1.05em",textDecoration:"none"},onclick:e=>{e.preventDefault();let t=h.createDiv({});document.body.appendChild(t);var e={settings:b,widget:v,inSideBySide:f},n={type:"help",onSuccess:()=>{t.remove()}},e=new QuickChatButtons([n],e);e.render(t),e.click(n)}}),e.appendChild(t),e.appendChild(h.createSpan({style:{marginLeft:"12px",marginRight:"12px"}})),e.appendChild(d),n=i,t={settings:b,widget:v,inSideBySide:f},(t=new QuickChatButtons([{type:"analyze",label:"Analyze"},{type:"organize"},{type:"notes"},{type:"task"},{type:"draft"},{type:"code"},{type:"search",label:"Ask or Search",style:{marginTop:"20px"}},{type:"context",label:"Build Context",newChat:!0,style:{marginTop:"20px"}},{type:"analyzers",label:"View Analyzers",style:{marginTop:"20px"}},{type:"repos",label:"Browse Repositories",style:{marginTop:"20px"}}],t,{design:"pill"})).render(n),e=a;new History({enableDeleteChat:b.permissions.deleteChat,hideIfNoHistory:!0,minSelectable:2,maxSelectable:2,pageOneRows:20,rowsPerPage:b.history?.rowsPerPage,inSideBySide:f},{onDeleteChat:async(e,t)=>{await deleteChat(v,e);t&&t(e)},onRenameChat:function(e,t){e=new RenameChatModal(v,e,b.models,e=>{t(e)});e.render()},onSelectedChats:function(e){}}).render(e)})(e)}}module.exports={HomePage:HomePage};
