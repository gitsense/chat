/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let ScrollUtils=require("../utils/ScrollUtils"),DomUtils=require("../utils/DomUtils"),MessageUtils=require("../utils/MessageUtils"),ScrollIntentState=require("../utils/ScrollIntentManager").ScrollIntentState,{ConfirmationBox,chatAPI}=require("../Dependencies"),MessageModal=require("./modals/EditMessageModal").MessageModal;async function renderUserMessage(a,e,t,s,l,i,n){if(!n||"function"!=typeof n)throw new Error("renderAssistantMessages function not defined");let{id:r,role:o,kids:d,message:c,level:g}=a,{messagesBody:h,messageBodies:p,renderedMessage:m,messageStateManager:u,md:y,chat:M,widget:U,scrollIntentManager:f}=s,{MAX_COLLAPSED_MSG_HEIGHT:w,scrollToBottomOnLoad:S,scrollableElement:D,enableEnhancedScrolling:x=!0}=l;if("user"!==o)throw new Error(`Expecting user message but found ${o} message instead`);if(!m[r]&&""!==c){var v=ScrollUtils.trackScrollPosition(D||window);let e=u.getState(MessageUtils.getMsgStateId(r)),t=DomUtils.h.createDiv({id:a.id,cls:"gs-chat-user-message",style:{textAlign:"left",maxHeight:e?null:w+"px",overflow:e?null:"hidden"}});var{lineage:b=[]}=M,b=("regular"!==M.type&&"notes"!==M.type&&!M.type.match(/split/)&&b.length&&g<=2?renderSpecialChatHeader(t,M,c):(b=DomUtils.h.createDiv({cls:"markdown-body gs-chat-user-message-content",html:y.render(c)}),t.appendChild(b)),createActionBadge("copy",0)),k=createActionBadge("pencil",0),A=createActionBadge("trash",8),C=DomUtils.h.createDiv({append:[b,k,A],style:{display:"inline-block",verticalAlign:"top",maxWidth:"20%"}}),C=DomUtils.h.createDiv({cls:"gs-chat-user-message-body",append:[C,t]}),B=(p.push(C),DomUtils.h.createSpan({html:"#"+p.length,style:{fontSize:"13px",marginLeft:"10px",color:"gray"}}));let s=DomUtils.h.createLink({append:[e?DomUtils.h.createSpan({html:"▲"}):DomUtils.h.createTextNode("Unfold")],style:{fontSize:"13px",color:"black",cursor:"pointer"}}),l=DomUtils.h.createDiv({append:[s,B],style:{display:"none",marginTop:"10px",textAlign:"right"}});h.appendChild(C),h.appendChild(l),m[r]={rendered:!0},setupBadgeActions(b,k,A,c,a,U),setTimeout(()=>{setupFoldUnfold(t,l,s,e,w,r,u)},50),v(),!S||x&&f&&!f.shouldAutoScroll()||ScrollUtils.scrollToBottom(D,C,50)}1===d.length&&"user"===d[0].role?await renderUserMessage(d[0],a,t,s,l,i,n):await n(d,a,t,s,l,i,renderUserMessage)}function createActionBadge(e,t){var s=require("../Dependencies.js").svg;return DomUtils.h.createDiv({cls:"gs-chat-options-badge",append:[s[e]()],style:{marginRight:t+"px"}})}function setupBadgeActions(e,t,s,l,a,i){e.onclick=async()=>{e.style.opacity=0;try{await navigator.clipboard.writeText(l),setTimeout(()=>{e.style.transition="opacity 1000ms",e.style.opacity=1},100)}catch(e){console.error("Failed to copy:",e)}},t.onclick=()=>{new MessageModal(i,a,"edit",e=>{window.location.reload()}).render()},s.onclick=async()=>{let e=DomUtils.h.createCheckbox({style:{verticalAlign:"middle"}});var t=DomUtils.h.createSpan({text:"Check to delete subsequent messages",style:{marginLeft:"5px",verticalAlign:"middle"}}),t=DomUtils.h.createDiv({append:[e,t]});(new ConfirmationBox).show({title:"Delete Message",message:t},async()=>{await deleteChatMessage(i,a.id,e.checked),window.location.reload()})}}function setupFoldUnfold(e,t,s,l,a,i,n){var r=e.getBoundingClientRect().height;!(l&&r<=a)?(t.style.display=null,l||(e.style.border="1px dashed black"),s.onclick=()=>{l?(e.style.maxHeight=a+"px",e.style.overflow="hidden",e.style.border="1px dashed black",s.innerHTML="Unfold"):(e.style.maxHeight=null,e.style.overflow=null,e.style.border=null,s.innerHTML="▲"),l=!l,n.setState(MessageUtils.getMsgStateId(i),l)}):s.style.display="none"}function renderSpecialChatHeader(t,e,s){var l=window.location.search,l=new URLSearchParams(l),a=l.get("chats")?l.get("chats").split(","):[];let i=e.lineage[e.lineage.length-1];a.filter(e=>e===i.uuid).length||(l.delete("chat"),l.delete("model"),l.set("chats",e.uuid+","+i.uuid),l.set("models",e.main_model+","+i.main_model),l.toString());a=DomUtils.h.createLink({text:`Show ${e.type} message`,style:{cursor:"pointer",fontSize:"14px"}});t.appendChild(a),a.onclick=()=>{var e=DomUtils.h.createDiv({cls:"markdown-body gs-chat-user-message-content",html:md.render(s)});t.innerHTML="",t.appendChild(e)}}async function deleteChatMessage(e,t,s){if(e&&chatAPI.deleteChatMessage)return chatAPI.deleteChatMessage(e,t,s);throw new Error("Widget or deleteChatMessage method not available")}module.exports={renderUserMessage:renderUserMessage};
