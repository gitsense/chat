/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let MessageUtils=require("@gitsense/gsc-utils"),{h,svg,DropDownMenu,newChat,setChat,updateChatMessage,updateChats}=require("../../Dependencies"),showFullCodeMsg=require("../../constants/MessageConstants").showFullCodeMsg;function MessageModal(p,c,l,i,e={}){let o="fork"===l,g="edit"===l,u="show-full-code"===l;if(!o&&!g&&!u)throw new Error("Unrecognized message action "+l);let{chat:m,mainModel:w,fakeLLMs:d=0,models:r}=e,x=`Show full code (${c.id})`,v=o?`Forked (${c.id})`:null,y=/ {{GS-UUID}}\n/,C=null,M=null,f=null,b=null,S=null,D=null,L=!1;function k(){M.parentNode.removeChild(M)}this.render=function(){var{inputBody:e,optionsBody:t,buttonsBody:a}=(()=>{var e=h.createSpan({append:[svg.x()],style:{cursor:"pointer",position:"relative",top:"-10px",right:"-5px"}}),t=h.createDiv({style:{}}),a=h.createDiv({style:{display:"inline-block",width:"calc(100% - 200px)",textAlign:"left"}}),s=h.createDiv({style:{display:"inline-block",width:"200px",textAlign:"right"}}),n=h.createDiv({cls:"gs-chat-modal-header",append:[h.createH2({text:o?"Fork Chat":g?"Update Message":"Show Full Code"}),e],style:{borderBottom:"0px",padding:"20px 20px 8px 20px"}}),l=h.createDiv({cls:"gs-chat-modal-body",append:[t],style:{padding:"0px 20px"}}),i=h.createDiv({cls:"gs-chat-modal-footer",append:[a,s],style:{borderTop:"0px",padding:"20px"}}),n=h.createDiv({cls:"gs-chat-modal-content",append:[n,l,i],style:{maxWidth:"1024px"}});return M=h.createDiv({cls:"gs-chat-modal",append:[n]}),document.body.appendChild(M),document.addEventListener("mousedown",()=>{L=!1}),document.addEventListener("mousemove",()=>{L=!0}),window.addEventListener("click",e=>{e.target!==M||L||0!==window.getSelection().toString().length||k(),L=!1}),e.onclick=k,{inputBody:t,optionsBody:a,buttonsBody:s}})(),e=((f=h.createTextArea({style:{width:"100%",height:"calc(70vh)",fontSize:"15px",padding:"15px",boxSizing:"border-box",overflow:"scroll",resize:"none",border:"1px solid #aaa",borderRadius:"5px",outline:"none"}})).value=u?showFullCodeMsg:c.message,e.appendChild(f),t),t=h.createDiv({style:{display:"inline-block",marginRight:"15px"}}),s=h.createDiv({style:{display:"inline-block",marginRight:"15px"}}),n=h.createDiv({style:{display:"inline-block"}}),t=(e.appendChild(t),e.appendChild(s),e.appendChild(n),g||(e=t,(b=h.createTextInput({style:{width:"300px",padding:"2px 5px"}})).value=o?v:x,e.appendChild(h.createSpan({text:"Name: ",style:{fontWeight:500}})),e.appendChild(b),function a(s,t){t=t||"Child";let e=["None","Child","Sibling","Swap"];let n=[];e.forEach(e=>{n.push({value:e,selected:t===e})});S=new DropDownMenu(n,"<strong>Relation</strong>: ",{alignment:"ne",dropDownClass:"",dropDownStyle:{marginLeft:"4px"},callback:async(e,t)=>{s.innerHTML="",a(s,t)}});s.appendChild(S.create())}(s),function a(s,n){n=n||w;let e="GitSense Notes";let l=[...r];l.unshift({name:"----"});l.unshift({name:e});if(d){l.push({name:"----"});for(let t=1;t<=d;t++){let e="Fake LLM Simulator "+t;l.push({name:e})}}let i=[];l.forEach(e=>{let t=e.name;i.push({value:t,selected:n===t})});D=new DropDownMenu(i,"<strong>Model</strong>: ",{alignment:"ne",dropDownClass:"",dropDownStyle:{marginLeft:"4px"},menuStyle:{width:"300px",zIndex:1e8},callback:async(e,t)=>{s.innerHTML="",a(s,t)}});s.appendChild(D.create())}(n)),a),e=h.createButton({cls:"btn",text:"Cancel",style:{marginRight:"5px"}});C=h.createButton({cls:"btn btn-primary "+(o||u||c.message.match(y)?"":"disabled"),text:o?"Fork":g?"Save":"Go"}),t.appendChild(e),t.appendChild(C),e.onclick=k,C.onclick=async()=>{var d=f.value.trim();if(!C.classList.contains("disabled"))if(o){var r=d;let e=m.prompt,t=MessageUtils.getMessagesBeforeId(w,m.messages[0],c.id),a=(t.push({role:"assistant",message:r}),MessageUtils.getLastMessage(m.messages[0])).temperature,s=D.getSelected(),n=S.getSelected().toLowerCase(),l="none"===n?null:"child"===n?m.id:m.parent_id,i={type:"regular",model:s,temperature:a,prompt:e,parentId:l,name:b.value.trim()||v,messages:t},o=await newChat(p,i);"swap"===n&&await updateChats(p,[{id:m.id,parentId:o.id,name:`Swapped (msg-id: ${c.id}): `+m.name}]),k(),setTimeout(()=>{setChat(o)},25);void await 0}else if(u){r=d;let e=m.prompt,t=MessageUtils.getMessagesBeforeId(w,m.messages[0],c.id),a=(t.push({role:"assistant",message:c.message}),t.push({role:"user",message:r}),t.push({role:"assistant",message:null}),MessageUtils.getLastMessage(m.messages[0])).temperature,s=D.getSelected(),n=S.getSelected().toLowerCase(),l="none"===n?null:"child"===n?m.id:m.parent_id,i={type:"regular",stream:!0,model:s,temperature:a,prompt:e,parentId:l,name:b.value.trim()||x,messages:t},o=await newChat(p,i);k(),setTimeout(()=>{setChat(o)},25);void await 0}else{if(!g)throw new Error("Unrecognized message action "+l);var e=d,d=(C.innerText="Saving...",c.id);try{await updateChatMessage(p,d,null,e);c.message=e,setTimeout(()=>{i&&i(e),k()},250)}catch(e){C.innerText="Save Error!",console.error(e)}}},f.addEventListener("input",()=>{var e=f.value.trim(),e=!e.match(y)&&(e===c.message||""===e);e&&!C.classList.contains("disabled")?C.classList.add("disabled"):!e&&C.classList.contains("disabled")&&C.classList.remove("disabled")})}}module.exports={MessageModal:MessageModal};
