/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let PatchUtils=require("@gitsense/gsc-utils").PatchUtils,DomUtils=require("../../../utils/DomUtils"),MessageService=require("../../../services/MessageService"),renderMetadataSection=require("./components/MetadataSection").renderMetadataSection,renderErrorSection=require("./components/ErrorSection").renderErrorSection,renderCodeView=require("./components/CodeView").renderCodeView,renderDiffView=require("./components/DiffView/index.js").renderDiffView,renderActionButtons=require("./components/ActionButtons").renderActionButtons,generatePatchedHeaderText=require("./utils/headerGenerator").generatePatchedHeaderText;class ChangePreviewModal{constructor(e){var t;this.message=e.message,this.sourceInfo=e.sourceInfo,this.sourceText=e.sourceInfo.content,this.sourceHeaderText=e.sourceInfo.headerText,this.fullSourceContent=this.sourceHeaderText+`


`+this.sourceText,this.language=e.sourceInfo.language,this.blockUUID=e.sourceInfo.blockUUID||e.blockUUID,this.widget=e.widget,this.codeBlockService=e.codeBlockService,this.hljs=e.hljs,this.onApply=e.onApply,this.mode=e.mode||(e.patchInfo?"patch-preview":"version-comparison"),this.currentView="code",this.diffViewType="side-by-side","patch-preview"===this.mode?(this.patchInfo=e.patchInfo,this.patchText=e.patchInfo.content,this.patchMetadata=PatchUtils.extractPatchMetadata(this.patchText),t=PatchUtils.applyPatch(this.fullSourceContent,this.patchText),this.isValid=t.valid,this.errors=t.errors||[],this.patchedText=t.patchedText||"Patch Failed",(t=this.patchedText.split(/\n\n\n/))[0].includes("Component: ")&&t[0].includes("Block-UUID: ")&&(this.patchedText=t.slice(1).join("\n\n\n")),this.patchedHeaderText=generatePatchedHeaderText(this.sourceHeaderText,this.patchMetadata),this.fromText=this.sourceText,this.toText=this.patchedText,this.fromHeaderText=this.sourceHeaderText,this.toHeaderText=this.patchedHeaderText,this.fromTitleText="Source",this.toTitleText="Patched"):(this.parentInfo=e.parentInfo,this.parentText=e.parentInfo?.content||null,this.parentHeaderText=e.parentInfo?.headerText||null,this.isValid=!0,this.errors=[],this.fromText=this.parentText,this.toText=this.sourceText,this.fromHeaderText=this.parentHeaderText,this.toHeaderText=this.sourceHeaderText,this.fromTitleText="Parent Version",this.toTitleText="Current Version"),this.modal=null,this.modalContent=null,this.viewContainer=null,this.codeView=null,this.diffView=null,this.errorList=null}render(){this.modal=DomUtils.h.createDiv({cls:"gs-modal change-preview-modal",style:{position:"fixed",top:0,left:0,width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.5)",zIndex:1e5,display:"flex",justifyContent:"center",alignItems:"center"}}),this.modalContent=DomUtils.h.createDiv({cls:"gs-modal-content",style:{backgroundColor:"#fff",borderRadius:"5px",padding:"20px",width:"90%",height:"90vh",maxHeight:"90vh",overflow:"auto",boxShadow:"0 2px 10px rgba(0, 0, 0, 0.2)"}}),this.modal.appendChild(this.modalContent),this._renderHeader(),this._renderControls(),this.isValid||(this.errorSection=renderErrorSection(this.errors),this.modalContent.appendChild(this.errorSection)),this._renderViewContainer(),document.body.appendChild(this.modal),this.modal.addEventListener("click",e=>{e.target===this.modal&&this.close()}),document.addEventListener("keydown",this._handleKeyDown)}_renderHeader(){var e=DomUtils.h.createDiv({cls:"gs-modal-header",style:{marginBottom:"15px",borderBottom:"1px solid #eee",paddingBottom:"10px",display:"flex",justifyContent:"space-between",alignItems:"center"}}),t="patch-preview"===this.mode?"Change Preview":"Version Comparison",t=DomUtils.h.createH2({text:t,style:{margin:0,fontSize:"1.5rem"}}),t=(e.appendChild(t),DomUtils.h.createButton({text:"Ã—",style:{background:"none",border:"none",fontSize:"1.5rem",cursor:"pointer"},onclick:()=>this.close()}));e.appendChild(t),this.modalContent.appendChild(e)}_renderControls(){var e=DomUtils.h.createDiv({cls:"change-controls-container",style:{display:"flex",justifyContent:"space-between",marginBottom:"15px"}}),t=DomUtils.h.createDiv({cls:"view-selection-group",style:{display:"flex",alignItems:"center",gap:"15px"}}),i=DomUtils.h.createDiv({style:{display:"flex",alignItems:"center",gap:"5px"}});let o=DomUtils.h.createInput({type:"radio",name:"view-type",id:"code-view-radio",value:"code",checked:"code"===this.currentView});o.addEventListener("change",()=>{o.checked&&this._setView("code")});var r=DomUtils.h.createLabel({text:"Content view",for:"code-view-radio"}),r=(i.appendChild(o),i.appendChild(r),t.appendChild(i),DomUtils.h.createDiv({style:{display:"flex",alignItems:"center",gap:"5px"}}));let s=DomUtils.h.createInput({type:"radio",name:"view-type",id:"diff-view-radio",value:"diff",checked:"diff"===this.currentView});s.addEventListener("change",()=>{s.checked&&this._setView("diff")});i=DomUtils.h.createLabel({text:"Diff view",for:"diff-view-radio"});r.appendChild(s),r.appendChild(i),t.appendChild(r),e.appendChild(t),this.modalContent.appendChild(e)}_renderViewContainer(){this.viewContainer=DomUtils.h.createDiv({cls:"view-container",style:{marginBottom:"20px"}}),this.codeView=renderCodeView({fromTitleText:this.fromTitleText,toTitleText:this.toTitleText,fromHeaderText:this.fromHeaderText,fromText:this.fromText,toHeaderText:this.toHeaderText,toText:this.toText,language:this.language,hljs:this.hljs}),this.codeView.style.display="code"===this.currentView?"block":"none",this.viewContainer.appendChild(this.codeView),this.diffView=renderDiffView({fromTitleText:this.fromTitleText,toTitleText:this.toTitleText,fromText:this.fromHeaderText+"\n\n\n"+this.fromText,toText:this.toHeaderText+"\n\n\n"+this.toText,language:this.language,viewType:this.diffViewType,hljs:this.hljs,onViewTypeChange:e=>this._handleDiffViewTypeChange(e)}),this.diffView.style.display="diff"===this.currentView?"block":"none",this.viewContainer.appendChild(this.diffView),this.modalContent.appendChild(this.viewContainer)}_handleDiffViewTypeChange(e){this.diffViewType=e;e=renderDiffView({fromTitleText:this.fromTitleText,toTitleText:this.toTitleText,fromText:this.fromHeaderText+"\n\n\n"+this.fromText,toText:this.toHeaderText+"\n\n\n"+this.toText,language:this.language,viewType:this.diffViewType,hljs:this.hljs,onViewTypeChange:e=>this._handleDiffViewTypeChange(e)});e.style.display="block",this.viewContainer.replaceChild(e,this.diffView),this.diffView=e}_setView(e){"code"!==e&&"diff"!==e||(this.currentView=e,this.codeView.style.display="code"===this.currentView?"block":"none",this.diffView.style.display="diff"===this.currentView?"block":"none")}close(){document.removeEventListener("keydown",this._handleKeyDown),this.modal&&this.modal.parentNode&&this.modal.parentNode.removeChild(this.modal)}}module.exports={ChangePreviewModal:ChangePreviewModal};
