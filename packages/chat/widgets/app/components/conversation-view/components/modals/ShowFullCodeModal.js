/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let MessageUtils=require("@gitsense/gsc-utils"),{h,svg,DropDownMenu,newChat,setChat}=require("../../Dependencies"),showFullCodeMsg=require("../../constants/MessageConstants").showFullCodeMsg,CodeBlock=require("../CodeBlock");function ShowFullCodeModal(i,p,r,c,g,m=0){let u=null,C=null,x=null,y=null,w=null,o=null,v=!1,f=`Show full code (${p.id})`;function k(){u.parentNode.removeChild(u)}this.render=function(){var{inputBody:t,optionsBody:a,buttonsBody:s}=(()=>{var e=h.createSpan({append:[svg.x()],style:{cursor:"pointer",position:"relative",top:"-10px",right:"-5px"}}),t=h.createDiv({style:{maxHeight:"70vh",overflow:"auto"}}),l=h.createDiv({style:{display:"inline-block",width:"calc(100% - 200px)",textAlign:"left"}}),n=h.createDiv({style:{display:"inline-block",width:"200px",textAlign:"right"}}),o=h.createDiv({cls:"gs-chat-modal-header",append:[h.createH2({text:"Show Full Code"}),e],style:{borderBottom:"0px",padding:"20px 20px 8px 20px"}}),a=h.createDiv({cls:"gs-chat-modal-body",append:[t],style:{padding:"0px 20px"}}),s=h.createDiv({cls:"gs-chat-modal-footer",append:[l,n],style:{borderTop:"0px",padding:"20px"}}),o=h.createDiv({cls:"gs-chat-modal-content",append:[o,a,s],style:{maxWidth:"1024px"}});return u=h.createDiv({cls:"gs-chat-modal",append:[o]}),document.body.appendChild(u),document.addEventListener("mousedown",()=>{v=!1}),document.addEventListener("mousemove",()=>{v=!0}),window.addEventListener("click",e=>{e.target!==u||v||0!==window.getSelection().toString().length||k(),v=!1}),e.onclick=k,{inputBody:t,optionsBody:l,buttonsBody:n}})(),e=t,l=((C=h.createTextArea({style:{display:"none"}})).value=showFullCodeMsg,e.appendChild(C),h.createDiv({cls:"markdown-body",html:`<h3>Code Files in Message</h3>
                   <p>The following code files were detected in the message. Click "Go" to generate complete versions of these files.</p>`,style:{marginBottom:"20px"}})),e=(e.appendChild(l),h.createDiv({style:{display:"inline-block",marginRight:"15px"}})),l=h.createDiv({style:{display:"inline-block",marginRight:"15px"}}),n=h.createDiv({style:{display:"inline-block"}}),a=(a.appendChild(e),a.appendChild(l),a.appendChild(n),e),a=((x=h.createTextInput({style:{width:"300px",padding:"2px 5px"}})).value=f,a.appendChild(h.createSpan({text:"Name: ",style:{fontWeight:500}})),a.appendChild(x),function l(n,t){t=t||"Child";let e=["None","Child","Sibling"];let o=[];e.forEach(e=>{o.push({value:e,selected:t===e})});y=new DropDownMenu(o,"<strong>Relation</strong>: ",{alignment:"ne",dropDownClass:"",dropDownStyle:{marginLeft:"4px"},callback:async(e,t)=>{n.innerHTML="",l(n,t)}});n.appendChild(y.create())}(l),function l(n,o){o=o||c;let e="GitSense Notes";let a=[...g];a.unshift({name:"----"});a.unshift({name:e});if(m){a.push({name:"----"});for(let t=1;t<=m;t++){let e="Fake LLM Simulator "+t;a.push({name:e})}}let s=[];a.forEach(e=>{let t=e.name;s.push({value:t,selected:o===t})});w=new DropDownMenu(s,"<strong>Model</strong>: ",{alignment:"ne",dropDownClass:"",dropDownStyle:{marginLeft:"4px"},menuStyle:{width:"300px",zIndex:1e8},callback:async(e,t)=>{n.innerHTML="",l(n,t)}});n.appendChild(w.create())}(n),s),s=h.createButton({cls:"btn",text:"Cancel",style:{marginRight:"5px"}});o=h.createButton({cls:"btn btn-primary",text:"Go"}),a.appendChild(s),a.appendChild(o),s.onclick=k,o.onclick=async()=>{{let e=r.prompt,t=MessageUtils.getMessagesBeforeId(c,r.messages[0],p.id),l=(t.push({role:"assistant",message:p.message}),t.push({role:"user",message:C.value}),t.push({role:"assistant",message:null}),MessageUtils.getLastMessage(r.messages[0])).temperature,n=w.getSelected(),o=y.getSelected().toLowerCase(),a="none"===o?null:"child"===o?r.id:r.parent_id,s={type:"regular",stream:!0,model:n,temperature:l,prompt:e,parentId:a,name:x.value.trim()||f,messages:t},d=await newChat(i,s);k(),setTimeout(()=>{setChat(d)},25)}};{a=t;let o=CodeBlock.extractCodeBlocks(p.message),e=CodeBlock.extractFilePaths(p.message);if(0===o.length){var d=h.createDiv({cls:"markdown-body",html:"<p>No code blocks were detected in this message.</p>",style:{marginBottom:"20px"}});a.appendChild(d)}else{d=h.createDiv({cls:"markdown-body",style:{marginBottom:"20px"}});let n=document.createElement("ul"),l=new Map;if(0<e.length){let t=0;e.forEach(e=>{t<o.length&&(l.set(e,o[t]),t++)}),e.forEach(e=>{var t=document.createElement("li");t.textContent=e,n.appendChild(t)})}else o.forEach((e,t)=>{var l=document.createElement("li");l.textContent=`Code block ${t+1} (${e.language})`,n.appendChild(l)});d.appendChild(n),a.appendChild(d),0<o.length&&(s=h.createDiv({cls:"markdown-body",html:"<h4>Preview of first code block:</h4>",style:{marginBottom:"10px"}}),a.appendChild(s),s=o[0],s=CodeBlock.createCodeBlock(500<s.code.length?s.code.substring(0,500)+"\n\n// ... (truncated)":s.code,s.language),a.appendChild(s),CodeBlock.hasIncompleteCode(p.message))&&(s=h.createDiv({cls:"markdown-body",html:`<p><strong>Note:</strong> Some code appears to be incomplete or truncated. 
                           Clicking "Go" will ask the AI to generate the complete code.</p>`,style:{marginTop:"15px",padding:"10px",backgroundColor:"#fff8e6",border:"1px solid #ffe0b2",borderRadius:"4px"}}),a.appendChild(s))}}}}module.exports={ShowFullCodeModal:ShowFullCodeModal};
