/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let getMessagesBeforeId=require("@gitsense/gsc-utils").getMessagesBeforeId,{h,svg,n,newChat,COMPARE,EVALUATE,EVALUATE_MODEL,VALIDATE}=require("../../Dependencies"),COMPARE_RESPONSES=require("../../constants/AnalysisConstants.js").COMPARE_RESPONSES,MessageUtils=require("../../utils/MessageUtils");function InsightsModal(o,g,u,y,i,v,f){let x=null;function a(p,s){let d=[],c=[];function m(){var e=d.filter(e=>e.checked).map(e=>e.model),t=c.filter(e=>e.checked).map(e=>e.model)[0];return("evaluate"===p||1<e.length)&&t&&t.length?(s.className=s.className.replace(/ disabled/,""),!0):(s.className.match(/disabled/)||(s.className+=" disabled"),!1)}s.onclick=async()=>{if(m()){let e=g.messages;var s=e[0],l=s.kids[0],i=d.filter(e=>e.checked).map(e=>e.model),n=c.filter(e=>e.checked).map(e=>e.model),r=n.shift();let a="",t=(i.forEach((e,t)=>{var t=t+1,s=v[e][0].message;a+=`
<llm_response_${t} (${e})>
${s}
</llm_response_${t}>
`}),null);if("evaluate"===p&&1===i.length){let e=getMessagesBeforeId(y,g.messages[0],u.id),s=(e.push({role:"assistant",message:u.message}),[]);e.forEach(e=>{var{role:e,message:t}=e;if("system"===e)s.push("<system_prompt>"+t+"</system_prompt>");else if("user"===e)s.push("<user_message>"+t+"</user_message>");else{if("assistant"!==e)throw new Error("Unrecognized role "+e);s.push("<assistant_message>"+t+"</assistant_message>")}}),t=EVALUATE_MODEL.replace(/{{llm}}/,y).replace(/{{messages}}/,s.join("\n"))}else t="compare"===p?COMPARE:EVALUATE,t=(t=null==s.message||""===s.message?t.replace(/{{system}}/,""):(o="system_prompt",t.replace(/{{system}}/,`<${o}>${s.message}</${o}>`))).replace(/{{num-responses}}/,i.length).replace(/{{user}}/,`<user_message>${l.message}</user_message>`).replace(/{{responses}}/,a);var{id:s,prompt:o,group_id:i}=g,l=n.length?{type:COMPARE_RESPONSES,options:{models:n}}:null,n=p.charAt(0).toUpperCase()+p.slice(1)+" "+g.name,n={type:p,name:n,stream:!0,model:r,temperature:0,analysis:l,prompt:o,parentId:s,groupId:i,message:t},r=await newChat(widget,n),{uuid:l,main_model:o}=(x.parentNode.removeChild(x),r);MessageUtils.navigateToChat(l,o)}},this.render=function(e){var{compareModelsBody:e,assistantsBody:t,instructionsBody:s}=(e=>{var t=h.createDiv({style:{display:"inline-block",width:"50%",paddingRight:"20px",verticalAlign:"top"}}),s=h.createDiv({style:{display:"inline-block",width:"50%",paddingLeft:"20px",verticalAlign:"top"}}),a=h.createDiv({style:{marginTop:"20px",textAlign:"Center",fontSize:"14px"}});return e.appendChild(t),e.appendChild(s),e.appendChild(a),{compareModelsBody:t,assistantsBody:s,instructionsBody:a}})(e=e),l=e,e=h.createDiv({append:[h.createSpan({text:"Responses",style:{borderBottom:"1px solid black",padding:"0px 5px 5px 5px"}})],style:{textAlign:"center",marginBottom:"20px",fontWeight:500}}),e=(l.appendChild(e),i.filter(e=>!e.ready)),a=(i.forEach(t=>{let{name:s,ready:a}=t;if(!s.match(/^---/)){let e=h.createCheckbox({style:{verticalAlign:"middle"}});e.model=s,d.push(e),a?e.checked=!0:e.disabled=!0;t=h.createSpan({text:s,style:{marginLeft:"5px",verticalAlign:"middle",textDecoration:a?null:"line-through",cursor:a?"pointer":null}}),t=(t.onclick=()=>{a&&e.click()},h.createDiv({append:[e,t],style:{display:"inline-block",width:"50%",overflow:"hidden",textOverflow:"ellipsis",marginTop:"5px",whiteSpace:"nowrap"}}));l.appendChild(t),e.onclick=()=>{m()}}}),e.length&&(e=e.length,l.appendChild(h.createDiv({html:`Note: ${n.toWords(e)} model${1===e?"":"s"} with no response.`,style:{marginTop:"10px",marginBottom:"10px"}}))),t),e=h.createDiv({append:[h.createSpan({text:"AI Assistant",style:{borderBottom:"1px solid black",padding:"0px 5px 5px 5px"}})],style:{textAlign:"center",marginBottom:"20px",fontWeight:500}});a.appendChild(e),f.forEach(t=>{t=t.name;if(!t.match(/^----/)){let e=h.createCheckbox({style:{verticalAlign:"middle"}});e.model=t,c.push(e);t=h.createSpan({text:t,style:{marginLeft:"5px",verticalAlign:"middle",cursor:"pointer"}}),t=(t.onclick=()=>{e.click()},h.createDiv({title:t,append:[e,t],style:{display:"inline-block",width:"50%",overflow:"hidden",textOverflow:"ellipsis",marginTop:"5px",whiteSpace:"nowrap"}}));a.appendChild(t),e.onclick=()=>{m()}}}),s.innerHTML=`
                Select ${"evaluate"===p?"one":"two"} or more responses and one or more AI assistant. Note, you can more assistants later.
            `}}function l(t){let r=[];function o(){var e=r.filter(e=>e.checked).map(e=>e.model)[0];return e&&e.length?(t.className=t.className.replace(/ disabled/,""),!0):(t.className.match(/disabled/)||(t.className+=" disabled"),!1)}t.onclick=async()=>{if(o()){var t=g.messages,t=t[0],s=t.kids[0],a=v[y][0],l=r.filter(e=>e.checked).map(e=>e.model),i=l.shift();let e=VALIDATE;e=(e=null==t.message||""===t.message?e.replace(/{{system}}/,""):(n="system_prompt",e.replace(/{{system}}/,`<${n}>${t.message}</${n}>
`))).replace(/{{model}}/,`<llm>${y}</llm>
`).replace(/{{user}}/,`<user_message>${s.message}</user_message>
`).replace(/{{assistant}}/,`<assistant_response>${a.message}</assistant_response>
`);var t=0===l.length?null:{type:COMPARE_RESPONSES,options:{summarize:"No",models:l}},n="validate",{id:s,prompt:a,group_id:l}=g,n=await newChat(widget,{type:n,name:n.charAt(0).toUpperCase()+n.slice(1)+": "+g.name,stream:!0,model:i,prompt:a,temperature:0,analysis:t,parentId:s,groupId:l,message:e,validateMessageId:u.id,validateMessageModel:u.model}),{uuid:i,main_model:a}=(x.parentNode.removeChild(x),n);MessageUtils.navigateToChat(i,a)}},this.render=function(e){var{assistantsBody:e,instructionsBody:t}=(e=>{var t=h.createDiv({style:{}}),s=h.createDiv({style:{marginTop:"20px",textAlign:"Center",fontSize:"14px"}});return e.appendChild(t),e.appendChild(s),{assistantsBody:t,instructionsBody:s}})(e=e),s=e,e=h.createDiv({append:[h.createSpan({text:"AI Assistant",style:{borderBottom:"1px solid black",padding:"0px 5px 5px 5px"}})],style:{textAlign:"center",marginBottom:"20px",fontWeight:500}});s.appendChild(e),f.forEach(t=>{t=t.name;if(!t.match(/^---/)){let e=h.createCheckbox({style:{verticalAlign:"middle"}});e.model=t,r.push(e);t=h.createSpan({text:t,style:{marginLeft:"5px",verticalAlign:"middle",cursor:"pointer"}}),t=(t.onclick=()=>{e.click()},h.createDiv({append:[e,t],style:{display:"inline-block",width:"25%",overflow:"hidden",textOverflow:"ellipsis",marginTop:"5px"}}));s.appendChild(t),e.onclick=()=>{o()}}}),t.innerHTML=`
                Select one or more AI assistant. Note, you can more assistants later.
            `}}this.render=function(){{let{modalBody:e,goBtn:t}=(()=>{let e=h.createSpan({append:[svg.x()],style:{cursor:"pointer"}}),t=h.createButton({cls:"btn",text:"Cancel",style:{marginRight:"5px"}}),s=h.createButton({cls:"btn btn-primary disabled",text:o.charAt(0).toUpperCase()+o.slice(1)}),a=null;if("compare"===o)a="Compare Responses";else if("evaluate"===o)a="Evaluate Responses";else{if("validate"!==o)throw new Error("Unrecognized type "+o);a=`Validate ${y} Responses`}var l=h.createDiv({cls:"gs-chat-modal-header",append:[h.createH2({text:a}),e]}),i=h.createDiv({cls:"gs-chat-modal-body"}),n=h.createDiv({cls:"gs-chat-modal-footer",append:[t,s]}),l=h.createDiv({cls:"gs-chat-modal-content",append:[l,i,n]});return x=h.createDiv({cls:"gs-chat-modal",append:[l]}),document.body.appendChild(x),window.addEventListener("click",e=>{e.target===x&&r()}),t.onclick=r,e.onclick=r,{goBtn:s,modalBody:i};function r(){x.parentNode.removeChild(x)}})(),s=null;if("compare"===o||"evaluate"===o)s=new a(o,t);else{if("validate"!==o)throw new Error("Unrecognized type "+o);s=new l(t)}s.render(e)}}}module.exports=InsightsModal;
