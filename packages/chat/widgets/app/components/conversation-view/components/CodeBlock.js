/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let{CodeBlockUtils,PatchUtils,ContextUtils,ChatUtils,MessageUtils}=require("@gitsense/gsc-utils"),DomUtils=require("../utils/DomUtils"),CodeFoldingService=require("../services/CodeFoldingService"),MessageService=require("../services/MessageService"),ChangePreviewModal=require("./modals/ChangePreviewModal");function addClipboards(e,t=5){return DomUtils.addClipboards(e,t)}function addCodeBlockControls(e,x,k,B,U,b){if(!e||!k)return console.warn("CodeBlock: Cannot add code block controls - missing container or message"),{cleanup:()=>{}};if(!e.addedPreviewChangesControl){let v=DomUtils.h;var t=Array.from(e.querySelectorAll("pre")||[]);let y=[];return t.forEach((h,g)=>{var u=h.querySelector("code");if(u){let o=u.textContent||"",t=null,e="",a=null;let r=null,l=null,i=null,s=null,c=null,n=null,p=!!o.match(/^diff\n\n*# Patch Metadata\n/),m=!p;if(p?(["Source","Target"].forEach(e=>{var t=new RegExp(e+"-Block-UUID:\\s*([a-z0-9-]+)"),t=o.match(t);t&&t[1]&&("Source"===e?i=t[1]:s=t[1])}),i&&s&&((a=U.getBlockInfo(i))&&(r=U.getBlockInfo(i,s))&&(t="patch-preview",e="Preview Changes"),U.getBlockInfo(s))):((u=o.match(/ Block-UUID: ([a-z0-9-]+)\s/))&&u[1]&&(c=u[1]),(u=o.match(/ Parent-UUID: ([a-z0-9-]+)\s/))&&u[1]&&"N/A"!==u[1]&&(n=u[1]),c&&n&&(a=U.getBlockInfo(c),l=U.getBlockInfo(n),a)&&l&&(t="version-comparison",e="Compare Versions")),c||i||s){var u=v.createDiv({cls:"patch-controls",style:{display:"flex",alignItems:"center",marginBottom:"5px",fontSize:"0.9em"}}),C=v.createLink({cls:t?"patch-preview"===t?"preview-changes":"compare-versions":"",text:e,href:"#",style:t?{marginRight:"15px",textDecoration:"none"}:{color:"gray",pointerEvents:"none"}}),f=(u.appendChild(C),C.onclick=async e=>{e.preventDefault();try{ChangePreviewModal.launch(k,a,r,l,B,U,b)}catch(e){console.error(`Error in ${t} actionType:`,e),alert("Error: "+(e.message||"Failed to open comparison modal"))}},v.createSpan({cls:"patch-status",style:{display:"none"}}));u.appendChild(f),h.parentNode.insertBefore(u,h),y.push({container:u,actionButton:C,status:f}),"patch-preview"===t&&i&&updatePatchStatus(k,i,f);let d=v.createLink({html:(p,"Delete if Redundant"),href:"#",style:{marginRight:"15px",textDecoration:"none"}}),n=(d.onclick=async o=>{o.preventDefault();var n=ChatUtils.getChatMessages(x);let a=null;for(let e=0;e<n.length;e++){var t=n[e];if(MessageUtils.isContextMessage(t.message)){var r=ContextUtils.extractContextSections(t.message);for(let t=0;t<r.length;t++){var l=r[t];let e=l.block?.header?.["Block-UUID"]||"";if(p&&s===e||m&&c===e){a=l;break}}if(a)break}}if(a){let e=a.block?.header?.["Block-UUID"]||"";o=`${a.path} (chat-id: ${a["chat id"]})`;let t=p?`Patch applied and deleted. Please refer to ${o}) to view the patched code`:`Code deleted. Please refer to ${o} to view the code`;try{t=CodeBlockUtils.updateCodeBlockByUUID(k.message,e,t,"txt")}catch(e){return d.origText=d.innerText,d.innerText=e,d.style.color="red",void(d.pointerEvents="none")}var o=n.map(e=>e.id!==k.id?{role:e.role,message:e.message}:{role:e.role,message:t}),i=n.find(e=>"assistant"===e.role),i=i?i.temperature:0,i={name:x.name,parentId:x.parent_id,groupId:x.group_id,prompt:x.prompt,model:x.main_model,temperature:i,messages:o},o=await MessageService.newChat(B,i),i=[{id:x.id,parentId:o.id,name:`Before Delete ${p?"Patch Block":"Code Block"} (msg-id: ${k.id}): `+x.name}],i=await MessageService.updateChats(B,i);i.success||console.error(i.error),MessageService.setChat(o)}else d.origText=d.innerText,d.innerHTML=p?`<code>${s.substring(0,8)}</code> is not in context.`:`<code>${c.substring(0,8)}</code> is not in context.`,d.pointerEvents="none",d.style.color="black",setTimeout(()=>{d.innerText=d.origText,d.pointerEvents=null,d.style.color=null},2e3)},v.createLink({text:"Force Delete",href:"#",style:{marginRight:"15px",textDecoration:"none"}}));n.onclick=async e=>{e.preventDefault();e=ChatUtils.getChatMessages(x);let t=`Code block deleted. Please refer to chat ${x.uuid}> to view deleted content.`;try{t=CodeBlockUtils.updateCodeBlockByIndex(k.message,g,t,"txt")}catch(e){return n.origText=n.innerText,n.innerText=e,n.style.color="red",void(n.pointerEvents="none")}var o=e.map(e=>e.id!==k.id?{role:e.role,message:e.message}:{role:e.role,message:t}),e=e.find(e=>"assistant"===e.role),e=e?e.temperature:0,e={name:x.name,parentId:x.parent_id,groupId:x.group_id,prompt:x.prompt,model:x.main_model,temperature:e,messages:o},o=await MessageService.newChat(B,e),e=[{id:x.id,parentId:o.id,name:`Before Force Delete (msg-id: ${k.id}): `+x.name}],e=await MessageService.updateChats(B,e);e.success||console.error(e.error),MessageService.setChat(o)},u.appendChild(d),u.appendChild(n)}}}),e.addedPreviewChangesControl=!0,{cleanup:()=>{y.forEach(e=>{e.container&&e.container.parentNode&&e.container.parentNode.removeChild(e.container)})}}}}function updatePatchStatus(o,n,e){if(o&&n&&e&&o.meta&&o.meta.patches){let t=o.meta.patches.filter(e=>e.targetBlockUUID===n||e.sourceBlockUUID===n);var a,r;0===t.length?e.style.display="none":(r=t[t.length-1].appliedAt,a=PatchUtils.formatTimestamp(r),e.innerHTML=`
        Applied at <time datetime="${r}">${a}</time> |
        <a href="#" class="view-original">View Original</a>
    `,e.style.display="inline",(r=e.querySelector(".view-original"))&&r.addEventListener("click",e=>{e.preventDefault(),showOriginalCode(o,n,t)}))}}function showOriginalCode(e,t,o){if(!o||0===o.length)return void alert("No patch history available for this code block.");o=o[0];let n=document.createElement("div");n.className="original-code-modal",n.style.position="fixed",n.style.top="50%",n.style.left="50%",n.style.transform="translate(-50%, -50%)",n.style.backgroundColor="white",n.style.padding="20px",n.style.borderRadius="5px",n.style.boxShadow="0 0 10px rgba(0,0,0,0.3)",n.style.zIndex="1000",n.style.maxWidth="80%",n.style.maxHeight="80%",n.style.overflow="auto";var a=document.createElement("h3"),a=(a.textContent="Original Code",n.appendChild(a),document.createElement("p")),a=(a.textContent="Applied on: "+PatchUtils.formatTimestamp(o.appliedAt),n.appendChild(a),document.createElement("pre")),r=(a.style.backgroundColor="#f6f8fa",a.style.padding="10px",a.style.borderRadius="3px",a.style.overflow="auto",document.createElement("code")),o=(r.textContent=o.sourceContent||"Original content not available",a.appendChild(r),n.appendChild(a),document.createElement("button"));o.textContent="Close",o.style.marginTop="15px",o.style.padding="5px 10px",o.onclick=()=>{document.body.removeChild(n),document.body.removeChild(l)},n.appendChild(o);let l=document.createElement("div");l.style.position="fixed",l.style.top="0",l.style.left="0",l.style.width="100%",l.style.height="100%",l.style.backgroundColor="rgba(0,0,0,0.5)",l.style.zIndex="999",l.onclick=()=>{document.body.removeChild(n),document.body.removeChild(l)},document.body.appendChild(l),document.body.appendChild(n)}function addPreFoldLinks(e,r,t,o){e&&r&&t?((e=Array.from(e.querySelectorAll("pre")||[])).forEach((e,t)=>{var o=e.childNodes[0]?.firstChild,n=e.textContent||e.innerText;let a=null;o&&"gs-chat-lang"===o.className&&(a=n.split("\n")[0]),e.style.marginBottom="5px",e.id="msg-pre-"+r.id+"-"+t,e.lang=a}),CodeFoldingService.foldOrUnfoldPre(e,t,o)):console.warn("CodeBlock: Cannot add fold links - missing required parameters")}function createCodeBlock(t,o,e=!0,n){var a=document.createElement("pre"),r=(a.className="hljs",a.style.backgroundColor="#fafafa",a.style.border="1px solid #ddd",a.style.marginTop="5px",a.style.overflow="auto",a.style.maxHeight="500px",document.createElement("code"));if(o&&e&&n){e=document.createElement("span");e.className="gs-chat-lang",e.textContent=o,r.appendChild(e),r.appendChild(document.createTextNode("\n\n"));try{var l=n.highlight(t,{language:o,ignoreIllegals:!0}).value,i=document.createElement("div");for(i.innerHTML=l;i.firstChild;)r.appendChild(i.firstChild)}catch(e){console.error(`Failed to highlight ${o} code:`,e),r.textContent+=t}}else r.textContent=t;return a.appendChild(r),a}function renderFileSection(e,t,o,n){var a=document.createElement("div"),r=document.createElement("h4"),r=(r.textContent="File: "+e,a.appendChild(r),n&&((e=document.createElement("p")).textContent="Block-UUID: "+n,e.style.fontSize="0.9em",e.style.color="#666",a.appendChild(e)),createCodeBlock(t,o));return a.appendChild(r),a}module.exports={addClipboards:addClipboards,addCodeBlockControls:addCodeBlockControls,addPreFoldLinks:addPreFoldLinks,createCodeBlock:createCodeBlock,renderFileSection:renderFileSection};
