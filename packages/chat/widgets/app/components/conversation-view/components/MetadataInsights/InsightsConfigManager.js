/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let{ChatUtils,GSToolBlockUtils}=require("@gitsense/gsc-utils"),MessageService=require("../../services/MessageService"),DomUtils=require("../../utils/DomUtils"),AnalyzerSelector=require("./AnalyzerSelector"),MetadataFieldsControl=require("./MetadataFieldsControl"),SelectedContext=require("./SelectedContext"),h=DomUtils.h,svg=DomUtils.svg;class ContextLoaderInsightsManager{constructor(e,t,n,i={}){this.parentElem=e,this.context=t,this.initialConfig=n||{},this.options={onSave:null,onClear:null,onCancel:null,showOptions:!0,...i},this._currentItems=this.initialConfig.items||[],this._currentAnalyzer=this.initialConfig.analyzer||null,this._currentSelectedMetadataFields=this.initialConfig.selectedMetadataFields||[],this._currentContextBuilderNodes=this._currentItems.map(e=>e.id),this._activeComponentInstance=null,this._selectedContextInstance=null,this._currentAnalyzer&&"object"!=typeof this._currentAnalyzer&&(this._currentAnalyzer=null,console.error(`Invalid analyzer. Expecting an object but received a ${typeof this._currentAnalyzer} instead`)),this.contextSection=null,this.analyzerSection=null,this.metadataSection=null,this.optionsSection=null,this.changeAnalyzerLink=null,this.saveButton=null,this.clearButton=null,this._renderUI(),this._handleAddContext=this._handleAddContext.bind(this),this._handleAnalyzerSelected=this._handleAnalyzerSelected.bind(this),this._handleMetadataSelectionChange=this._handleMetadataSelectionChange.bind(this),this._handleChangeAnalyzerTrigger=this._handleChangeAnalyzerTrigger.bind(this)}updateSelectedItems(e){this._currentItems=e,this._currentContextBuilderNodes=e.map(e=>e.id),this._renderUI()}getCurrentAnalyzer(){return this._currentAnalyzer}getCurrentSelectedMetadataFields(){return this._currentSelectedMetadataFields}_renderUI(){this.parentElem.innerHTML="",this.contextSection=h.createDiv({id:"insights-context-section",style:{marginBottom:"20px"}}),this.analyzerSection=h.createDiv({id:"insights-analyzer-section",style:{marginTop:"20px"}}),this.metadataSection=h.createDiv({id:"insights-metadata-section",style:{marginTop:"30px"}}),this.optionsSection=h.createDiv({id:"insights-options-section",style:{marginTop:"30px",marginBottom:"10px",display:this.options.showOptions?null:"none"}}),this.parentElem.appendChild(this.contextSection),this.parentElem.appendChild(this.analyzerSection),this.parentElem.appendChild(this.metadataSection),this.parentElem.appendChild(this.optionsSection),this._selectedContextInstance=new SelectedContext(this.contextSection,this.context,this._currentItems),this.analyzerSection.innerHTML="",this.analyzerSection.appendChild(h.createH2({text:"Analyzer",style:{color:"#555"}})),this._currentAnalyzer?(this.analyzerSection.appendChild(h.createH3({text:this._currentAnalyzer.name,style:{marginBottom:"10px"}})),this.analyzerSection.appendChild(h.createParagraph({html:this._currentAnalyzer.description,style:{marginBottom:"10px"}})),this.changeAnalyzerLink=h.createLink({id:"change-metadata-insights-analyzer",text:"Change analyzer",href:"#"}),this.analyzerSection.appendChild(this.changeAnalyzerLink),this.changeAnalyzerLink.addEventListener("click",e=>this._handleChangeAnalyzerTrigger(e))):this._activeComponentInstance=new AnalyzerSelector(this.analyzerSection,this.context,e=>{this._handleAnalyzerSelected(e)}),this.metadataSection.innerHTML="",this.metadataSection.appendChild(h.createH2({text:"Metadata",style:{color:"#555"}})),this._currentAnalyzer?this._activeComponentInstance=new MetadataFieldsControl(this.metadataSection,this.context,this._currentAnalyzer.id,this._currentContextBuilderNodes,{selectedMetadataFields:this._currentSelectedMetadataFields,isEditable:!0,onAddContext:this._handleAddContext,onMetadataSelectionChange:this._handleMetadataSelectionChange,onChangeAnalyzerTrigger:this._handleChangeAnalyzerTrigger,showSaveButton:!1,showClearButton:!1,isContextLoaderMode:!0,reviewButtonType:"outline"}):(this.metadataSection.appendChild(h.createParagraph({text:"Select an analyzer above to view and choose its metadata fields.",style:{padding:"2px 0px"}})),this._activeComponentInstance instanceof MetadataFieldsControl&&(this._activeComponentInstance.cleanup(),this._activeComponentInstance=null)),this.optionsSection.innerHTML="",this.optionsSection.appendChild(h.createH2({text:"Options",style:{color:"#555"}})),this.optionsSection.appendChild(h.createParagraph({text:"You can save the current selection of items, analyzer, and metadata fields for future use, or clear all current selections.",style:{marginBottom:"15px"}}));var e=h.createDiv({style:{display:"flex",gap:"10px"}});this.saveButton=h.createButton({text:"Save",cls:"btn btn-primary"}),this.clearButton=h.createButton({text:"Clear",cls:"btn btn-secondary"}),e.appendChild(this.saveButton),e.appendChild(this.clearButton),this.optionsSection.appendChild(e),this.saveButton.addEventListener("click",this._handleSaveClick.bind(this)),this.clearButton.addEventListener("click",this._handleClearClick.bind(this))}async _handleAddContext(e,t){var{chat:n,widget:i}=this.context,a=ChatUtils.getChatMessages(this.context.chat),s=a[a.length-1],{temperature:a=0}=a.filter(e=>"assistant"===e.role).pop(),t={tool:"context-loader",config:{chatIds:t.map(e=>e.id),showActions:!0,actions:{load:{type:"link",text:"Review",showAdd:"false"},copy:{type:"link"}}}},t="```txt\n"+GSToolBlockUtils.formatToolBlock(t)+"\n```",s={type:"context",parentId:s.id,model:n.main_model,role:"assistant",temperature:a,stream:!1,message:e+"\n\n"+t};await MessageService.newChatMessage(i,n.id,s),this.context.updateChat()}_handleAnalyzerSelected(e){this._currentAnalyzer=e,this._currentSelectedMetadataFields=[],this.options.onConfigChange&&this.options.onConfigChange(this._currentAnalyzer,this._currentSelectedMetadataFields),this._renderUI()}_handleMetadataSelectionChange(e){this._currentSelectedMetadataFields=e,this.options.onConfigChange&&this.options.onConfigChange(this._currentAnalyzer,this._currentSelectedMetadataFields)}_handleChangeAnalyzerTrigger(e){e&&e.preventDefault(),this._currentAnalyzer=null,this._currentSelectedMetadataFields=[],this.options.onConfigChange&&this.options.onConfigChange(null,[]),this._renderUI()}_handleSaveClick(){this.options.onSave&&this.options.onSave(this._currentItems,this._currentAnalyzer,this._currentSelectedMetadataFields)}_handleClearClick(){this.options.onClear&&this.options.onClear()}cleanup(){this._activeComponentInstance&&this._activeComponentInstance.cleanup(),this._selectedContextInstance&&this._selectedContextInstance.cleanup(),this.changeAnalyzerLink&&this.changeAnalyzerLink.removeEventListener("click",e=>this._handleChangeAnalyzerTrigger(e)),this.saveButton&&this.saveButton.removeEventListener("click",this._handleSaveClick),this.clearButton&&this.clearButton.removeEventListener("click",this._handleClearClick),this.parentElem.innerHTML="",console.log("Cleaned up ContextLoaderInsightsManager.")}}module.exports=ContextLoaderInsightsManager;
