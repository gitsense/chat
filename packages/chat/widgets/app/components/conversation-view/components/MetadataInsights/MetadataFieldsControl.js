/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let DomUtils=require("../../utils/DomUtils"),MetadataFieldsTable=require("./MetadataFieldsTable"),getAnalyzerSchema=require("../../Dependencies").getAnalyzerSchema,h=DomUtils.h;class MetadataFieldsControl{constructor(e,t,i,a,s={}){this.parentElem=e,this.context=t,this.analyzerId=i,this.contextBuilderNodes=a,this.options={selectedMetadataFields:[],isEditable:!1,onMetadataSelectionChange:()=>{},onAddContext:()=>{},onSaveTrigger:()=>{},onClearTrigger:()=>{},showSaveButton:!1,showClearButton:!1,isContextLoaderMode:!1,reviewButtonType:"outline",...s},this.isEditable=this.options.isEditable,this.showSaveButton=this.options.showSaveButton,this.showClearButton=this.options.showClearButton,this.isContextLoaderMode=this.options.isContextLoaderMode,this.insightsContainer=null,this.reviewSelectedMetadataButton=null,this.saveButton=null,this.selectedMetadataDisplay=null,this.insightsTable=null,this.analyzerSchema=null,this._renderInitialUI(),this._attachEventListeners(),this._handleReviewItemsClick=this._handleReviewItemsClick.bind(this),this._handleReviewSelectedMetadataClick=this._handleReviewSelectedMetadataClick.bind(this),this._handleSaveClick=this._handleSaveClick.bind(this),this._handleClearClick=this._handleClearClick.bind(this),this._updateSelectedMetadataDisplay=this._updateSelectedMetadataDisplay.bind(this),this._updateButtonStates=this._updateButtonStates.bind(this),this.onMetadataSelectionChange=this.options.onMetadataSelectionChange,this.onSaveTrigger=this.options.onSaveTrigger,this.onClearTrigger=this.options.onClearTrigger,this.selectedMetadataFields=this.options.selectedMetadataFields,this.isContextLoaderMode?(this._currentSelectedFields=new Set(this.selectedMetadataFields),this._loadAnalyzerSchemaAndRenderTable()):this.allGroupDetails=null}_renderInitialUI(){var e=h.createDiv({id:"insights-buttons-row",style:{display:"flex",gap:"10px",marginTop:"15px"},append:[]}),t=(e.append(this.reviewSelectedMetadataButton=h.createButton({id:"review-selected-metadata-button",cls:"btn btn-"+this.options.reviewButtonType,text:"Review Selected Items & Metadata",disabled:!0})),this.selectedMetadataDisplay=h.createDiv({id:"selected-metadata-fields-display",style:{marginBottom:"15px"}}),h.createDiv({}));this.insightsContainer=h.createDiv({id:"analyze-batch-job-insights-container",style:{display:"flex",flexDirection:"column",gap:"0px",paddingTop:"15px"},append:[t,e]}),this.parentElem.appendChild(this.insightsContainer),this.insightsTable=new MetadataFieldsTable(t,this.context,this.analyzerId,()=>{this._updateButtonStates(),this._updateSelectedMetadataDisplay()},this.selectedMetadataFields,!this.isEditable&&this.isContextLoaderMode),this.reviewSelectedMetadataButton=this.insightsContainer.querySelector("#review-selected-metadata-button"),this.saveButton=this.insightsContainer.querySelector("#save-insights-button"),this.clearButton=this.insightsContainer.querySelector("#clear-insights-button")}_attachEventListeners(){this.reviewSelectedMetadataButton.addEventListener("click",e=>this._handleReviewSelectedMetadataClick(e)),this.isContextLoaderMode&&this.isEditable&&this.saveButton&&this.saveButton.addEventListener("click",e=>this._handleSaveClick(e))}async update(t){if(this.isContextLoaderMode)console.warn("MetadataFieldsControl.update() called in Context Loader mode. This method is not intended for this mode.");else if(!this.allGroupDetails){if(this.allGroupDetails=t,!this.analyzerSchema)try{this.analyzerSchema=await getAnalyzerSchema(this.context.widget,this.analyzerId),console.log("analyzerSchema: "+this.analyzerSchema),this.insightsTable.render(this.analyzerSchema)}catch(e){console.error(`Error fetching analyzer schema for ${this.analyzerId}:`,e);t=h.createTableRow({append:[h.createTableCell({text:"Error loading schema: "+e.message,colSpan:3,style:{textAlign:"center",padding:"10px",color:"red"}})]});this.insightsTable.insightsTableBody.appendChild(t)}this._updateButtonStates()}}async _loadAnalyzerSchemaAndRenderTable(){try{this.analyzerSchema=await getAnalyzerSchema(this.context.widget,this.analyzerId),this.insightsTable.render(this.analyzerSchema,this.selectedMetadataFields,!this.isEditable),this._updateButtonStates()}catch(e){console.error(`Error fetching analyzer schema for ${this.analyzerId}:`,e);var t=h.createTableRow({append:[h.createTableCell({text:"Error loading schema: "+e.message,colSpan:3,style:{textAlign:"center",padding:"10px",color:"red"}})]});this.insightsTable.insightsTableBody.appendChild(t)}}_updateButtonStates(){var e=0<this.insightsTable.getSelectedMetadataFields().length;let t=!1;this.isContextLoaderMode?(t=this.contextBuilderNodes&&0<this.contextBuilderNodes.length,this.isEditable&&(this._currentSelectedFields=new Set(this.insightsTable.getSelectedMetadataFields()),this.onMetadataSelectionChange(Array.from(this._currentSelectedFields)))):t=this.allGroupDetails&&0<this.allGroupDetails.length,this.reviewSelectedMetadataButton.disabled=!t||!e,this.isContextLoaderMode&&this.isEditable&&this.saveButton&&(this.saveButton.disabled=!e),this.isContextLoaderMode&&this.showClearButton&&this.clearButton&&(this.clearButton.disabled=!1)}_updateSelectedMetadataDisplay(){this.selectedMetadataDisplay&&this.insightsTable.getSelectedMetadataFields()}_handleReviewItemsClick(){this.context.showContextBuilder(this.contextBuilderNodes,"file content","imported","review")}_handleReviewSelectedMetadataClick(){var e=this.isContextLoaderMode?Array.from(this._currentSelectedFields):this.insightsTable.getSelectedMetadataFields();0<e.length?this.context.showContextBuilder(this.contextBuilderNodes,"file content","imported","review",{initialAnalyzerId:this.analyzerId,initialInsightsFields:e,onclickAdd:(e,t)=>{this.options.onAddContext&&"function"==typeof this.options.onAddContext?this.options.onAddContext(e,t):console.warn("MetadataFieldsControl: No add context handler defined. Ignoring on click add event")}}):console.warn("No metadata fields selected for insights.")}_handleSaveClick(){this.onSaveTrigger&&this.onSaveTrigger(this.analyzerId,Array.from(this._currentSelectedFields))}_handleClearClick(){this.onClearTrigger&&this.onClearTrigger()}cleanup(){this.reviewSelectedMetadataButton.removeEventListener("click",this._handleReviewSelectedMetadataClick),this.saveButton&&this.saveButton.removeEventListener("click",this._handleSaveClick),this.clearButton&&this.clearButton.removeEventListener("click",this._handleClearClick),this.insightsTable&&this.insightsTable.cleanup(),this.insightsContainer&&this.insightsContainer.parentElement&&this.insightsContainer.remove(),this.selectedMetadataDisplay&&this.selectedMetadataDisplay.remove(),console.log("Cleaned up MetadataFieldsControl.")}}module.exports=MetadataFieldsControl;
