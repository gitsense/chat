/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let h=require("../../../Dependencies").h;function MessagePositionIndicator(n={}){let{containerSelector:e=".gs-chat-assistant-message, .gs-chat-user-message",updateInterval:t=100,visibilityThreshold:o=.5,indicatorClass:l="gs-message-position-indicator",labelText:i="Messages",minWidth:s=40}=n,r=null,a=null,c=[],d=0,p=0,u=!1,y=null,g=null,x=new Map,m=null,f=!0;function b(){var e,t,n;a&&(e=a.querySelector("div:nth-child(2)"))&&(e.innerHTML="",t=h.createSpan({append:[h.createSpan({text:p,style:{borderBottom:"1px solid black",paddingBottom:"3px"}})],style:{display:"inline-block",minWidth:"20px"}}),n=h.createSpan({text:d,style:{display:"inline-block",minWidth:"20px"}}),e.appendChild(t),e.appendChild(n),a.setAttribute("aria-label",`Message ${p} of `+d))}function v(){y&&y.disconnect(),y=new IntersectionObserver(e=>{e.forEach(e=>{var t=e.target,n=parseInt(t.dataset.messageIndex||"0",10);e.isIntersecting&&e.intersectionRatio>=o?x.set(n,{element:t,ratio:e.intersectionRatio,timestamp:Date.now()}):x.delete(n)}),g=g||setTimeout(()=>{if(0!==x.size){let o=1/0,l=0;x.forEach((e,t)=>{var{element:e,ratio:n}=e,e=e.getBoundingClientRect();(n>l||n===l&&e.top<o)&&(l=n,o=e.top,p=t)}),b()}g=null},t)},{threshold:[o],rootMargin:"0px"}),c.forEach(e=>{y.observe(e)})}function S(){c=Array.from(document.querySelectorAll(e)),d=c.length,c.forEach((e,t)=>{e.dataset.messageIndex=(t+1).toString()})}function C(){m&&m.disconnect(),m=new ResizeObserver(((t,n)=>{let o;return function(...e){clearTimeout(o),o=setTimeout(()=>t.apply(this,e),n)}})(()=>{Array.from(document.querySelectorAll(e)).length!==d&&(S(),v(),b())},200)),r&&m.observe(r)}function w(){a&&(a.style.display="flex",f=!0)}function M(){a&&(a.style.display="none",f=!1)}return{initialize:function(e){return r=e,a=(()=>{let e=document.createElement("div");e.className=l,e.setAttribute("aria-live","polite"),e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center",e.style.justifyContent="center",e.style.padding="4px 4px",e.style.backgroundColor="white",e.style.border="1px solid #ddd",e.style.borderRadius="4px",e.style.fontSize="12px",e.style.lineHeight="1.2",e.style.color="#333",e.style.transition="all 0.2s ease",e.style.userSelect="none",e.style.cursor="pointer",e.style.width=s+"px",e.style.lineHeight=1.8,e.style.marginTop="5px",e.style.marginBottom="5px",e.addEventListener("mouseover",()=>{e.style.backgroundColor="#f0f0f0",e.style.boxShadow="0 2px 4px rgba(0,0,0,0.1)"}),e.addEventListener("mouseout",()=>{e.style.backgroundColor="white",e.style.boxShadow="none"}),e.setAttribute("title","View & Copy Messages");var t=document.createElement("div"),n=("string"==typeof i&&(t.textContent=i,t.style.fontWeight="bold",t.style.fontSize="10px"),document.createElement("div"));return n.textContent="",n.style.textAlign="center",n.style.fontSize="12px",e.appendChild(t),e.appendChild(n),e})(),S(),v(),C(),b(),a.addEventListener("click",e=>{e.altKey?0<p&&p<=c.length&&(e=c[p-1])&&e.scrollIntoView({behavior:"smooth",block:"center"}):"function"==typeof n.onOpenMessageToolsModal&&n.onOpenMessageToolsModal(c)}),a},updateDockingState:function(e){a&&((u=e)?(w(),a.style.fontSize="10px",a.style.padding="4px 4px 2px 4px",a.style.boxShadow="0 1px 3px rgba(0,0,0,0.1)"):M())},update:function(e={}){var t;Object.assign(n,e),e.labelText&&a&&(t=a.querySelector("div:first-child"))&&(t.textContent=e.labelText),e.containerSelector&&(S(),v(),b())},refresh:function(){y&&y.disconnect(),S(),v(),b()},show:w,hide:M,cleanup:function(){y&&(y.disconnect(),y=null),m&&(m.disconnect(),m=null),g&&(clearTimeout(g),g=null),a&&a.parentNode&&a.parentNode.removeChild(a),c=[],x.clear()}}}module.exports=MessagePositionIndicator;
