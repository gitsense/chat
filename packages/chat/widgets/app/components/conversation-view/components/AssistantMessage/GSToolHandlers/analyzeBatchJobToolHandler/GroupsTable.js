/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let DomUtils=require("../../../../utils/DomUtils"),JobUtils=require("./JobUtils"),MessageService=require("../../../../services/MessageService"),{getAnalyzeChatMessagesForBatchGroup,resetBatchGroup,updateBatchGroupAnalyzeChatUuid,NotificationManager,ConfirmationBox,svg}=require("../../../../Dependencies"),h=DomUtils.h;class GroupsTable{constructor(e,t,a,i){this.parentElem=e,this.batchJobId=t,this.context=a,this.currentPage=1,this.rowsPerPage=10,this.filteredGroups=[],this.allGroupDetails=[],this.activeFilters={},this.lastPolledAt=null,this.tableContainer=null,this.groupsTableBody=null,this.paginationControls=null,this.prevPageButton=null,this.nextPageButton=null,this.pageInfoSpan=null,this.rowsPerPageSelect=null,this.onGroupReset=i.onGroupReset,this.showResetColumn=i.showResetColumn,this._renderInitialTableStructure(),this._attachEventListeners(),this.confirmationBox=new ConfirmationBox,this._handleCreateChatClick=this._handleCreateChatClick.bind(this),this._handlePaginationChange=this._handlePaginationChange.bind(this)}_renderInitialTableStructure(){this.tableContainer=h.createDiv({id:"groups-table-container",style:{display:"flex",flexDirection:"column",gap:"15px",marginTop:"0px"},append:[h.createTable({id:"groups-table",style:{width:"100%",borderCollapse:"collapse",marginTop:"0px",whiteSpace:"nowrap",marginBottom:"0px"},append:[h.createTableHead({append:[h.createTableRow({append:[h.createTableHeadCell({text:"#",style:{padding:"8px",border:"1px solid #ddd",textAlign:"left"}}),h.createTableHeadCell({text:"Status",style:{padding:"8px",border:"1px solid #ddd",textAlign:"left",width:"100%"}}),h.createTableHeadCell({text:"Items",style:{padding:"8px",border:"1px solid #ddd",textAlign:"left"}}),h.createTableHeadCell({text:"Tokens",style:{padding:"8px",border:"1px solid #ddd",textAlign:"right"}}),h.createTableHeadCell({text:"Progress",style:{padding:"8px",border:"1px solid #ddd",textAlign:"left",minWidth:"150px"}}),h.createTableHeadCell({text:"Review",style:{padding:"8px",border:"1px solid #ddd",textAlign:"left",minWidth:"100px"}}),...this.showResetColumn?[h.createTableHeadCell({text:"",style:{padding:"8px",border:"1px solid #ddd",textAlign:"center",width:"35px",minWidth:"35px"}})]:[]]})]}),this.groupsTableBody=h.createTableBody()]}),this.paginationControls=h.createDiv({id:"pagination-controls",style:{display:"flex",justifyContent:"center",alignItems:"center",gap:"10px"},append:[this.prevPageButton=h.createLink({id:"prev-page-button",href:"#",cls:"",text:"Previous",disabled:!0}),this.pageInfoSpan=h.createSpan({id:"page-info",text:"Page 1 of 1"}),this.nextPageButton=h.createLink({id:"next-page-button",href:"#",text:"Next",disabled:!0}),this.rowsPerPageSelect=h.createSelect({id:"rows-per-page-select",style:{padding:"5px",borderRadius:"4px",fontSize:"0.9em",border:"1px solid #ddd"},append:[h.createOption({value:"10",text:"10 per page",selected:10===this.rowsPerPage}),h.createOption({value:"25",text:"25 per page",selected:25===this.rowsPerPage}),h.createOption({value:"50",text:"50 per page",selected:50===this.rowsPerPage}),h.createOption({value:"100",text:"100 per page",selected:100===this.rowsPerPage})]})]})]}),this.parentElem.appendChild(this.tableContainer),this.prevPageButton=this.paginationControls.querySelector("#prev-page-button"),this.nextPageButton=this.paginationControls.querySelector("#next-page-button"),this.pageInfoSpan=this.paginationControls.querySelector("#page-info"),this.rowsPerPageSelect=this.paginationControls.querySelector("#rows-per-page-select")}_attachEventListeners(){this.prevPageButton.addEventListener("click",e=>this._handlePaginationChange(e)),this.nextPageButton.addEventListener("click",e=>this._handlePaginationChange(e)),this.rowsPerPageSelect.addEventListener("change",e=>this._handlePaginationChange(e))}render(e,t,a){this.allGroupDetails=e,this.activeFilters=t,this.lastPolledAt=a,this.groupsTableBody.innerHTML="",this.model=e.model,this.temperature=e.generationConfig?.temperature||0,this.filteredGroups=this._getFilteredGroups(this.allGroupDetails);t=Math.max(1,Math.ceil(this.filteredGroups.length/this.rowsPerPage)),this.currentPage>t&&(this.currentPage=t),a=this._getPaginatedGroups(this.filteredGroups);0===a.length?(e=h.createTableRow({append:[h.createTableCell({text:"No groups to display.",colSpan:6,style:{textAlign:"center",padding:"10px"}})]}),this.groupsTableBody.appendChild(e)):a.forEach(e=>{e=h.createTableRow({append:[h.createTableCell({text:e.groupNumber}),h.createTableCell({text:e.status}),h.createTableCell({text:e.stats?.totalItemsInGroup||"N/A"}),h.createTableCell({text:e.stats?.totalTokens||"N/A",style:{textAlign:"right"}}),h.createTableCell({text:JobUtils.getGroupProgressText(e,this.lastPolledAt),title:`Started: ${JobUtils.formatTimestamp(e.startedAt)}
Finished: `+JobUtils.formatTimestamp(e.finishedAt)}),this._renderReviewLinkCell(e),...this.showResetColumn?[this._renderResetGroupCell(e)]:[]]});this.groupsTableBody.appendChild(e)}),this._updatePaginationControls(this.filteredGroups.length)}_handlePaginationChange(e){var t;e.preventDefault(),"prev-page-button"===e.target.id?this.currentPage=Math.max(1,this.currentPage-1):"next-page-button"===e.target.id?(t=Math.max(1,Math.ceil(this.filteredGroups.length/this.rowsPerPage)),this.currentPage=Math.min(t,this.currentPage+1)):"rows-per-page-select"===e.target.id&&(this.rowsPerPage=parseInt(e.target.value,10),this.currentPage=1),this.render(this.allGroupDetails,this.activeFilters,this.lastPolledAt)}_updatePaginationControls(e){var t=Math.max(1,Math.ceil(e/this.rowsPerPage));this.pageInfoSpan.textContent=`Page ${this.currentPage} of `+t,this.prevPageButton.disabled=1===this.currentPage,this.prevPageButton.style.pointerEvents=1===this.currentPage?"none":"auto",this.prevPageButton.style.color=1===this.currentPage?"#aaa":null,this.nextPageButton.disabled=this.currentPage===t,this.nextPageButton.style.pointerEvents=this.currentPage===t?"none":"auto",this.nextPageButton.style.color=this.currentPage===t?"#aaa":null,e<=this.rowsPerPage&&0<e?this.paginationControls.style.display="none":this.paginationControls.style.display="flex"}_getFilteredGroups(e){let a=[];var t=this.activeFilters["filter-all"];(t||this.activeFilters["filter-pending"])&&a.push("PENDING"),(t||this.activeFilters["filter-running"])&&a.push("RUNNING"),(t||this.activeFilters["filter-succeeded"])&&a.push("SUCCEEDED"),(t||this.activeFilters["filter-failed"])&&a.push("FAILED");let i=t||this.activeFilters["filter-other"];return 0!==a.length||i?e.filter(e=>{var t=["PENDING","RUNNING","SUCCEEDED","FAILED"].includes(e.status);return!!a.includes(e.status)||!(!i||t)}):[]}_getPaginatedGroups(e){var t=(this.currentPage-1)*this.rowsPerPage,a=t+this.rowsPerPage;return e.slice(t,a)}_renderReviewLinkCell(a){var e,t=h.createTableCell();return"SUCCEEDED"!==a.status&&"FAILED"!==a.status||(a.analyzeChatUuid?(e=h.createLink({text:"Review",href:"/?chat="+a.analyzeChatUuid,target:"_blank"}),t.appendChild(e)):((e=h.createLink({text:"Create",href:"#"})).dataset.groupNumber=a.groupNumber,e.addEventListener("click",e=>{event.preventDefault();var t=event.target;this._handleCreateChatClick(t,a)}),t.appendChild(e))),t}_renderResetGroupCell(t){let a=h.createTableCell({style:{padding:"8px",border:"1px solid #ddd",textAlign:"center",width:"35px",position:"relative"}});return JobUtils.isJobFinal(t.status)&&setTimeout(()=>{let e=svg.sync({style:{width:"16px",height:"16px",cursor:"pointer",fill:"#007bff",display:"none"}});e.title="Re-evaluate Group "+t.groupNumber,e.dataset.groupNumber=t.groupNumber,e.addEventListener("click",e=>this._handleResetGroupClick(e,t)),a.parentNode?.addEventListener("mouseenter",()=>{e.style.display="block"}),a.parentNode?.addEventListener("mouseleave",()=>{e.style.display="none"}),a.appendChild(e)},500),a}async _handleResetGroupClick(e,t){e.preventDefault();let a=t.groupNumber;this.confirmationBox.show({title:"Re-evaluate Batch Group",message:`Are you sure you want to re-evaluate batch group ${a}? This will reset its status and re-process its files.`,confirmButtonText:"Re-evaluate",confirmButtonLoadingText:"Resetting..."},async()=>{try{NotificationManager.info(`Initiating re-evaluation for group ${a}...`);var e=await resetBatchGroup(this.context.widget,this.batchJobId,a);e.success?(NotificationManager.success(`Re-evaluation request sent for group ${a}.`),this.onGroupReset()):NotificationManager.error(`Failed to send re-evaluation request for group ${a}: `+e.message)}catch(e){console.error(`Error re-evaluating batch group ${a}:`,e),NotificationManager.error(`An error occurred while trying to re-evaluate group ${a}: `+e.message)}})}async _handleCreateChatClick(e,t){var a=t.groupNumber,t=t.generationConfig?.temperature||0;e.disabled=!0,e.style.pointerEvents="none",e.style.opacity="0.6";try{NotificationManager.info(`Creating review chat for group ${a}...`);var i=await getAnalyzeChatMessagesForBatchGroup(this.context.widget,this.batchJobId,a),r=i[i.length-1].model?.name||this.context.chat.main_model,s=(console.log(`Retrieved messages for group ${a}:`,i),{stream:!1,parentId:this.context.chat.id,type:"analyze",name:"Analyze - Group "+a,model:r,temperature:t,prompt:"Custom System Prompt",messages:i}),n=await MessageService.newChat(this.context.widget,s);await updateBatchGroupAnalyzeChatUuid(this.context.widget,this.batchJobId,a,n.uuid),NotificationManager.success(`Messages retrieved for group ${a}. Proceeding with chat creation.`),e.innerText="Review",e.target="_blank"}catch(e){console.error(`Error creating review chat for group ${a}:`,e),NotificationManager.error(`Failed to create review chat for group ${a}: `+e.message)}finally{e.disabled=!1,e.style.pointerEvents="auto",e.style.opacity="1"}}cleanup(){this.prevPageButton.removeEventListener("click",this._handlePaginationChange),this.nextPageButton.removeEventListener("click",this._handlePaginationChange),this.rowsPerPageSelect.removeEventListener("change",this._handlePaginationChange),this.showResetColumn&&this.groupsTableBody.querySelectorAll(".refresh-icon").forEach(e=>{e.removeEventListener("click",this._handleResetGroupClick)}),this.confirmationBox&&this.confirmationBox.destroy(),this.tableContainer&&this.tableContainer.parentElement&&this.tableContainer.remove(),console.log("Cleaned up GroupsTable.")}}module.exports=GroupsTable;
