/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let jsdiff=require("diff"),{ChatUtils,CodeBlockUtils,MessageUtils,PatchUtils,GSToolBlockUtils}=require("@gitsense/gsc-utils"),MessageService=require("../../../services/MessageService"),DomUtils=require("../../../utils/DomUtils"),{getToolBlocksByTool,getToolBlockElemsByTool,updateToolBlockConfig}=require("../../../utils/GSToolBlockUtils"),FIX_PATCH_TOOL=require("./constants").FIX_PATCH_TOOL,UPDATED_BAD_PATCH_HEADER="### Fixed Bad Patch";async function handleFixPatchTool(s,h,d,e){if(!s||null==s.message||!h||!d)return console.error("handleFixPatchTool: Missing required parameters."),!1;if(!d.chat||!d.chat.messages||!d.chat.messages[0])return console.error("handleFixPatchTool: Invalid chat context."),!1;if(s.message.split("\n").find(e=>e.trim().startsWith(UPDATED_BAD_PATCH_HEADER)))return!1;var o=getToolBlocksByTool(s.message,FIX_PATCH_TOOL);if(0===o.length)return!1;if(1!==o.length)return console.warn("handleFixPatchTool: More than one fix patch tool defined. Update message to ensure there is only one."),!1;let p=o[0].toolData,n=CodeBlockUtils.extractCodeBlocks(s.message,{silent:!0}).blocks;var o=n.filter(e=>"code"===e.type),a=n.filter(e=>"patch"===e.type);if(1!==o.length)return console.warn('handleFixPatchTool: Expected to find one code block of type "code" but found '+o),!1;if(a&&1<a.length)return console.warn('handleFixPatchTool: Expected to find one patch block of type "patch" but found '+a),!1;let g=o[0],l=a.length?a[0]:null;o=g.header?.["Parent-UUID"]||null;if(!o)return console.warn("handleFixPatchTool: No parent UUID in code block"),!1;let u=d.codeBlockService.getBlockInfo(o);if(null==u)return console.warn(`handleFixPatchTool: No source information for the UUID ${o} found in this chat`),!1;let r=p.config?.chatUUID||null;if(!r)return console.warn("handleFixPatchTool: No UUID defined for the chat with the bad patch"),!1;a=p.config?.messageId||null;if(!a)return console.warn("handleFixPatchTool: No message ID defined for the message with the bad patch"),!1;let i=await MessageService.getChat(d.widget,r);if(!i)return console.warn(`handleFixPatchTool: No chat with the UUID ${r} found`),!1;let c=MessageUtils.getMessageById(i,a);if(!c)return console.warn(`handleFixPatchTool: No message with the ID ${a} found in the chat with the bad patch (UUID ${r})`),!1;o=CodeBlockUtils.extractCodeBlocks(c.message,{silent:!0}).blocks;let f=0;o=o.filter((e,t)=>{if("patch"===e.type)return f=t,e});if(1!==o.length)return console.warn(`handleFixPatchTool: Expected to find one patch code block in message (#${a}) but found `+o.length),!1;a=getToolBlockElemsByTool(h,FIX_PATCH_TOOL);if(1!==a.length)return console.warn(`handleFixPatchTool: Expecting to find one ${FIX_PATCH_TOOL} tool but found `+a.length),!1;a[0].remove();var o=!0===p.config?.showReplace,a=DomUtils.h,t=a.createH3({text:"Update Bad Patch",style:{}}),T=a.createParagraph({html:o?"Choose an option below to replace the bad patch in the <strong>parent chat</strong>. Note, the bad patch in <strong>this chat</strong> will not be updated.":'Click "Generate Patch" to create a corrected patch from the code above. You can then choose to replace the bad patch in the parent chat.',style:{}}),m=a.createDiv({style:{marginTop:"10px"}});if(o){let t=async(e,t)=>{e=CodeBlockUtils.updateCodeBlockByIndex(c.message,f,e,t),t="diff"===t?e:`**UPDATED** ${(new Date).toISOString()}

`+`Patch replaced with the full source. Please refer to the <a href=/?chat=${d.chat.uuid}>Fix Patch</a> `+"chat to learn more.\n\n**IMPORTANT** Continue to generate patches unless told otherwise.\n\n---\n\n"+e;await MessageService.updateChatMessage(d.widget,c.id,null,t);let o=s.message;e=n.findIndex(e=>"gs-tool"===e.type),t=(o=-1!==e?CodeBlockUtils.deleteCodeBlockByIndex(o,e):o).split("\n");let a="";t[t.length-1].match(/Authored by LLM /)&&(a="\n\n"+t.pop(),t.pop()),o=t.join("\n"),o+="\n\n"+UPDATED_BAD_PATCH_HEADER+"\n\n"+`Successfully replaced the bad patch in chat ${r} with the code above.`+a,await MessageService.updateChatMessage(d.widget,s.id,null,o),P.remove(),await MessageService.setChat(i)};var o=a.createLink({text:"Replace with Fixed Patch (Recommended)",href:"#",onclick:async e=>{e.preventDefault(),await t(l.content,"diff")},style:{marginRight:"15px",fontWeight:500}}),x=a.createLink({text:"Replace with Full Code",href:"#",onclick:async e=>{e.preventDefault();e=g.headerText+"\n\n\n"+g.content.trimEnd();await t(e,u.lanuage)},style:{marginRight:"15px",fontWeight:500}});m.appendChild(o),m.appendChild(x)}else{let c=a.createButton({cls:"btn btn-primary",text:"Generate Patch",onclick:async e=>{c.style.poinerEvents="none",c.innerText="Generating...";var t=u.headerText+"\n\n\n"+u.content.trimEnd(),o=g.headerText+"\n\n\n"+g.content.trimEnd(),a={"Source-Block-UUID":g.header["Parent-UUID"],"Target-Block-UUID":g.header["Block-UUID"],"Source-Version":u.header.Version,"Target-Version":g.header.Version,Description:g.header.Description,Authors:g.header.Authors};try{var n,l,r=PatchUtils.createPatchFromCodeBlocks(CodeBlockUtils,t,o,a),i=PatchUtils.applyPatch(t,r.formatted);i.valid?(p.config.showReplace=!0,l="```"+u.language+"\n"+o+"\n```\n\n```diff\n"+r.formatted+"\n\n```\n\n```txt\n"+GSToolBlockUtils.formatToolBlock(p)+"\n```",await MessageService.updateChatMessage(d.widget,s.id,null,l),setTimeout(async()=>{delete h.addedPreviewChangesControl,d.updateChat()},1e3)):(c.style.display="none",n="Failed to generate a patch due to the following error:<pre>"+i.errors.join("\n")+"</pre>",_showError(h,"Generation Failed",n))}catch(e){c.style.poinerEvents=null,c.innerText="Generate Patch",console.error("Error generating patch:",e),alert("Failed to generate patch: "+e.message)}}});m.appendChild(c)}let P=a.createDiv({append:[t,T,m],style:{marginTop:"10px"}});h.appendChild(P)}function _showError(e,t,o){var a;e&&e.parentNode?(t=(a=DomUtils.h).createH3({text:t,style:{color:"#721c24",marginTop:"0",fontSize:"16px"}}),o=a.createParagraph({html:o,style:{color:"#721c24"}}),a=a.createDiv({cls:"patch-error-container",append:[t,o],style:{marginTop:"5px",marginBottom:"20px",padding:"15px",paddingBottom:"0px",border:"1px solid #dc3545",borderRadius:"4px",backgroundColor:"#f8d7da"}}),e.appendChild(a)):console.error("_showPatchError: Cannot display error, invalid contentBody.")}module.exports={handleFixPatchTool:handleFixPatchTool};
