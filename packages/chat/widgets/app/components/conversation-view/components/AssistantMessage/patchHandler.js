/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let{CodeBlockUtils,PatchUtils,MessageUtils}=require("@gitsense/gsc-utils"),DomUtils=require("../../utils/DomUtils"),createRegenerateRequestMessage=require("../../utils/PatchRegenerationUtils").createRegenerateRequestMessage,QuickChatButtons=require("../../Dependencies").QuickChatButtons;async function handlePatch(a,r,o,n){if(!(a&&null!=a.message&&r&&o&&o.codeBlockService&&o.chat))return console.error("handlePatch: Missing message, contentBody, codeBlockService, or chat in context."),!1;var c=a.kids&&a.kids.length&&a.kids[0].message.startsWith("Your task is to apply the provided patch to the original code block.");if(!c){var c=o.codeBlockService,i=r.querySelectorAll("pre");let e=null,t=null;var s={};try{var l,h=CodeBlockUtils.processCodeBlocks(a.message,{silent:!0}).blocks,d=h.filter(e=>"patch"===e.type);if(0===d.length)return!1;if(1<d.length)return l=h.map(e=>e.type).lastIndexOf("patch"),(e=-1!==l&&l<i.length?i[l]:0<i.length?i[i.length-1]:null)?(_showPatchError(r,`Error: Multiple patch blocks found (${d.length}). Only one patch per message is supported.`,a,null,o,n,"Multiple Patches Found"),!0):(console.error("handlePatch (multiple): Could not find any pre element to attach error message."),!1);t=d[0];var p,g,u,m,f,k,y,P=h.findIndex(e=>"patch"===e.type);return(e=-1!==P&&P<i.length?i[P]:0<i.length?i[i.length-1]:null)?("traditional"!==(p=PatchUtils.determinePatchFormat(t.content))?_showPatchError(r,`Error: Invalid or unsupported patch format detected ('${p}'). Expected traditional unified diff.`,a,t,o,n,"Invalid Patch Format"):(s=PatchUtils.extractPatchMetadata(t.content),0<(g=PatchUtils.validatePatchMetadata(s)).length?_showPatchError(r,"Error: Invalid patch metadata. "+g.join("; "),a,t,o,n,"Invalid Metadata"):(u=s["Source-Block-UUID"],(m=c.getBlockInfo(u))?"string"!=typeof(f=m.content)?_showPatchError(r,`Error: Source block data for UUID ${u} is missing code content.`,a,t,n,"Source Content Missing"):(k=m.headerText,(y=PatchUtils.applyPatch(k+`


`+f,t.content)).valid||_showPatchError(r,"Error: Patch cannot be applied to the source code. "+(y.errors[0]||"Unknown application error"),a,t,o,n,"Patch Application Failed")):_showPatchError(r,`Error: Source code block with UUID ${u} not found in chat history.`,a,t,o,n,"Source Block Not Found"))),!0):(console.error("handlePatch (single): Could not find the patch block DOM element to attach controls."),!1)}catch(e){return console.error(`handlePatch: Unexpected error during validation for message ID ${a.id}:`,e),_showPatchError(r,"Internal error during patch validation: "+e.message,a,t,o,n,"Internal Validation Error"),!0}}}function _showPatchError(e,t,n,c,i,a,r="Patch Error"){if(e&&e.parentNode){let o=DomUtils.h;var s,l=o.createH3({text:r,style:{color:"#721c24",marginTop:"0",fontSize:"16px"}}),h=o.createParagraph({text:t,style:{color:"#721c24"}}),l=o.createDiv({cls:"patch-error-container",append:[l,h],style:{marginTop:"5px",marginBottom:"20px",padding:"15px",paddingBottom:"0px",border:"1px solid #dc3545",borderRadius:"4px",backgroundColor:"#f8d7da"}});e.appendChild(l),"Source Block Not Found"===r||(h=o.createH3({text:"Fix Patch",style:{}}),r=o.createParagraph({html:'To fix this patch or to replace it with the full code, click the button below to start a "Fix Patch Chat". It it recommended that you use a cheap, fast and capable LLM like no thinking <strong>Geminin Flash 2.5</strong>',style:{}}),s=o.createButton({cls:"btn btn-primary regenerate-patch-btn",text:"Start",style:{marginRight:"5px"},onclick:()=>{try{var e=c?.metadata||PatchUtils.extractPatchMetadata(c?.content||""),t=o.createDiv({style:"display:none"}),a=(document.body.appendChild(t),{type:"fix-patch",params:{metadata:e,messageId:n.id,chatUUID:i.chat.uuid},onDone:()=>{}}),r=new QuickChatButtons([a],i);r.render(t),r.click(a)}catch(e){console.error("Error creating regeneration request message:",e)}}}),e.appendChild(l),l=o.createDiv({append:[h,r,s],style:{paddingBottom:"10px"}}),t.includes("Multiple patch blocks found"))||e.appendChild(l)}else console.error("_showPatchError: Cannot display error, invalid contentBody.")}function _showApplyPatchButton(e,C,B,E,I,D,M){if(e&&e.parentNode){var t,a,r,o=e.nextElementSibling;o&&(o.classList.contains("patch-error-container")||o.classList.contains("patch-apply-container"))&&o.remove();let b=E.header;b?(o=DomUtils.h.createDiv({cls:"patch-apply-container",style:{marginTop:"10px"}}),t=DomUtils.h.createH3({text:"Patch Verified",style:{marginTop:"0px"}}),a=DomUtils.h.createParagraph({text:"Clicking this button will apply the code changes to a new, separate version of this chat, keeping only the essential messages.",style:{color:"#586069",marginBottom:"10px"}}),r=DomUtils.h.createButton({cls:"btn btn-primary apply-patch-btn",text:"Fork, patch and clean",style:{marginBottom:"20px"},onclick:()=>{try{var e=I["Source-Block-UUID"];let r=I["Target-Block-UUID"];var a=b.Language||"text",c=(E.messageId,C.id,E.content);if("string"!=typeof c)throw new Error(`Source block data for UUID ${e} is missing code content.`);var i=PatchUtils.applyPatch(c,B.content);if(!i.valid)throw new Error("Patch application failed unexpectedly during fork: "+i.errors.join(", "));var s=i.patchedText,l=PatchUtils.formatCodeBlockHeader(E,B)+`


`+s,h=D.chat.messages[0];if(!h)throw new Error("Cannot find root node of the chat.");var d=JSON.parse(JSON.stringify(h));let o=new RegExp(`^Regeneration Request for Patch: ${r}
`),n=null;var p=MessageUtils.findMessages(d,e=>{var t=e.message;if(t.match(o))return!0;if("assistant"===e.role&&t.includes("# Patch Metadata")){var a,t=CodeBlockUtils.processCodeBlocks(t,{silent:!0}).blocks;for(a of t.filter(e=>"patch"===e.type))if(PatchUtils.extractPatchMetadata(a.content)["Target-Block-UUID"]===r)return e.id!==C.id||(n=e,!1)}return!1});if(!n)throw new Error(`Could not find the valid patch message (ID: ${C.id}) in the cleaned chat tree.`);var g=p.map(e=>e.id),u=MessageUtils.deleteMessagesByIds(d,g);if(!u)throw new Error("Cleaning process resulted in a null root node. Original root might have been deleted.");var m=MessageUtils.getMessageById(u,n.id);if(!m)throw new Error(`Could not find the target message (ID: ${n.id}) in the cleaned tree after deletion.`);var f=B.content.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),k=new RegExp("```(?:diff)?\\s*\\n"+f+"\\s*```"),y=m.message.match(k);if(!y)throw console.error("Original patch block content (escaped):\n",f),console.error("Message content being searched:\n",m.message),new Error("Could not find the original patch code block within the message content for replacement.");var P="```"+a.toLowerCase()+"\n"+l+"\n```",v=m.message.replace(y[0],P),U=r.substring(0,8)+"...",w=e.substring(0,8)+"...";m.message="**Updated Code (Patch Applied)**\n\n"+`Code block \`${U}\` contains the applied patch to \`${w}\`. `+`Please refer to chat ${D.chat.uuid} to view the original patch.

`+"---\n\n"+v;let t=C.model;var x=MessageUtils.findMessages(u,e=>"user"===e.role||"system"===e.role||"assistant"===e.role&&e.model===t);if(!M.forkChat||"function"!=typeof M.forkChat)throw new Error("forkChat event handler is not available.");M.forkChat(x,C.real_model||C.model)}catch(e){console.error("Error during fork and patch process:",e),alert("An error occurred during the fork and patch process: "+e.message)}}}),o.appendChild(t),o.appendChild(a),o.appendChild(r),e.parentNode.insertBefore(o,e.nextSibling)):(console.error("_showApplyPatchButton: Source block info is missing header details."),_showPatchError(e,"Internal Error: Cannot apply patch, source block header information is missing.",C,B,D,M,"Internal Apply Error"))}else console.error("_showApplyPatchButton: Cannot display button, invalid patchBlockElement.")}module.exports={handlePatch:handlePatch};
