/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let crypto=require("crypto"),{CodeBlockUtils,getMessageById,isContextMessage,isContextItemsOverviewMessage}=require("@gitsense/gsc-utils"),DomUtils=require("../../utils/DomUtils"),MarkdownUtils=require("../../utils/MarkdownUtils"),MessageUtils=require("../../utils/MessageUtils"),MessageService=require("../../services/MessageService"),MessageModal=require("../modals/EditMessageModal").MessageModal,{MESSAGE_TYPES,MODEL_CONSTANTS}=require("../../constants/MessageConstants"),renderModelSelector=require("../ModelSelector").renderModelSelector,renderMessageActions=require("../MessageActions").renderMessageActions,{renderMessageHeader,createModelAvatar,createMessageContainer}=require("../MessageHeader"),handleHelpMessage=require("./helpMessageHandler").handleHelpMessage,handleMessageStreaming=require("./streamingHandler").handleMessageStreaming,handleCodeBlockContinuation=require("./codeBlockContinuationHandler").handleCodeBlockContinuation,handlePatch=require("./patchHandler").handlePatch,handleContextMessage=require("./contextMessageHandler").handleContextMessage,handleSplitMessage=require("./splitMessageHandler").handleSplitMessage,handleAnalyze=require("./analyzeHandler").handleAnalyze,handleNewAnalyzer=require("./newAnalyzerHandler").handleNewAnalyzer,handleGitSenseChatTools=require("./GSToolHandlers/gitsenseChatToolHandler").handleGitSenseChatTools,handleChatIds=require("./chatIdsHandler").handleChatIds,handleSearchResults=require("./searchResultsHandler").handleSearchResults,handleGitSenseChatDemo=require("./gitsenseChatDemoHandler").handleGitSenseChatDemo,CodeBlock=require("../CodeBlock"),ScrollUtils=require("../../utils/ScrollUtils");async function renderMessage(s,e,a,t,l,o,n,r,i,d){var{id:h,type:g,real_model:c}=s,M=s.message,c=c||a,m=c.match(new RegExp(MODEL_CONSTANTS.GITSENSE_NOTES)),u=M&&M.trimStart().startsWith("# GitSense Chat Analysis"),S="demos"===g,p="help"===g,C="git-repos"===g,y="git-repo-owner"===g,w="git-repo"===g,B="git-tree"===g,T="git-blob"===g,k="git-ref"===g&&l.chat.meta&&l.chat.meta.type&&l.chat.meta.type.match(/branch/),A="chat-meta"===g,q="chat-history"===g,H=M&&M.includes("```txt\n# GitSense Chat Tool\n")&&M.includes('"search"'),v=M&&M.startsWith("## Search Results Review - Stage:"),E=ScrollUtils.trackScrollPosition(o.scrollableElement||window);let x=Object.keys(t).sort();if(1<x.length){let s=MODEL_CONSTANTS.GITSENSE_NOTES;var U=x.filter(e=>e!==s),U=(x.length!==U.length&&(U.unshift(s),x=U),renderModelSelector(x,a,t,l.chat,o.inSideBySide,r,i));r=U.modelsBody,i=U.modelsOptionsBody}d||(r=createModelAvatar(c,{isAnalysis:u,isHistory:q,isSearch:H}),l.messagesBody.appendChild(r),(d=createMessageContainer(x,{isAnalysis:u,isHistory:q,isSearch:H,isHelp:p})).elements={},U=DomUtils.h.createDiv({id:s.id,cls:"gs-chat-assistant-message",append:[r,d]}),l.messagesBody.appendChild(U),l.messageBodies.push(d),"assistant"===s.role&&""===e.message&&(U.style.marginTop=null,d.style.marginTop=null,r.style.marginTop=null));i=(v?{expanded:!1}:l.messageStateManager.getState(MessageUtils.getMsgStateId(h))||{}).expanded;let I;I=null===M?null:C||y||w||k||B||T||A||q||u?renderMessageHeader(l.chat,s,l.md):l.md.render(M);H=DomUtils.h.createDiv({cls:"markdown-body",html:I,style:{fontSize:"15px"}}),null!==M&&MarkdownUtils.addSignature(H,c),null===M||i||(H.style.maxHeight=o.MAX_COLLAPSED_MSG_HEIGHT+"px",H.style.overflow="hidden"),d.appendChild(H),e=DomUtils.h.createDiv({style:{opacity:0,marginTop:"20px",marginBottom:"15px"}}),d.appendChild(e),d.elements.optionsBody=e,U=M?M.replace(/\n\nAuthored by LLM.+$/,""):"";l.renderedMessage[h]={contentBody:H,messageBody:d,md5:null==M?"":crypto.createHash("md5").update(U).digest("hex"),cleanedContent:U},E();function D(e){s=getMessageById(l.chat,s.id),new MessageModal(l.widget,s,e?"fork":"edit",e=>{CodeBlockUtils.containsPatch(e)&&window.location.reload(),l.updateChat()},{chat:l.chat,mainModel:a,models:l.settings.models,fakeLLMs:l.settings.fakeLLMs}).render()}null!=M?(renderMessageActions(e,s,{showCopy:o.showCopy,showEdit:o.showEdit,showFork:o.showFork,showNote:o.showNote,showCodeOptions:o.showCodeOptions,showInsights:o.showInsights,showTryAgain:o.showTryAgain,showTrash:o.showTrash,isNotesModel:m},{widget:l.widget,chat:l.chat,mainModel:a,settings:l.settings,allModels:x,model2Messages:t,contentBody:H,messageStateManager:l.messageStateManager,messageBodies:l.messageBodies},D),r=M.includes("UUID")?35:5,isContextMessage(s.message)||isContextItemsOverviewMessage(s.message)?(await handleContextMessage(s,H,l,n),await handleGitSenseChatTools(s,H,l,n)):p?(await handleHelpMessage(s,H,l,n),handleSplitMessage(s,H,l,n),CodeBlock.addClipboards(H,r),CodeBlock.addCodeBlockControls(H,l.chat,s,l.widget,l.codeBlockService,l.hljs)):(await handleGitSenseChatTools(s,H,l,n),await handlePatch(s,H,l,n),await handleAnalyze(s,H,l,n),await handleNewAnalyzer(s,H,l,n),handleSplitMessage(s,H,l,n),handleSearchResults(s,H,l,n),CodeBlock.addClipboards(H,r),CodeBlock.addPreFoldLinks(H,s,l.messageStateManager,l.hljs),handleChatIds(s,H,l,n),g.startsWith("git")||CodeBlock.addCodeBlockControls(H,l.chat,s,l.widget,l.codeBlockService,l.hljs)),await handleGitSenseChatDemo(s,H,l,n),(v=H.querySelector("p"))&&v.textContent.trimStart().startsWith("\x3c!--")&&v.remove(),updateMessageBodies(l.messageBodies),p||S||!o.scrollToBottomOnLoad||o.enableEnhancedScrolling&&l.scrollIntentManager&&!l.scrollIntentManager.shouldAutoScroll()||ScrollUtils.scrollToBottom(o.scrollableElement,d,50)):await handleMessageStreaming(s,c,t,H,l,o,n,e,d,D,updateMessageBodies)}function updateMessageBodies(s){if(s&&Array.isArray(s)){var a=s.length-1;for(let e=0;e<s.length;e++){var t=s[e];t&&t.elements&&(e===a?(t.isLastMessage=!0,t.elements.optionsBody.style.opacity=1):(t.isLastMessage=!1,t.elements.optionsBody.style.opacity=0))}}else console.warn("Cannot update message bodies: Invalid messageBodies array")}module.exports={renderMessage:renderMessage,updateMessageBodies:updateMessageBodies};
