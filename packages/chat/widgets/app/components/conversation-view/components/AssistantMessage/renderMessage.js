/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let crypto=require("crypto"),{CodeBlockUtils,getMessageById,isContextMessage,isContextItemsOverviewMessage}=require("@gitsense/gsc-utils"),DomUtils=require("../../utils/DomUtils"),MarkdownUtils=require("../../utils/MarkdownUtils"),MessageUtils=require("../../utils/MessageUtils"),MessageService=require("../../services/MessageService"),MessageModal=require("../modals/EditMessageModal").MessageModal,{MESSAGE_TYPES,MODEL_CONSTANTS}=require("../../constants/MessageConstants"),renderModelSelector=require("../ModelSelector").renderModelSelector,renderMessageActions=require("../MessageActions").renderMessageActions,{renderMessageHeader,createModelAvatar,createMessageContainer}=require("../MessageHeader"),handleHelpMessage=require("./helpMessageHandler").handleHelpMessage,handleMessageStreaming=require("./streamingHandler").handleMessageStreaming,handleCodeBlockContinuation=require("./codeBlockContinuationHandler").handleCodeBlockContinuation,handlePatch=require("./patchHandler").handlePatch,handleContextMessage=require("./contextMessageHandler").handleContextMessage,handleSplitMessage=require("./splitMessageHandler").handleSplitMessage,handleAnalyze=require("./analyzeHandler").handleAnalyze,handleNewAnalyzer=require("./newAnalyzerHandler").handleNewAnalyzer,handleGitSenseChatTools=require("./GSToolHandlers/gitsenseChatToolHandler").handleGitSenseChatTools,handleChatIds=require("./chatIdsHandler").handleChatIds,handleSearchResults=require("./searchResultsHandler").handleSearchResults,handleGitSenseChatDemo=require("./gitsenseChatDemoHandler").handleGitSenseChatDemo,CodeBlock=require("../CodeBlock"),ScrollUtils=require("../../utils/ScrollUtils");async function renderMessage(s,e,a,t,l,o,n,r,i,d){var{id:h,type:g,real_model:c}=s,M=s.message,c=c||a,m=c.match(new RegExp(MODEL_CONSTANTS.GITSENSE_NOTES)),p=M&&M.trimStart().startsWith("# GitSense Chat Analysis"),u="help"===g,S="git-repos"===g,C="git-repo-owner"===g,y="git-repo"===g,w="git-tree"===g,B="git-blob"===g,T="git-ref"===g&&l.chat.meta&&l.chat.meta.type&&l.chat.meta.type.match(/branch/),k="chat-meta"===g,A="chat-history"===g,q=M&&M.includes("```txt\n# GitSense Chat Tool\n")&&M.includes('"search"'),H=M&&M.startsWith("## Search Results Review - Stage:"),v=ScrollUtils.trackScrollPosition(o.scrollableElement||window);let x=Object.keys(t).sort();if(1<x.length){let s=MODEL_CONSTANTS.GITSENSE_NOTES;var E=x.filter(e=>e!==s),E=(x.length!==E.length&&(E.unshift(s),x=E),renderModelSelector(x,a,t,l.chat,o.inSideBySide,r,i));r=E.modelsBody,i=E.modelsOptionsBody}d||(r=createModelAvatar(c,{isAnalysis:p,isHistory:A,isSearch:q}),l.messagesBody.appendChild(r),(d=createMessageContainer(x,{isAnalysis:p,isHistory:A,isSearch:q,isHelp:u})).elements={},E=DomUtils.h.createDiv({id:s.id,cls:"gs-chat-assistant-message",append:[r,d]}),l.messagesBody.appendChild(E),l.messageBodies.push(d),"assistant"===s.role&&""===e.message&&(E.style.marginTop=null,d.style.marginTop=null,r.style.marginTop=null));i=(H?{expanded:!1}:l.messageStateManager.getState(MessageUtils.getMsgStateId(h))||{}).expanded;let U;U=null===M?null:S||C||y||T||w||B||k||A||p?renderMessageHeader(l.chat,s,l.md):l.md.render(M);q=`<p style='font-size:13px;margin-bottom:12px;'>${c}</p>`,e=DomUtils.h.createDiv({cls:"markdown-body",html:(u?"":q)+U,style:{fontSize:"15px"}}),null!==M&&MarkdownUtils.addSignature(e,c),null===M||i||(e.style.maxHeight=o.MAX_COLLAPSED_MSG_HEIGHT+"px",e.style.overflow="hidden"),d.appendChild(e),E=DomUtils.h.createDiv({style:{opacity:0,marginTop:"20px",marginBottom:"15px"}}),d.appendChild(E),d.elements.optionsBody=E,r=M?M.replace(/\n\nAuthored by LLM.+$/,""):"";l.renderedMessage[h]={contentBody:e,messageBody:d,md5:null==M?"":crypto.createHash("md5").update(r).digest("hex"),cleanedContent:r},v();function I(e){s=getMessageById(l.chat,s.id),new MessageModal(l.widget,s,e?"fork":"edit",e=>{CodeBlockUtils.containsPatch(e)&&window.location.reload(),l.updateChat()},{chat:l.chat,mainModel:a,models:l.settings.models,fakeLLMs:l.settings.fakeLLMs}).render()}null!=M?(renderMessageActions(E,s,{showCopy:o.showCopy,showEdit:o.showEdit,showFork:o.showFork,showNote:o.showNote,showCodeOptions:o.showCodeOptions,showInsights:o.showInsights,showTryAgain:o.showTryAgain,showTrash:o.showTrash,isNotesModel:m},{widget:l.widget,chat:l.chat,mainModel:a,settings:l.settings,allModels:x,model2Messages:t,contentBody:e,messageStateManager:l.messageStateManager,messageBodies:l.messageBodies},I),H=M.includes("UUID")?35:5,isContextMessage(s.message)||isContextItemsOverviewMessage(s.message)?(await handleContextMessage(s,e,l,n),await handleGitSenseChatTools(s,e,l,n)):u?(await handleHelpMessage(s,e,l,n),handleSplitMessage(s,e,l,n),CodeBlock.addClipboards(e,H),CodeBlock.addCodeBlockControls(e,l.chat,s,l.widget,l.codeBlockService,l.hljs)):(await handleGitSenseChatTools(s,e,l,n),await handlePatch(s,e,l,n),await handleAnalyze(s,e,l,n),await handleNewAnalyzer(s,e,l,n),handleSplitMessage(s,e,l,n),handleSearchResults(s,e,l,n),CodeBlock.addClipboards(e,H),CodeBlock.addPreFoldLinks(e,s,l.messageStateManager,l.hljs),handleChatIds(s,e,l,n),g.startsWith("git")||CodeBlock.addCodeBlockControls(e,l.chat,s,l.widget,l.codeBlockService,l.hljs)),await handleGitSenseChatDemo(s,e,l,n),(S=e.querySelector("p"))&&S.textContent.trimStart().startsWith("\x3c!--")&&S.remove(),updateMessageBodies(l.messageBodies),u||!o.scrollToBottomOnLoad||o.enableEnhancedScrolling&&l.scrollIntentManager&&!l.scrollIntentManager.shouldAutoScroll()||ScrollUtils.scrollToBottom(o.scrollableElement,d,50)):await handleMessageStreaming(s,c,t,e,l,o,n,E,d,I,updateMessageBodies)}function updateMessageBodies(s){if(s&&Array.isArray(s)){var a=s.length-1;for(let e=0;e<s.length;e++){var t=s[e];t&&t.elements&&(e===a?(t.isLastMessage=!0,t.elements.optionsBody.style.opacity=1):(t.isLastMessage=!1,t.elements.optionsBody.style.opacity=0))}}else console.warn("Cannot update message bodies: Invalid messageBodies array")}module.exports={renderMessage:renderMessage,updateMessageBodies:updateMessageBodies};
