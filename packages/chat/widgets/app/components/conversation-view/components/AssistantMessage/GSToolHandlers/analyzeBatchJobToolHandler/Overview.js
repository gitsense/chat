/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let JobUtils=require("./JobUtils"),DomUtils=require("../../../../utils/DomUtils"),{cancelBatchJob,ConfirmationBox,NotificationManager}=require("../../../../Dependencies"),h=DomUtils.h;class Overview{constructor(e,t,a,i,n,l=()=>{}){this.parentElem=e,this.context=t,this.batchJobId=a,this.batchType=i,this.analyzerId=n,this.confirmationBox=null,this.onJobCancelled=l,this.currentBatchDetails=null,this.overviewContainer=null,this.batchJobIdValueElem=null,this.analyzerIdValueElem=null,this.statusValueElem=null,this.createdAtValueElem=null,this.updatedAtValueElem=null,this.refreshedAtValueElem=null,this.refreshedAtIntervalId=null,this.cancelButton=null,this._renderInitialUI(),this._initializeComponents(),this._attachEventListeners(),this._handleCancelButtonClick=this._handleCancelButtonClick.bind(this)}_renderInitialUI(){this.overviewContainer=h.createDiv({id:"analyze-batch-job-overview-container",style:{display:"flex",flexDirection:"column",gap:"15px",paddingBottom:"15px",borderBottom:"1px solid #eee"},append:[h.createDiv({id:"top-row",style:{display:"flex",justifyContent:"space-between",alignItems:"center"},append:[h.createH1({style:{margin:"0",borderBottom:"0px"},append:[h.createText(`Analyze Batch - ${this.batchType.charAt(0).toUpperCase()+this.batchType.slice(1)} - Job ID: `),h.createSpan({id:"batch-job-id-value",text:this.batchJobId})]}),h.createDiv({append:[h.createButton({id:"cancel-button",cls:"btn btn-outline",text:"Cancel Job",disabled:!0})]})]}),h.createH2({id:"analyzer",style:{margin:"0",color:"#555",borderBottom:"0px"},append:[h.createSpan({id:"analyzer-id-value",text:this.analyzerId})]}),h.createDiv({id:"status-row",style:{display:"flex",flexWrap:"wrap",gap:"20px",alignItems:"center",padding:"5px 0"},append:[h.createDiv({append:[h.createStrong({text:"Status:"}),h.createSpan({id:"status-value",text:"[status]",style:{marginLeft:"5px"}})]}),h.createDiv({append:[h.createStrong({text:"Created:"}),h.createSpan({id:"created-at-value",text:"N/A",style:{marginLeft:"5px"}})]}),h.createDiv({append:[h.createStrong({text:"Updated:"}),h.createSpan({id:"updated-at-value",text:"N/A",style:{marginLeft:"5px"}})]}),h.createDiv({append:[h.createStrong({text:"Refreshed:"}),h.createSpan({id:"refreshed-at-value",text:"N/A",style:{marginLeft:"5px"}})]})]})]}),this.parentElem.appendChild(this.overviewContainer),this.batchJobIdValueElem=this.overviewContainer.querySelector("#batch-job-id-value"),this.analyzerIdValueElem=this.overviewContainer.querySelector("#analyzer-id-value"),this.statusValueElem=this.overviewContainer.querySelector("#status-value"),this.createdAtValueElem=this.overviewContainer.querySelector("#created-at-value"),this.updatedAtValueElem=this.overviewContainer.querySelector("#updated-at-value"),this.refreshedAtValueElem=this.overviewContainer.querySelector("#refreshed-at-value"),this.cancelButton=this.overviewContainer.querySelector("#cancel-button")}_initializeComponents(){this.confirmationBox=new ConfirmationBox}_attachEventListeners(){this.cancelButton.addEventListener("click",e=>this._handleCancelButtonClick(e))}update(e){this.currentBatchDetails=e,this.batchJobIdValueElem.textContent=e.batchJobId,this.analyzerIdValueElem.textContent=this.analyzerId,this.statusValueElem.textContent=e.status,this.createdAtValueElem.textContent=JobUtils.formatRelativeTime(e.createdAt),this.updatedAtValueElem.textContent=JobUtils.formatRelativeTime(e.updatedAt||e.createdAt);var t=JobUtils.isJobFinal(e.status),a=this.refreshedAtValueElem.parentElement;t?(JobUtils.stopRelativeTimeUpdater(this.refreshedAtIntervalId),this.refreshedAtIntervalId=null,a.style.display="none"):(a.style.display="block",JobUtils.stopRelativeTimeUpdater(this.refreshedAtIntervalId),this.refreshedAtIntervalId=JobUtils.startRelativeTimeUpdater(this.refreshedAtValueElem,e.lastPolledAt||e.createdAt)),JobUtils.isCancellable(e.status)?this.cancelButton.disabled=!1:this.cancelButton.style.display="none"}async _handleCancelButtonClick(){this.confirmationBox.show({title:"Cancel Batch Job",message:`Are you sure you want to cancel batch job ${this.batchJobId}? This action cannot be undone.`},async()=>{this.cancelButton.disabled=!0;try{var e=await cancelBatchJob(this.context.widget,this.batchJobId);e.success?(NotificationManager.success("Cancellation request sent. New status: "+e.newStatus),this.onJobCancelled()):(NotificationManager.error("Failed to send cancellation request: "+e.message),this.cancelButton.disabled=!JobUtils.isCancellable(this.currentBatchDetails.status))}catch(e){console.error(`Error cancelling batch job ${this.batchJobId}:`,e),NotificationManager.error("An error occurred while trying to cancel the job: "+e.message),this.cancelButton.disabled=!JobUtils.isCancellable(this.currentBatchDetails.status)}})}cleanup(){this.cancelButton.removeEventListener("click",this._handleCancelButtonClick),this.overviewContainer&&this.overviewContainer.parentElement&&this.overviewContainer.remove(),this.confirmationBox&&this.confirmationBox.destroy(),JobUtils.stopRelativeTimeUpdater(this.refreshedAtIntervalId),console.log(`Cleaned up Overview for job ${this.batchJobId}.`)}}module.exports=Overview;
