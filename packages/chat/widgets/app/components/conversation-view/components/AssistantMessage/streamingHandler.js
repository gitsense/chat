/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let crypto=require("crypto"),{ChatUtils,CodeBlockUtils,MessageUtils}=require("@gitsense/gsc-utils"),handleAnalyze=require("./analyzeHandler").handleAnalyze,handleNewAnalyzer=require("./newAnalyzerHandler").handleNewAnalyzer,DomUtils=require("../../utils/DomUtils"),CodeBlock=require("../CodeBlock"),ScrollUtils=require("../../utils/ScrollUtils"),StreamingService=require("../../services/StreamingService").StreamingService,renderMessageActions=require("../MessageActions").renderMessageActions,MODEL_CONSTANTS=require("../../constants/MessageConstants").MODEL_CONSTANTS,activeStreamingServices=new Map;async function handleMessageStreaming(n,l,r,i,g,c,d,m,h,S,w){i.style.color="gray",i.innerHTML="<p>Waiting for response...</p>",c.enableEnhancedScrolling&&g.scrollIntentManager&&g.scrollIntentManager.forceAutoScrolling(),c.scrollToBottomOnLoad&&ScrollUtils.scrollToBottom(c.scrollableElement,h,50);var e=g.chat,t=ChatUtils.getChatMessages(g.chat),s=t.find(e=>"assistant"===e.role)?.message?.trimStart().startsWith("# Analyzer Requirements")||!1,e=ChatUtils.isAnalyzeChat(e,n.model),o=2<=t.length?t[t.length-2]:null,t=3<=t.length?t[t.length-3]:null;let a=s&&"user"===o?.role&&o.message.toLowerCase().includes("yes")&&"assistant"===t?.role&&t.message.toLowerCase().includes("would you like me to generate the instructions now? answer yes or no only."),u=e&&o?.message.startsWith("Start analysis immediately."),M=(a&&u&&(i.innerHTML=""),0);s=new StreamingService({widget:g.widget,settings:g.settings,chat:g.chat,message:n,contentBody:u||a?null:i,md:g.md,chatInput:g.chatInput,messagesContainer:g.messagesBody,scrollOptions:{scrollableElement:c.scrollableElement||window,scrollThreshold:c.scrollThreshold||200},onMessage:u||a?async(e,t)=>{var s=(new Date).getTime();if(s-M<500)return!1;M=s,n.message=e;let o=!1;return u?o=await handleAnalyze(n,i,g,d,!0):a&&(o=await handleNewAnalyzer(n,i,g,d,a)),o?stopAllStreaming():c.scrollToBottomOnLoad&&c.enableEnhancedScrolling&&g.scrollIntentManager&&g.scrollIntentManager.shouldAutoScroll()&&ScrollUtils.scrollToBottom(c.scrollableElement,h,50,"smooth"),o}:null,onComplete:async(a,e,t)=>{if(activeStreamingServices.delete(n.id),g.chatInput&&g.chatInput.showGoBtn(),renderMessageActions(m,a,{showCopy:c.showCopy,showEdit:c.showEdit,showFork:c.showFork,showNote:c.showNote,showCodeOptions:c.showCodeOptions,showInsights:c.showInsights,showTryAgain:c.showTryAgain,showTrash:c.showTrash,isNotesModel:l.match(new RegExp(MODEL_CONSTANTS.GITSENSE_NOTES))},{widget:g.widget,chat:g.chat,mainModel:l,settings:g.settings,allModels:Object.keys(r).sort(),model2Messages:r,contentBody:i,messageStateManager:g.messageStateManager,messageBodies:g.messageBodies},S),DomUtils.addClipboards(i),CodeBlock.addPreFoldLinks(i,a,g.messageStateManager,g.hljs),w(g.messageBodies),c.scrollToBottomOnLoad&&c.enableEnhancedScrolling&&g.scrollIntentManager&&g.scrollIntentManager.shouldAutoScroll()&&ScrollUtils.scrollToBottom(c.scrollableElement,h,50,"smooth"),d.onStreamMessageComplete){let e=(new Date).getTime()+1500,t="Post processing",s=DomUtils.h.createDiv({text:t}),o=()=>{(new Date).getTime()>=e?(s&&s.parentNode&&s.remove(),d.onStreamMessageComplete(a)):(t+=" .",s&&(s.textContent=t),setTimeout(o,200))};o()}},onError:e=>{console.error("Streaming error:",e),activeStreamingServices.delete(n.id),addErrorElement(i,"Streaming error: "+e.message),(async(e,t)=>{n.message=e.message,g.chatInput&&g.chatInput.showGoBtn(),renderMessageActions(m,n,{showCopy:c.showCopy,showEdit:c.showEdit,showFork:c.showFork,showNote:c.showNote,showCodeOptions:c.showCodeOptions,showInsights:c.showInsights,showTryAgain:c.showTryAgain,showTrash:c.showTrash,isNotesModel:l.match(new RegExp(MODEL_CONSTANTS.GITSENSE_NOTES))},{widget:g.widget,chat:g.chat,mainModel:l,settings:g.settings,allModels:Object.keys(r).sort(),model2Messages:r,contentBody:i,messageStateManager:g.messageStateManager,messageBodies:g.messageBodies},S);var e=e.message,s=((state=g.renderedMessage[n.id]).cleanedContent=e.replace(/\n\nAuthored by LLM.+$/,""),e.includes("(chat-id: ")),o=e.includes(" Block-UUID: "),e=e.includes("# GitSense Chat Tool\n\n{");if((s=s||o||e)||(state.md5=crypto.createHash("md5").update(state.cleanedContent).digest("hex"),DomUtils.addClipboards(i),CodeBlock.addPreFoldLinks(i,n,g.messageStateManager,g.hljs)),w(g.messageBodies),c.scrollToBottomOnLoad&&c.enableEnhancedScrolling&&g.scrollIntentManager&&g.scrollIntentManager.shouldAutoScroll()&&ScrollUtils.scrollToBottom(c.scrollableElement,h,50,"smooth"),d.onStreamMessageComplete)if(t){let e=(new Date).getTime()+1500,t="Post processing",s=DomUtils.h.createDiv({text:t}),o=()=>{(new Date).getTime()>=e?(s.remove(),s=null,d.onStreamMessageComplete(n)):(t+=" .",s.textContent=t,setTimeout(o,200))};o()}else d.onStreamMessageComplete(n)})(n)}});activeStreamingServices.set(n.id,s),s.startStreaming(c.scrollToBottomOnLoad,c.scrollableElement),d.onStopStreaming&&d.onStopStreaming(()=>{activeStreamingServices.has(n.id)&&activeStreamingServices.get(n.id).stopStream()})}function stopAllStreaming(){activeStreamingServices.forEach((e,t)=>{e.stopStream()})}module.exports={handleMessageStreaming:handleMessageStreaming,stopAllStreaming:stopAllStreaming};
