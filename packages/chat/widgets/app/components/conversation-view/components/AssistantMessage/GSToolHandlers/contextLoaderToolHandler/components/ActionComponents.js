/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let{ChatUtils,MessageUtils,ContextUtils,GSToolBlockUtils}=require("@gitsense/gsc-utils"),DomUtils=require("../../../../../utils/DomUtils"),MessageService=require("../../../../../services/MessageService"),{ACTION_TYPES,DEFAULT_CONTENT_TYPE,DEFAULT_CONTENT_OPTION,NO_SELECTED_ITEMS}=require("../constants"),{updateChatMessage,QuickChatButtons}=require("../../../../../Dependencies");function disableAction(e){void 0!==e.disabled&&e.disabled||(e.disabled=!0,"link"===e.type?(e.style.pointerEvents="none",e.style.color="gray"):e.classList.add("disabled"))}function enableAction(e,t){void 0!==e.disabled&&!e.disabled||(e.disabled=!1,"link"===e.type?(e.style.pointerEvents=null,e.style.color=null):e.classList.remove("disabled"))}function createAction(e,t){var n,a,o,s,i,r,l;if(Object.values(ACTION_TYPES).includes(e))return{message:t,config:n,filter:a,registeredCallback:o,cleanup:s,context:i,contextLoader:r,elemType:l="button"}=t,e===ACTION_TYPES.LOAD?_createLoadAction(t,n,a,o,s,i,r,l):e===ACTION_TYPES.BOOKMARK?_createBookmarkAction(n,i,l):e===ACTION_TYPES.COPY?_createCopyAction(n,a,o,i,l):e===ACTION_TYPES.PASTE?_createPasteAction(t,n,i,r,l,s):e===ACTION_TYPES.MERGE_IMPORTED||e===ACTION_TYPES.MERGE_WORKING?_createMergeAction(t,e,n,i,l):e===ACTION_TYPES.DELETE_CONTEXTS?_createDeleteContextsAction(t,n,i,l):_createChatAction(e,n,a,s,i,l);throw new Error("Unrecognized action type "+e)}function _createLoadAction(l,c,i,r,d,p,h,e="button"){var t=c.actions.load||{};let u=null==t.showAdd||t.showAdd;var n=t.text||"Load selected",t="button"===e?DomUtils.h.createButton({cls:t.className||"btn btn-primary",text:n,style:{marginBottom:"5px",marginRight:"10px"}}):DomUtils.h.createLink({text:n,href:"#",style:{}});return t.type=e,(c.chatIds?enableAction:disableAction)(t),t.onclick=e=>{e.preventDefault();e=MessageUtils.isContextMessage(l.message);let n=DEFAULT_CONTENT_TYPE,a=DEFAULT_CONTENT_OPTION;if(!i&&e){let[e,t]=l.message.split("\n").shift().toLowerCase().replace("## ","").split(" - ");e&&t&&(n=e,a=t)}let[t,o]=i?i.api.getInputValues()?.content?.split("::"):[n,a],s=null;if(c.chatIds)s=c.chatIds;else{e=r().filteredNodes;if(0===e.length)return;s=e.map(e=>e.id)}p.showContextBuilder(s,t,o,"review",{showAdd:u,onclickAdd:u?async(t,e)=>{var n,a,o,s,{widget:i,chat:r}=p;c.chatIds&&(c.chatIds=e.map(e=>e.id)),t+="\n```txt\n# GitSense Chat Tool\n\n"+JSON.stringify(h,null,2)+"\n```\n",u?(a=(e=ChatUtils.getChatMessages(r))[e.length-1],{role:e,model:s,real_model:o,temperature:n=0}=e.filter(e=>"assistant"===e.role).pop(),a={type:"context",parentId:a.id,model:o||s||r.main_model,role:e,temperature:n,stream:!1,message:t},await MessageService.newChatMessage(i,r.id,a)):({postLoadTools:o=[],postLoad:s={}}=c,s.show&&s.actions&&(c.actions=s.actions),o.forEach(e=>{t+="\n```txt\n# GitSense Chat Tool\n\n"+JSON.stringify(e,null,2)+"\n```\n"}),await updateChatMessage(p.widget,l.id,null,t),d(),delete(p.renderedMessage[l.id]?.gitsenseChatTools||{}).contextLoader),p.updateChat()}:null})},t}function _createCopyAction(n,a,o,e,t="button"){var s=n.actions.copy||{},i=s.text||"Copy context";let r="button"===t?DomUtils.h.createButton({cls:s.className||"btn btn-secondary",text:i,style:{marginBottom:"5px",marginRight:"10px"}}):DomUtils.h.createLink({text:i,href:"#",style:{}});return r.type=t,disableAction(r),r.onclick=async t=>{if(t.preventDefault(),!n.chatIds||0===n.chatIds.length){console.warn("Copy action clicked but no chatIds are configured.");t=o().filteredNodes;if(0===t.length)return void console.warn("No items selected or filtered to copy.");n.chatIds=t.map(e=>e.id)}var[t,e]=a?a.api.getInputValues()?.content?.split("::"):[DEFAULT_CONTENT_TYPE,DEFAULT_CONTENT_OPTION],t=`GitSense Chat Context

{
   "chatIds": [ ${n.chatIds.join(",")} ],
   "contentType": "${t}",
   "contentOption": "${e}"
}`;try{await navigator.clipboard.writeText(t);let e=r.innerText;r.innerText="Copied!",setTimeout(()=>{r.innerText=e},2e3)}catch(e){console.error("Failed to copy context: ",e),alert("Failed to copy context to clipboard.")}},r}function _createPasteAction(i,r,l,c,e="button",d){var t=r.actions.paste||{},n=t.text||"Paste context",t="button"===e?DomUtils.h.createButton({cls:t.className||"btn btn-secondary",text:n,style:{marginBottom:"5px",marginRight:"10px"}}):DomUtils.h.createLink({text:n,href:"#"});return t.type=e,enableAction(t),t.onclick=async e=>{e.preventDefault();try{var t=(await navigator.clipboard.readText()).match(/^GitSense Chat Context\s*\n(\{[\s\S]*\})$/);if(!t||t.length<2)openPasteModal(l,r);else{var n=t[1];let e;try{e=JSON.parse(n)}catch(e){return console.debug(n),console.error("JSON parse error:",e),void openPasteModal(l,r)}var{chatIds:a,contentType:o,contentOption:s}=e;Array.isArray(a)&&a.every(e=>"number"==typeof e)&&"string"==typeof o&&"string"==typeof s?l.showContextBuilder(a,o,s,"review",{onclickAdd:async(t,e)=>{var{}=l,{postLoadTools:n=[],postLoad:a={}}=r;a.show&&(a.actions&&(r.actions=a.actions),t+="\n```txt\n# GitSense Chat Tool\n\n"+JSON.stringify(c,null,2)+"\n```\n"),n.forEach(e=>{t+="\n```txt\n# GitSense Chat Tool\n\n"+JSON.stringify(e,null,2)+"\n```\n"}),await updateChatMessage(l.widget,i.id,null,t);d(),delete(l.renderedMessage[i.id]?.gitsenseChatTools||{}).contextLoader,l.updateChat()}}):openPasteModal(l,r)}}catch(e){console.error("Failed to read clipboard content: ",e),openPasteModal(l,r)}},t}function openPasteModal(o,e){let t=DomUtils.h.createDiv({style:{position:"fixed",top:0,left:0,width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.5)",display:"flex",justifyContent:"center",alignItems:"center",zIndex:1e7}});var n=DomUtils.h.createDiv({style:{backgroundColor:"#fff",padding:"20px",borderRadius:"5px",boxShadow:"0 2px 10px rgba(0, 0, 0, 0.1)",width:"400px",height:"300px",display:"flex",flexDirection:"column"}});let s=DomUtils.h.createTextArea({placeholder:"Paste copied context here...",style:{width:"100%",height:"100%",padding:"10px",border:"1px solid #ccc",borderRadius:"4px",resize:"none",boxSizing:"border-box"}}),i=(n.appendChild(s),t.appendChild(n),document.body.appendChild(t),s.focus(),()=>{document.body.removeChild(t),document.removeEventListener("keydown",a),t.removeEventListener("click",r)}),a=e=>{"Escape"===e.key&&i()},r=e=>{e.target===t&&i()};s.addEventListener("paste",async e=>{setTimeout(()=>{var t=s.value.match(/^GitSense Chat Context\s*\n(\{[\s\S]*\})$/);if(!t||t.length<2)alert("Pasted content does not match the expected GitSense Chat Context format.");else{t=t[1];let e;try{e=JSON.parse(t)}catch(e){return console.debug(t),console.error("JSON parse error:",e),void alert("Failed to parse pasted content as JSON.")}var{chatIds:t,contentType:n,contentOption:a}=e;Array.isArray(t)&&t.every(e=>"number"==typeof e)&&"string"==typeof n&&"string"==typeof a?(i(),o.showContextBuilder(t,n,a,"review")):alert("Pasted content has an invalid structure for GitSense Chat Context.")}},0)}),document.addEventListener("keydown",a),t.addEventListener("click",r)}function _createChatAction(o,s,i,e,r,t="button"){var n=s.actions.ask||{},a=s.actions.plan||{},l=s.actions.code||{},l=o===ACTION_TYPES.CODE?l:o===ACTION_TYPES.ASK?n:o===ACTION_TYPES.PLAN?a:null;if(l)return(n="button"===t?DomUtils.h.createButton({cls:l.className||"btn btn-primary",text:l.text,style:{marginBottom:"5px",marginRight:"10px"}}):DomUtils.h.createLink({href:"#",text:l.text})).onclick=e=>{e.preventDefault();let n=s.chatIds?[]:null;if(s.chatIds){let t=[];if(s.chatIds.forEach(e=>{e=r.findNode(e);(e?n:t).push(e)}),t.length)throw new Error("No chat node with the ids found: "+t.join(","))}var[e,t]=i?i.api.getInputValues()?.content?.split("::"):[DEFAULT_CONTENT_TYPE,DEFAULT_CONTENT_OPTION];let a=DomUtils.h.createDiv({style:"display:none"});document.body.appendChild(a);e={type:o,params:{nodes:n,contentType:e,contentOption:t},onDone:()=>{a.remove()}},t=new QuickChatButtons([e],r);t.render(a),t.click(e)},n.type=t,disableAction(n),n;throw new Error(`No ${o} action config`)}function _createMergeAction(s,e,t,i,n="link"){var t=t.actions[e]||{},a=t.text||(e===ACTION_TYPES.MERGE_IMPORTED?"Merge and Update (Latest Imported)":"Merge and Update (Working Directory)");let r=e===ACTION_TYPES.MERGE_IMPORTED?"imported":"working directory";e="button"===n?DomUtils.h.createButton({cls:t.className||"btn btn-primary",text:a,style:{marginBottom:"5px",marginRight:"10px"}}):DomUtils.h.createLink({text:a,href:"#",style:{}});return e.type=n,enableAction(e,!0),e.onclick=async e=>{e.preventDefault();let o=ChatUtils.getChatMessages(i.chat),t=new Set;o.forEach(e=>{MessageUtils.isContextMessage(e.message)&&ContextUtils.extractContextSections(e.message).forEach(e=>{e=e["chat id"];e&&t.add(e)})});e=Array.from(t);i.showContextBuilder(e,DEFAULT_CONTENT_TYPE,r,"review",{onclickAdd:async(e,t)=>{var n=i.chat,a=o.filter(e=>!MessageUtils.isContextMessage(e.message)),t={tool:"context-loader",config:{container:{style:{borderTop:"1px solid #ddd",paddingTop:"20px",marginTop:"20px"}},actions:{load:{type:"link",text:"Review, load, and add",showCopy:!0,showSave:!0},copy:{type:"link"},paste:{type:"link"}},postLoad:{show:!0},showManage:!0,chatIds:t.map(e=>e.id)}},t=(e+="\n\n```txt\n"+GSToolBlockUtils.formatToolBlock(t)+"\n```",a.push({role:"assistant",message:e}),o.find(e=>"assistant"===e.role)),e=t?t.temperature:0,t={name:n.name,parentId:n.parent_id,groupId:n.group_id,prompt:n.prompt,model:n.main_model,temperature:e,messages:a},e=await MessageService.newChat(i.widget,t),a=[{id:n.id,parentId:e.id,name:`Before Delete Context (msg-id: ${s.id}): `+n.name}],t=await MessageService.updateChats(i.widget,a);t.success||console.error(t.error),MessageService.setChat(e)}})},e}function _createDeleteContextsAction(s,e,i,t="link"){var e=e.actions[ACTION_TYPES.DELETE_CONTEXTS]||{},n=e.text||"Delete All Except Last Context",n="button"===t?DomUtils.h.createButton({cls:e.className||"btn btn-danger",text:n,style:{marginBottom:"5px",marginRight:"10px"}}):DomUtils.h.createLink({text:n,cls:e.queryClass||null,href:"#"});return n.type=t,enableAction(n,!0),n.onclick=async(e,t)=>{e.preventDefault();e=ChatUtils.getChatMessages(i.chat);let n=e.filter(e=>MessageUtils.isContextMessage(e.message)).pop().id;var a=e.filter(e=>{var t=MessageUtils.isContextMessage(e.message);if(!t||e.id===n)return e}),o=i.chat,e=e.find(e=>"assistant"===e.role),e=e?e.temperature:0,e={name:o.name,type:o.type,parentId:o.parent_id,groupId:o.group_id,model:o.main_model,temperature:e,messages:a},a=await MessageService.newChat(i.widget,e),e=[{id:o.id,parentId:a.id,name:`Before Delete Previous Contexts (msg-id: ${s.id}): `+o.name}],o=await MessageService.updateChats(i.widget,e);o.success||console.error(o.error),t&&"function"==typeof t?t(a):MessageService.setChat(a)},n}module.exports={enableAction:enableAction,disableAction:disableAction,createAction:createAction};
