/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let crypto=require("crypto"),{ChatUtils,ConfigUtils,GSToolBlockUtils}=require("@gitsense/gsc-utils"),{QuickChatButtons,getScheduledBatchProviders,createAnalyzeBatchJob,ConfirmationBox}=require("../../../../../Dependencies"),MessageService=require("../../../../../services/MessageService"),DomUtils=require("../../../../../utils/DomUtils"),getTokens=require("../utils/Tokens.js").getTokens,BATCH_NOT_INSTALLED_ERROR="Enterprise batch component not installed";function AnalyzeGroupsBuilder(A,I,e,t,a,E){let L=e+`::${t}::`+a,z=null,D=[],U=[],s=null,P=null,R=new ConfirmationBox,G=null;function N(e){e.innerHTML="";var t=DomUtils.h,a=t.createH3({text:"Batch"}),a=(e.appendChild(a),t.createParagraph({html:"<strong>Batch Creation Unavailable:</strong> Your request to create a batch analysis job could not be completed. This feature requires the GitSense Chat Enterprise Batch Processing Component, which is currently not installed or configured. Please contact your GitSense administrator for assistance with enabling this functionality.",style:{padding:"10px",backgroundColor:"#fff3cd",border:"1px solid #ffeeba",borderRadius:"4px",color:"#856404",marginTop:"15px"}}));e.appendChild(a)}async function $(t,a,n,i){var r=n.chat.main_model,o=n.chat.id,a=a.map(e=>({id:e.id,chatIds:e.items.map(e=>e.id),totalTokens:e.totalTokens})),s={temperature:0},l=await createAnalyzeBatchJob(n.widget,{analyzerId:L,modelName:r,batchGroupsPayload:a,batchOptions:s,triggerChatId:o,batchType:t});if(!l||l.error||!l.batchJobId){if(l.error)throw new Error(l.error);throw new Error("Failed to get batchJobId from backend: ",l.error)}if(l.triggerChatId!==n.chat.id)p=G,h=l.triggerChatUuid,p.innerHTML="",d=DomUtils.h,c=d.createH3({text:"Batch"}),p.appendChild(c),c=d.createParagraph({html:`<strong>Active Batch Job Detected:</strong> An analysis batch job with the same groups is already active. You can monitor its status by visiting the <a href="/?chat=${h}" target="_blank" style="color: #007bff; text-decoration: underline;">original chat</a>.`,style:{padding:"10px",backgroundColor:"#e0f7fa",border:"1px solid #b2ebf2",borderRadius:"4px",color:"#006064",marginTop:"15px"}}),p.appendChild(c);else{var c,{batchJobId:d,status:h}=l,p={tool:"analyze-batch-job",config:{batchJobId:d,batchType:t,statusUpdateInterval:"scheduled"===t?3e4:5e3,analyzerId:L,modelName:r,originalGroups:a,options:s,triggerChatId:o,initialBackendStatus:h}};let e=`# Analyze Batch #${d}

### \`${L}\`

**Status:** Pending

Your batch analysis job (ID: ${d}) has been successfully submitted. This chat will automatically update with its progress. You can revisit this chat at any time for the latest status. (A dedicated 'Batches' view will be available in the future for tracking all jobs.)
`;"scheduled"===t&&(e+=`Your scheduled batch job is awaiting external LLM provider creation. This typically takes a few minutes.
`),e+="\n```txt\n"+GSToolBlockUtils.formatToolBlock(p)+"\n```\n",await MessageService.updateChatMessage(n.widget,i,{newType:"analyze-batch",newMessage:e}),setTimeout(()=>{n.updateChat()},500)}}this.update=(e={})=>{var t,a,n,{options:i={},contentType:h,contentOption:p}=e,e=((e,t)=>{let a=e.map(e=>e.id).sort(),n=[];return Object.entries(t).forEach(([e,t])=>n.push(e+":"+t)),n.sort(),crypto.createHash("sha256").update(JSON.stringify(a)+JSON.stringify(n)).digest("hex")})(z=e.items?e.items:z,i);if(s===e)return{groups:D,ungroupable:U};try{var l=i.committed||"any-time",c=i["min-item-size"],d=i["max-context-tokens"],u=i["batch-size"],r=i["auto-save"],o=i["max-tracking-time"]||3e5;if(!d||!u)throw new Error("AnalyzeGroupsBuilder: No maxContextTokens or batchSize defined");{var g=z;var m=h;var b=p;var y=u;var f=c;var w=d;var T=l;if(isNaN(y))throw new Error(`Unexpected non number '${y}' for batch size`);y=parseInt(y);let r="any-time"===T?0:parseInt((new Date).getTime()/1e3)-(e=>{if(!e||"string"!=typeof e||!e.startsWith("lte-"))throw new Error(`Invalid value string format "${e}".`);var t=(e=e.substring(4)).match(/^(\d+)([smhdw]|mth|y)?$/);if(!t)return console.error("Could not parse time part: "+e),null;let a=parseInt(t[1],10),n=t[2]||"s",i;switch(n){case"s":i=a;break;case"m":i=60*a;break;case"h":i=60*a*60;break;case"d":i=60*a*60*24;break;case"w":i=60*a*60*24*7;break;case"mth":i=60*a*60*24*30;break;case"y":i=60*a*60*24*365;break;default:return console.error("Unknown time unit: "+n),null}return i})(T),o=(f="unlimited"===f?-1:parseInt(f.split("-").pop()),w="unlimited"===w?-1:parseInt(w.split("-").pop()),D=[],U=[],[]),s={};if(g.forEach(e=>{var t=e?.meta?.size||0,a=e?.meta?.commit?.timestamp||0,n=getTokens(e,m,b);let i=-1!==w&&w<n?!1:t<f?!1:!0;((i=T&&a<r?!1:i)?o:U).push(e),s[e.id]=n}),0!==o.length){let a={totalTokens:0,items:[]};o.forEach(e=>{var t=s[e.id];(a.totalTokens+t>w||a.items.length===y)&&(D.push(a),a={totalTokens:0,items:[]}),a.totalTokens+=t,a.items.push(e)}),a.items.length&&D.push(a);for(let e=0;e<D.length;e++)D[e].id=e+1}}if(0===z.length)I.innerHTML="",I.style.display="none",P?.elem&&P.elem.remove(),G&&(G.remove(),G=null),P=null;else if(I.style.display=null,I.innerHTML="",U.length&&(t=U,D.length,a=DomUtils.h,n=1===t.length?"":"s",t=a.createSpan({text:"Analyze settings excluded "+t.length+" item"+n,style:{border:"1px solid #FF9800",backgroundColor:"#FFF3E0",color:"#212121",borderRadius:"3px",padding:"3px 5px",fontSize:".95em"}}),n=a.createDiv({append:[t],style:{marginTop:"15px"}}),I.appendChild(n)),D.length){{var C=D;var v=h;var x=p;var k=u;var B=r;var S=o;let l=[{id:"group",label:"#",width:"20px"},{id:"status",label:"Status",width:"100%",textAlign:"left"},{id:"items",label:"Items",width:"50px"},{id:"tokens",label:"Tokens",width:"100px"}],c=DomUtils.h,e=c.createTableHead(),d=c.createTableBody(),t=c.createTable({append:[e,d],style:{width:"100%",tableLayout:"fixed",borderCollapse:"collapse",marginTop:"8px"}});I.appendChild(DomUtils.h.createDiv({text:"Analysis will automatically start in a new browser tab.",style:{fontSize:".95em",marginTop:"20px"}})),I.appendChild(t);{let n=c.createTableRow();e.appendChild(n),l.forEach(e=>{var{label:e,width:t,textAlign:a}=e,e=c.createTableHeadCell({text:e,style:{width:t,textAlign:a}});n.appendChild(e)})}(function a(n=0,i=20){let r=n+i>C.length?C.length:n+i;for(let e=n;e<r;e++){let i=C[e],{totalTokens:r,items:o}=i;if(0===i.items.length)throw new Error(`Group ${i.id} contains no itemsn`);let s=c.createTableRow();d.appendChild(s),l.forEach((e,t)=>{var a=e.id,n=c.createTableCell({});if(s.appendChild(n),"group"===a)n.textContent=i.id;else if("status"===a)n.appendChild((n=>{if(0===n.items.length)throw new Error(`Group ${n.id} has no items`);let i=c.createLink({text:"Start analysis",href:"#",onclick:async e=>{if(!i.href.match("#"))return;e.preventDefault();let t=c.createDiv({style:"display:none"}),a=(document.body.appendChild(t),e={type:"analyze",params:{nodes:n.items,name:"Analyze Group "+n.id,model:E.chat.main_model,analyzerId:L,contentType:v,contentOption:x,batchSize:k,autoSave:B,goLabel:"Create",goOnReady:!0,contextLoadingTitle:"Loading context...",contextLoadedTitle:"Context",onDone:e=>{i.target="_blank",i.style.color="black",i.style.fontWeight=500,i.href="/?chat="+e.uuid,i.innerText=`Click to start group ${n.id} analysis in a new tab`,t.remove(),a=null,i.onclick=()=>{i.innerText="Started analysis in a new tab.",B&&(i.innerText+=" Starting tracker in 2 seconds.",setTimeout(()=>{!async function t(a,i,r,o){o=o||(new Date).getTime();let e=(new Date).getTime(),s=((e-o)/1e3).toFixed(1);if(e>o+r)i.innerText=`URGENT: Unable to determine analysis status after ${s} seconds`;else{a=await MessageService.getChat(E.widget,a.uuid);let e=ChatUtils.getChatMessages(a).pop(),n=e.message||"";if(n.startsWith("### Status")){let e=n.includes("Analysis successful"),t=n.includes("Analysis failed"),a=n.includes("Auto save successful");a?(i.innerText="Successfully saved analysis. Hiding row in 2 seconds.",i.style.color="green",setTimeout(()=>{i.parentNode.parentNode.style.display="none"},2e3)):t?(i.innerText="Analysis failed. Click to reset tracking.",i.style.color="red"):e?(i.innerText="Analysis finished. Switch to the analyze chat window to save.",i.style.fontWeight="bold",i.style.color="green"):new new Error("Analyze chat contains a scenerio we have not considered.")}else i.innerText=`Tracking for ${s} seconds. Checking again in 2 seconds.`,setTimeout(()=>{t(a,i,r,o)},2e3)}}(e,i,S)},2e3))},i.click()}}},new QuickChatButtons([e],E));a.render(t),a.click(e)}});return i})(i));else if("items"===a)n.textContent=o.length;else{if("tokens"!==a)throw new Error(`AnalyzeGroupsBuilder: Unrecognized column ID: "${e.id}"`);n.textContent=r}})}if(r!==C.length){n=C.length-r;let t=c.createTableRow();var e=c.createTableCell({colSpan:l.length,style:{backgroundColor:"white",border:"0px",paddingTop:"15px",textAlign:"center",fontWeight:600}}),n=c.createLink({text:`Show ${n<i?"all":r+i+" of "+C.length} groups`,href:"#",onclick:e=>{e.preventDefault(),t.remove(),a(r,i)}});d.appendChild(t),t.appendChild(e),e.appendChild(n)}})(0,5)}(async t=>{let e=await getScheduledBatchProviders(E.widget),a=e.providers||[],n=!e.error||"Enterprise batch component not installed"!==e.error,i=ConfigUtils.getProviderForModel(E.settings,E.chat.main_model)||{},r=a.find(e=>e===i.name),o=DomUtils.h,s=(G=o.createDiv({style:{marginTop:"20px"}}),I.appendChild(G),o.createH3({text:"Batch"})),l=(G.appendChild(s),o.createParagraph({text:"Create a batch to queue groups for analysis. Choose 'cost saving' for jobs that leverage LLM batch APIs, offering lower per-token costs with a typical turnaround of 24 hours or less. Select 'immediate' for faster processing using real-time LLM APIs, providing quicker results for urgent analyses."})),c=(G.appendChild(l),o.createLink({text:"Create cost saving batch",href:"#",cls:"btn btn-outline "+(n?"":"disabled"),style:{marginRight:"10px",pointerEvents:n&&r?null:"none",color:n&&r?null:"#aaa"}})),d=(G.appendChild(c),o.createLink({text:"Create immediate batch",href:"#",cls:"btn btn-outline "+(n?"":"disabled"),style:{pointerEvents:n?null:"none",color:n?null:"#aaa"}}));var h;G.appendChild(d),n?r||(h=o.createParagraph({html:`<strong>Provider Limitation</strong><br>Cost-saving batch processing is either not supported by "${i.name}" or is not yet implemented within GitSense Chat. Please select immediate batch processing or create a new analysis with one of the following supported providers: ${a.join(", ")}
`,style:{marginTop:"15px",color:"#555"}}),G.appendChild(h)):(h=o.createParagraph({html:"<strong>Not Available</strong><br>Batch analysis requires the GitSense Enterprise Batch Processing Component to be installed and configured on your server. Please contact your GitSense administrator for assistance with enabling this functionality.",style:{marginTop:"15px",color:"#555"}}),G.appendChild(h)),c.onclick=async e=>{e.preventDefault(),R.show({title:"Confirm Cost Saving Batch Creation",message:"This operation will create a cost-saving batch job. This can be a costly operation if there are many files and typically takes 24 hours or less. Are you sure you want to proceed?",confirmButtonText:"Create Cost Saving Batch",cancelButtonText:"Cancel",confirmButtonLoadingText:"Creating Cost Saving Batch..."},async()=>{try{await $("scheduled",t,E,A.id)}catch(e){throw console.error("Failed to create cost saving batch:",e),e.message===BATCH_NOT_INSTALLED_ERROR?N(G):alert("Failed to create cost saving batch: "+e.message),e}})},d.onclick=async e=>{e.preventDefault(),R.show({title:"Confirm Immediate Batch Creation",message:"This operation will create an immediate batch job. This can be a costly operation if there are many files and provides quicker results. Are you sure you want to proceed?",confirmButtonText:"Create Immediate Batch",cancelButtonText:"Cancel",confirmButtonLoadingText:"Creating Immediate Batch..."},async()=>{try{await $("realtime",t,E,A.id)}catch(e){throw console.error("Failed to create immediate batch:",e),e.message===BATCH_NOT_INSTALLED_ERROR?N(G):alert("Failed to create immediate batch: "+e.message),e}})}})(D)}return s=e,{groups:D,ungroupable:U}}catch(e){console.error("Failed to update analyze builder groups: "+e.message)}}}module.exports=AnalyzeGroupsBuilder;
