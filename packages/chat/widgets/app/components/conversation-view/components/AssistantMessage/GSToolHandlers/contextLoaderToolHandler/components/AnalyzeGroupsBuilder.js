/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let crypto=require("crypto"),ChatUtils=require("@gitsense/gsc-utils").ChatUtils,QuickChatButtons=require("../../../../../Dependencies").QuickChatButtons,MessageService=require("../../../../../services/MessageService"),DomUtils=require("../../../../../utils/DomUtils"),getTokens=require("../utils/Tokens.js").getTokens;function AnalyzeGroupsBuilder(S,A,D,E,U){let $=null,I=[],B=[],G=null,L=null;this.update=(e={})=>{var t,n,a,{options:i={},contentType:d,contentOption:c}=e,e=((e,t)=>{let n=e.map(e=>e.id).sort(),a=[];return Object.entries(t).forEach(([e,t])=>a.push(e+":"+t)),a.sort(),crypto.createHash("sha256").update(JSON.stringify(n)+JSON.stringify(a)).digest("hex")})($=e.items?e.items:$,i);if(G===e)return{groups:I,ungroupable:B};try{var o=i.committed||"any-time",u=i["min-item-size"],p=i["max-context-tokens"],h=i["batch-size"],r=i["auto-save"],s=i["max-tracking-time"]||3e5;if(!p||!h)throw new Error("AnalyzeGroupsBuilder: No maxContextTokens or batchSize defined");{var m=$;var g=d;var y=c;var f=h;var b=u;var w=p;var x=o;if(isNaN(f))throw new Error(`Unexpected non number '${f}' for batch size`);f=parseInt(f);let r="any-time"===x?0:parseInt((new Date).getTime()/1e3)-(e=>{if(!e||"string"!=typeof e||!e.startsWith("lte-"))throw new Error(`Invalid value string format "${e}".`);var t=(e=e.substring(4)).match(/^(\d+)([smhdw]|mth|y)?$/);if(!t)return console.error("Could not parse time part: "+e),null;let n=parseInt(t[1],10),a=t[2]||"s",i;switch(a){case"s":i=n;break;case"m":i=60*n;break;case"h":i=60*n*60;break;case"d":i=60*n*60*24;break;case"w":i=60*n*60*24*7;break;case"mth":i=60*n*60*24*30;break;case"y":i=60*n*60*24*365;break;default:return console.error("Unknown time unit: "+a),null}return i})(x),s=(b="unlimited"===b?-1:parseInt(b.split("-").pop()),w="unlimited"===w?-1:parseInt(w.split("-").pop()),I=[],B=[],[]),l={};if(m.forEach(e=>{var t=e?.meta?.size||0,n=e?.meta?.commit?.timestamp||0,a=getTokens(e,g,y);let i=-1!==w&&w<a?!1:t<b?!1:!0;((i=x&&n<r?!1:i)?s:B).push(e),l[e.id]=a}),0!==s.length){let n={totalTokens:0,items:[]};s.forEach(e=>{var t=l[e.id];(n.totalTokens+t>w||n.items.length===f)&&(I.push(n),n={totalTokens:0,items:[]}),n.totalTokens+=t,n.items.push(e)}),n.items.length&&I.push(n)}}if(0===$.length)S.innerHTML="",S.style.display="none",L?.elem&&L.elem.remove(),L=null;else if(S.style.display=null,S.innerHTML="",B.length&&(t=B,I.length,n=DomUtils.h,a=1===t.length?"":"s",t=n.createSpan({text:"Analyze settings excluded "+t.length+" item"+a,style:{border:"1px solid #FF9800",backgroundColor:"#FFF3E0",color:"#212121",borderRadius:"3px",padding:"3px 5px",fontSize:".95em"}}),a=n.createDiv({append:[t],style:{marginTop:"15px"}}),S.appendChild(a)),I.length){var l=I;var T=d;var k=c;var v=h;var C=r;var z=s;let t=[{id:"group",label:"#",width:"20px"},{id:"status",label:"Status",width:"100%",textAlign:"left"},{id:"items",label:"Items",width:"50px"},{id:"tokens",label:"Tokens",width:"100px"}],o=DomUtils.h,e=o.createTableHead(),n=o.createTableBody(),a=o.createTable({append:[e,n],style:{width:"100%",tableLayout:"fixed",borderCollapse:"collapse",marginTop:"8px"}});S.appendChild(DomUtils.h.createDiv({text:"Analysis will automatically start in a new browser tab.",style:{fontSize:".95em",marginTop:"20px"}})),S.appendChild(a);{let a=o.createTableRow();e.appendChild(a),t.forEach(e=>{var{label:e,width:t,textAlign:n}=e,e=o.createTableHeadCell({text:e,style:{width:t,textAlign:n}});a.appendChild(e)})}l.forEach((i,e)=>{let{totalTokens:r,items:s}=i;if(i.id=e+1,0===i.items.length)throw new Error(`Group ${i.id} contains no itemsn`);let l=o.createTableRow();n.appendChild(l),t.forEach((e,t)=>{var n=e.id,a=o.createTableCell({});if(l.appendChild(a),"group"===n)a.textContent=i.id;else if("status"===n)a.appendChild((a=>{if(0===a.items.length)throw new Error(`Group ${a.id} has no items`);let i=o.createLink({text:"Start analysis",href:"#",onclick:async e=>{if(!i.href.match("#"))return;e.preventDefault();let t=o.createDiv({style:"display:none"});document.body.appendChild(t);e={type:"analyze",params:{nodes:a.items,name:"Analyze Group "+a.id,model:U.chat.main_model,uniqueAnalyzerId:A+`::${D}::`+E,contentType:T,contentOption:k,batchSize:v,autoSave:C,goLabel:"Create",goOnReady:!0,contextLoadingTitle:"Loading context...",contextLoadedTitle:"Context",onDone:e=>{i.target="_blank",i.style.color="black",i.style.fontWeight=500,i.href="/?chat="+e.uuid,i.innerText=`Click to start group ${a.id} analysis in a new tab`,t.remove(),n=null,i.onclick=()=>{i.innerText="Started analysis in a new tab.",C&&(i.innerText+=" Starting tracker in 2 seconds.",setTimeout(()=>{!async function e(t,a,n,i){i=i||(new Date).getTime();let r=(new Date).getTime();let s=((r-i)/1e3).toFixed(1);if(r>i+n)return void(a.innerText=`URGENT: Unable to determine analysis status after ${s} seconds`);t=await MessageService.getChat(U.widget,t.uuid);let l=ChatUtils.getChatMessages(t).pop();let o=l.message||"";if(o.startsWith("### Status")){let e=o.includes("Analysis successful"),t=o.includes("Analysis failed"),n=o.includes("Auto save successful");n?(a.innerText="Successfully saved analysis. Hiding row in 2 seconds.",a.style.color="green",setTimeout(()=>{a.parentNode.parentNode.style.display="none"},2e3)):t?(a.innerText="Analysis failed. Click to reset tracking.",a.style.color="red"):e?(a.innerText="Analysis finished. Switch to the analyze chat window to save.",a.style.fontWeight="bold",a.style.color="green"):new new Error("Analyze chat contains a scenerio we have not considered.")}else a.innerText=`Tracking for ${s} seconds. Checking again in 2 seconds.`,setTimeout(()=>{e(t,a,n,i)},2e3)}(e,i,z)},2e3))},i.click()}}};let n=new QuickChatButtons([e],U);n.render(t),n.click(e)}});return i})(i));else if("items"===n)a.textContent=s.length;else{if("tokens"!==n)throw new Error(`AnalyzeGroupsBuilder: Unrecognized column ID: "${e.id}"`);a.textContent=r}})})}return G=e,{groups:I,ungroupable:B}}catch(e){console.error("Failed to update analyze builder groups: "+e.message)}}}module.exports=AnalyzeGroupsBuilder;
