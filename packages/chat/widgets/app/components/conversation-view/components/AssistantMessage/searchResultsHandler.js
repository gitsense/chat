/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let ChatUtils=require("@gitsense/gsc-utils").ChatUtils,DomUtils=require("../../utils/DomUtils");async function handleSearchResults(a,e,r,t){if(a.meta?.isSearchResultsHandled)return!0;if(!(a&&null!==a.message&&e&&r&&r.chat))return console.warn("handleSearchResults: Missing required parameters"),!1;var r=r.chat,l=a.message;if(!r.name||!r.name.match(/AI Search - \d+ - State: /))return!1;try{var n=ChatUtils.getChatMessages(r);if(!n||0===n.length)return!1;var s=n[0].message;if(!s||"string"!=typeof s||!s.trim().startsWith("{"))return!1;var i,d=JSON.parse(s).queries;if(!Array.isArray(d)||0===d.length||"object"!=typeof d[0]||null===d[0])return!1;if(!d[0].hasOwnProperty("type")||!d[0].hasOwnProperty("query"))return!1;let t=null;for(let e=0;e<n.length;e++)if(a.message===n[e].message){t=e;break}if(null===t)return console.warn("Unable to find the position for this message in this chat"),!1;if(0===t)i=DomUtils.h.createPre({text:JSON.stringify(JSON.parse(s),null,2),style:{padding:"15px"}}),e.innerHTML="",e.appendChild(i);else{if(!l||"string"!=typeof l||!l.trim().startsWith("{"))return!1;var p=JSON.parse(l);if("object"!=typeof p||null===p||!p.hasOwnProperty("searchCriteria"))return!1;e.innerHTML="";let o=DomUtils.h;var h={"tiny-overview":"Tiny Overview","short-overview":"Short Overview","direct-search":"Direct Search","meta-search":"Meta Search"},c=d[t-1],u=h[c.type],y=c.query||"N/A",f=p.totalResultsReturned||0,g=o.createH2({text:u+` Matches (${f})`,style:{marginTop:"10px"}}),m=(e.appendChild(g),o.createH3({text:"Query"})),C=(e.appendChild(m),o.createPre({append:[o.createCode({text:y})],style:{padding:"15px",borderRadius:"5px",overflowX:"auto",whiteSpace:"pre-wrap",wordWrap:"break-word",fontSize:".9em"}})),x=(e.appendChild(C),o.createH3({text:"Matches"})),b=(e.appendChild(x),p.results?.messages||[]);if(0===b.length)e.appendChild(o.createP({text:"No matches found."}));else{var v=o.createTable({style:{width:"100%",borderCollapse:"collapse",marginTop:"10px"}}),S=(e.appendChild(v),o.createTableHead()),w=(v.appendChild(S),o.createTableRow());S.appendChild(w),w.appendChild(o.createTableHeadCell({text:"Chat ID",style:{textAlign:"left",padding:"8px",borderBottom:"1px solid #ddd"}})),w.appendChild(o.createTableHeadCell({text:"Chat Path",style:{textAlign:"left",padding:"8px",borderBottom:"1px solid #ddd",width:"100%"}}));let d=o.createTableBody(),p=(v.appendChild(d),[]);if(b.forEach((t,e)=>{var e=10<=e,a=o.createTableRow({style:{borderBottom:"1px solid #eee",cursor:"pointer",display:e?"none":null}}),r=(d.appendChild(a),o.createTableCell({text:t.messages_chat_id||"N/A",style:{padding:"8px",fontWeight:"bold",color:"#007bff"}})),r=(a.appendChild(r),(t.chat_path||t.chats_name||"N/A").replace(/->/g,"/")),r=o.createTableCell({text:r,style:{padding:"8px"}});a.appendChild(r);let l=o.createTableRow({style:{display:"none",backgroundColor:"#f9f9f9"}});d.appendChild(l);var n,r=o.createTableCell({colSpan:2,style:{padding:"15px",borderTop:"1px solid #ddd"}}),s=(l.appendChild(r),o.createDiv());for(n in r.appendChild(s),t)if(t.hasOwnProperty(n)){let e=t[n];e="object"==typeof e&&null!==e?JSON.stringify(e,null,2):null===e?"null":void 0===e?"undefined":String(e);var i=o.createDiv({append:[o.createSpan({text:n+": ",style:{fontWeight:"bold"}}),o.createSpan({text:e})],style:{marginBottom:"5px"}});s.appendChild(i)}a.onclick=()=>{l.style.display="none"===l.style.display?null:"none"},e&&p.push(a)}),10<b.length){let t=o.createLink({href:"#",text:`Show More (${b.length-10} more)`,style:{marginTop:"15px",cursor:"pointer"},onclick:e=>{e.preventDefault(),p.forEach(e=>{e.style.display=null}),t.style.display="none"}});e.appendChild(t)}}}return a.meta||(a.meta={}),a.meta.isSearchResultsHandled=!0}catch(e){return console.error("Error handling search results message:",e),!1}}module.exports={handleSearchResults:handleSearchResults};
