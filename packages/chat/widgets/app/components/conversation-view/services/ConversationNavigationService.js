/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let ScrollUtils=require("../utils/ScrollUtils"),MessageUtils=require("../utils/MessageUtils");function ConversationNavigationService(r,e,l){if(!r)throw new Error("MessageStateManager is required");if(!l)throw new Error("Messages container element is required");this.messageStateManager=r,this.codeFoldingService=e,this.foldAllMessages=function(){try{var e=l.querySelectorAll(".gs-chat-user-message"),s=l.querySelectorAll(".gs-chat-assistant-message");let t={};return e.forEach(e=>{e.id&&(e=MessageUtils.getMsgStateId(e.id),t[e]=!1)}),s.forEach(e=>{e.id&&(e=MessageUtils.getMsgStateId(e.id),t[e]=!1)}),r.bulkUpdate(t)}catch(e){return console.error("Error folding all messages:",e),!1}},this.unfoldAllMessages=function(){try{var e=l.querySelectorAll(".gs-chat-user-message"),s=l.querySelectorAll(".gs-chat-assistant-message");let t={};return e.forEach(e=>{e.id&&(e=MessageUtils.getMsgStateId(e.id),t[e]=!0)}),s.forEach(e=>{e.id&&(e=MessageUtils.getMsgStateId(e.id),t[e]=!0)}),r.bulkUpdate(t)}catch(e){return console.error("Error unfolding all messages:",e),!1}},this.foldAllCode=function(){try{return this.codeFoldingService&&this.codeFoldingService.foldAllCode?(this.codeFoldingService.foldAllCode(l),!0):!1}catch(e){return console.error("Error folding all code blocks:",e),!1}},this.unfoldAllCode=function(){try{return this.codeFoldingService&&this.codeFoldingService.unfoldAllCode?(this.codeFoldingService.unfoldAllCode(l),!0):!1}catch(e){return console.error("Error unfolding all code blocks:",e),!1}},this.foldLargeCodeBlocks=function(o=30){try{this.codeFoldingService&&this.codeFoldingService.removeAllFoldingControls&&this.codeFoldingService.removeAllFoldingControls(l);var e=l.querySelectorAll("pre");let s={};e.forEach(e=>{var t;e.id&&(t=e.textContent.split("\n").length,o<t)&&((t=e.querySelector("code"))&&(t.dataset.fullContent=e.innerHTML),s[e.id]=!1)});var t=r.bulkUpdate(s);return t&&this.codeFoldingService&&this.codeFoldingService.refreshCodeFolding&&this.codeFoldingService.refreshCodeFolding(l),t}catch(e){return console.error("Error folding large code blocks:",e),!1}},this.scrollToTop=function(e="smooth"){var t=l.querySelector(".gs-chat-user-message, .gs-chat-assistant-message");t?ScrollUtils.scrollToElement(t,-20,e):window.scrollTo({top:0,behavior:e})},this.scrollToBottom=function(e="smooth"){ScrollUtils.scrollToBottom(null,l,0,e)},this.scrollToMessage=function(s,o="smooth"){if(s){let t=document.getElementById(s);if(t){s=MessageUtils.getMsgStateId(s);r.setState(s,!0),ScrollUtils.scrollToElement(t,-20,o);let e=t.style.backgroundColor;return t.style.backgroundColor="#ffffd0",t.style.transition="background-color 2s",setTimeout(()=>{t.style.backgroundColor=e},2e3),!0}}return!1},this.toggleMessageExpansion=function(e){return!!e&&(e=MessageUtils.getMsgStateId(e),r.toggleState(e))},this.setupKeyboardShortcuts=function(){let e=e=>{var t;"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&(e.altKey&&"ArrowUp"===e.key&&(e.preventDefault(),this.navigateToPreviousMessage()),e.altKey&&"ArrowDown"===e.key&&(e.preventDefault(),this.navigateToNextMessage()),e.altKey&&"Home"===e.key&&(e.preventDefault(),this.scrollToTop()),e.altKey&&"End"===e.key&&(e.preventDefault(),this.scrollToBottom()),e.altKey)&&"f"===e.key&&(e.preventDefault(),t=document.activeElement.closest(".gs-chat-user-message-body, .gs-chat-assistant-message"))&&t.id&&this.toggleMessageExpansion(t.id)};return document.addEventListener("keydown",e),()=>{document.removeEventListener("keydown",e)}},this.getAllMessages=function(){if(!l)return[];let s=[];return l.querySelectorAll(".gs-chat-system-message").forEach(e=>{var t;e.id&&(t=e.querySelector(".gs-chat-system-message-content"),s.push({id:e.id,role:"system",content:t?t.textContent:"",element:e}))}),l.querySelectorAll(".gs-chat-user-message").forEach(e=>{var t;e.id&&(t=e.querySelector(".gs-chat-user-message-content"),s.push({id:e.id,role:"user",content:t?t.textContent:"",element:e}))}),l.querySelectorAll(".gs-chat-assistant-message").forEach(e=>{var t;e.id&&(t=e.querySelector(".gs-chat-assistant-message-content"),s.push({id:e.id,role:"assistant",content:t?t.textContent:"",element:e}))}),s.sort((e,t)=>Array.from(l.children).indexOf(e.element)-Array.from(l.children).indexOf(t.element))},this.openCopyMessagesModal=function(e){"function"==typeof e&&e(this.getAllMessages())}}module.exports=ConversationNavigationService;
