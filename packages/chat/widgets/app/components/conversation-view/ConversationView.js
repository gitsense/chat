/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let{getMessagesBeforeId,getLastMessage}=require("@gitsense/gsc-utils"),{MarkDownIt,hljs,h,svg,ChatInput,parseSlashSearchCommand}=require("./Dependencies"),MessageService=require("./services/MessageService"),MessageStateManager=require("./services/MessageStateManager"),ConversationNavigationService=require("./services/ConversationNavigationService"),CodeFoldingService=require("./services/CodeFoldingService"),StreamingService=require("./services/StreamingService").StreamingService,CodeBlockService=require("./services/CodeBlockService"),renderUserMessage=require("./components/UserMessage").renderUserMessage,{renderAssistantMessages,stopAllStreaming}=require("./components/AssistantMessage/"),renderSystemMessage=require("./components/SystemMessage").renderSystemMessage,ConversationControlPanel=require("./components/ConversationControlPanel"),MessageToolsModal=require("./components/modals/MessageToolsModal").MessageToolsModal,ScrollUtils=require("./utils/ScrollUtils"),MessageUtils=require("./utils/MessageUtils"),MarkdownUtils=require("./utils/MarkdownUtils"),ConversationMetricsUtils=require("./utils/ConversationMetricsUtils"),{ScrollIntentManager,ScrollIntentState}=require("./utils/ScrollIntentManager"),MIN_BOTTOM_PADDINGS=200,MAX_COLLAPSED_MSG_HEIGHT=100,DEFAULT_SCROLL_THRESHOLD=30,DEFAULT_SCROLL_DEBOUNCE=20;function ConversationView(m,S,M,w,u,e={},s={}){if(!u)throw new Error("No updateChat function defined");let o=this,{chatInputBody:r,inSideBySide:l,scrollableElement:i,showCodeOptions:d=!0,showCopy:P=!0,showChat:R=!0,showDescendants:G=!0,showEdit:H=!0,showFork:x=!0,showNote:V=!0,showTrash:j=!0,showInsights:z=!0,showTryAgain:X=!0,showNewChatOptions:W=!0,showControlPanel:$=!0,stickyButtonWidth:J=40,stickyVerticalLayout:K=!0,stickyButtonLabels:Q={foldMessages:"FM",unfoldMessages:"UM",foldCode:"FC",unfoldCode:"UC",scrollTop:"↑",scrollBottom:"↓"},fullButtonLabels:Y={foldMessages:"Fold Messages",unfoldMessages:"Unfold Messages",foldCode:"Fold Code",unfoldCode:"Unfold Code",scrollTop:"↑ Top",scrollBottom:"↓ Bottom"},scrollThreshold:c=DEFAULT_SCROLL_THRESHOLD,scrollDebounceTime:g=DEFAULT_SCROLL_DEBOUNCE,enableEnhancedScrolling:p=!0}=e,C=s.onStreamMessageComplete,f=new CodeBlockService;M&&f.updateBlockMap(M);e=getMessagesBeforeId(w,M.messages[0]);let v=new MessageStateManager,Z=!(e.length<=3&&"GitSense Notes"===w),T=new CodeFoldingService(v,hljs),ee=MarkdownUtils.createMarkdownRenderer(hljs),y=[],A=null,I=null,L={},se=[];let _=null,D=null,E=null,B=null,O=null,U=null,k=null,N=null,t=null,b=null;function F(){var e=o.getAllMessagesForMessageTools();let s=document.getElementById("gs-modal-container");s||(s=h.createDiv({id:"gs-modal-container"}),document.body.appendChild(s)),(t=new MessageToolsModal({feature:"copy",messages:e,onClose:()=>{t&&(t.cleanup(),t=null)}})).render(s)}async function q(s,o,e=!1,t=!1){_&&_.forceAutoScrolling();var n=o.match(/Notes/),{temperature:a,id:r,chat_id:l}=getLastMessage(M.messages[0]),i=n||t?["assistant"]:["user","assistant"];let d=r;for(let e=0;e<i.length;e++){var c=i[e],g=!n&&!t&&"assistant"===c?null:s,c=await MessageService.newChatMessage(m,l,d,w,c,g,{temperature:null==a?0:a,realModel:o===w?void 0:o,stream:!0});d=c.id}e?window.location.reload():u()}async function n(e){if(!B){if(!e)throw new Error("No render to defined");var s=h.createDiv({id:"gsChatNavigation",style:{minHeight:"0",margin:"0",padding:"0"}});B=h.createDiv({id:"gsChatMessages"}),O=h.createDiv({}),U=h.createDiv({style:{height:MIN_BOTTOM_PADDINGS+"px"}}),$&&(e.appendChild(s),function(e){N=new ConversationNavigationService(v,T,B),(k=new ConversationControlPanel({stickyTopOffset:70,zIndex:1e3,showFoldAllMessages:!0,showFoldAllCode:!0,showScrollControls:!0,showMessagePosition:!0,buttonWidth:J,verticalLayout:K,buttonLabels:Q,fullButtonLabels:Y,positionIndicatorOptions:{labelText:svg.tool({style:{marginBottom:"2px"}}),updateInterval:100,visibilityThreshold:.5,onOpenMessageToolsModal:()=>F.call(this)}},{messageStateManager:v,codeFoldingService:T},{onFoldAllMessages:()=>{N.foldAllMessages()&&window.location.reload()},onUnfoldAllMessages:()=>{N.unfoldAllMessages()&&window.location.reload()},onFoldAllCode:()=>{N.foldAllCode()&&window.location.reload()},onUnfoldAllCode:()=>{N.unfoldAllCode()&&window.location.reload()},onScrollToTop:()=>{N.scrollToTop(),_&&_.forceUserInterrupted()},onScrollToBottom:()=>{N.scrollToBottom(),_&&_.forceAutoScrolling()},onOpenMessageToolsModal:()=>{F.call(this)}})).render(e)}(s)),e.appendChild(B),e.appendChild(O),e.appendChild(U),p&&(D&&(D(),D=null),s=i||window,{intentManager:s,cleanup:e}=ScrollUtils.setupEnhancedScrollDetection(s,{scrollThreshold:c,debounceTime:g,minScrollDistance:3,onScrollStateChange:(e,s)=>{e!==ScrollIntentState.USER_INTERRUPTED&&ScrollIntentState.AUTO_SCROLLING}}),_=s,D=e)}var{messages:s=[]}=M;if(!s.length)throw new Error("Chat doesn't contain any messages!");if(1<s.length)throw new Error("More than one root message found");var e="system"===s[0].role?s[0]:{id:0,message:"",kids:s},{kids:o=[]}=e;if(!o)throw new Error("No user message found");R&&!E&&(n={stop:()=>{stopAllStreaming()},send:async(s,o,t,n,a,r=[])=>{var l=parseSlashSearchCommand(a,t);if(l)await E.reset(),await q(l,t,!1,!0);else{r.forEach(e=>{var{name:e,content:s,language:o}=e;a+="\n\n#### File: `"+e+"`\n\n```"+o.toLowerCase()+`
${s}
`+"```"});var l="new-chat"===s,r="split-chat"===s,i="validate-chat"===s;if(null===s||"regular"===s||"frankenstein-chat"===s)await E.reset(),await q(a,t);else{var n=n.length?{type:"Compare model responses",options:{models:n}}:null,d=M.group_id,{id:c,model:g,temperature:u}=getLastMessage(M.messages[0]),o="none"===o.toLowerCase()?null:"sibling"===o.toLowerCase()?M.parent_id:M.id;let e=null;var h=S.prompts.find(e=>e.default),p=S.prompts.find(e=>e.name===M.prompt),p=(p||h).name;if(l){h="GitSense Notes",l=t===h;e={type:l?"notes":"regular",model:t,name:l?h:null,temperature:u,prompt:p,parentId:o,groupId:d,message:a,analysis:n}}else{if(!r&&!i)throw new Error("Unrecognized chat type");e=MessageService.createSplitOrValidatePayload(M,w,s,t,a,o,d,u,n,g,c)}await E.reset();l=(await MessageService.newChat(m,e)).uuid;MessageUtils.navigateToChat(l)}}}},t={showNewChatOptions:W,fakeLLMs:S.fakeLLMs},a={onResize:e=>{e=e.height;e<MIN_BOTTOM_PADDINGS?U.style.height=MIN_BOTTOM_PADDINGS+"px":U.style.height=e+50+"px"}},(E=new ChatInput(w,S.models,t,n,a)).render(r));var t=o[0],n="user"===t?.role?t:null,a=n?null:t,o=(A={messagesBody:B,messageBodies:se,renderedMessage:L,messageStateManager:v,md:ee,chat:M,widget:m,settings:S,hljs:hljs,chatInput:E,codeBlockService:f,navigationService:N,scrollIntentManager:_,updateChat:u,saveCurrentSelection:(e,s=!1)=>{b.saveCurrentSelection(e,s)},addChildrenToNode:(e,s,o)=>{b.addChildrenToNode(e,s,o)},getTreeTableStateId:()=>b.getStateId(),findNode:(e,s)=>b.findNode(e,s),showContextBuilder:(e,s,o,t,n)=>{b.showContextBuilder(e,s,o,t,n)},registerForTreeTableStateChanges:s=>{y.find(e=>e===s)?console.warn("Function has already registered for Tree Table state changes!"):y.push(s)},unregisterForTreeTableStateChanges:s=>{y.find(e=>e===s)?y=y.filter(e=>e!==s):console.warn("Function has not been registered for Tree Table state changes!")}},I={MAX_COLLAPSED_MSG_HEIGHT:MAX_COLLAPSED_MSG_HEIGHT,scrollToBottomOnLoad:Z,inSideBySide:l,showCodeOptions:d,showCopy:P,showDescendants:G,showEdit:H,showFork:x,showNote:V,showTrash:j,showInsights:z,showTryAgain:X,scrollThreshold:c,scrollDebounceTime:g,enableEnhancedScrolling:p,scrollableElement:i},{onStreamMessageComplete:e=>{C&&C(e),u()},onStopStreaming:e=>e,onContinueCodeBlock:async(e,s)=>q(e,s,!0),onRegeneratePatch:async(e,s)=>q(e,s,!0),forkChat:async(e,s)=>{var o=e.find(e=>null!==e.temperature)?.temperature||0,s={name:M.name,parentId:M.parent_id,groupId:M.group_id,prompt:M.prompt,model:s,temperature:o,messages:e},o=await MessageService.newChat(m,s);await MessageService.updateChats(m,[{id:M.id,name:"Original: "+M.name,parent_id:o.id}]),MessageService.setChat(o)}});0!==e.id&&renderSystemMessage(e,w,L),n?await renderUserMessage(n,e,w,A,I,o,renderAssistantMessages):await renderAssistantMessages([a],e,w,A,I,o,renderUserMessage),k&&k.refreshPositionIndicator&&k.refreshPositionIndicator()}this.render=function(e){n(e)},this.update=function(e){e?(A.chat=M=e,f.updateBlockMap(M),n()):console.warn("ConversationView: Attempted to update with null chat")},this.getRecentMessages=function(){if(!M||!M.messages||!M.messages[0])return[];let o=[];return function s(e){e&&(o.push(e),e.kids)&&Array.isArray(e.kids)&&e.kids.forEach(e=>s(e))}(M.messages[0]),o.sort((e,s)=>void 0!==e.position&&void 0!==s.position?s.position-e.position:new Date(s.created_at)-new Date(e.created_at))},this.getAllMessagesForMessageTools=function(){if(!M||!M.messages||!M.messages[0])return[];let t=[];return function s(o){if(o){let e=o.message||"";"system"===o.role&&(e=e.replace(/{{gs-chat-llm-model}}/,w).replace(/{{gs-chat-datetime}}/,(new Date).toISOString())),t.push({id:o.id,role:o.role,content:e,position:o.position,created_at:o.created_at}),o.kids&&Array.isArray(o.kids)&&o.kids.forEach(e=>s(e))}}(M.messages[0]),t.sort((e,s)=>void 0!==e.position&&void 0!==s.position?e.position-s.position:new Date(e.created_at||0)-new Date(s.created_at||0))},this.cleanup=function(){D&&(D(),D=null),_=_&&null,k&&k.cleanup&&(k.cleanup(),k=null),t&&t.cleanup&&(t.cleanup(),t=null)},this.treeTableStateChanged=function(s,o){y.forEach(e=>{e(s,o)})},this.setTreeTableComponent=function(e){b=e},this.scrollToBottom=function(){N&&N.scrollToBottom()}}ConversationView.createStreamingService=function(e){return new StreamingService(e)},module.exports={ConversationView:ConversationView};
