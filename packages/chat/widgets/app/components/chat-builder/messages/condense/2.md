; role: assistant


# Condense

**Objective:** To analyze a given chat history and associated file context (including file content/metadata), extract the essential information and decisions, and identify the minimal set of context files necessary to understand the final state or core objective of the conversation. This helps streamline future interactions by removing redundant information and focusing context.

**Input:**

1.  **Chat History:** The complete chat history, typically formatted with alternating `<user>` and `<assistant>` tags. File references within the chat history will use the format `filename.ext (chat-id: <integer>)`.
2.  **File Context Information:** A structured block (similar to a "FILE CONTENT - WORKING DIRECTORY" message) providing details for files referenced in the chat. This block will include:
    *   Filename (`filename.ext`)
    *   Chat ID (`chat-id: <integer>`)
    *   Other metadata (e.g., path, size, tokens, parent ID, and potentially the actual file content or a summary of it).

**Process:**

1.  **Analyze Full Conversation and File Context:**
    *   Carefully review the entire provided chat history from beginning to end. Pay attention to the flow of discussion, user requests, assistant responses, code snippets, file references, clarifications, and corrections.
    *   Simultaneously, consult the **File Context Information** for details about any file mentioned (using the `chat-id` to link references in the chat to the detailed file information).

2.  **Identify Core Goal & Final State:** Determine the primary objective the user was trying to achieve throughout the conversation. What was the final problem solved, the final question answered, the final code generated, or the key decision reached?

3.  **Filter Essential Information:**
    *   **Messages:** Identify the key messages (from both user and assistant) that define the problem, outline the requirements, present the solution, contain the final version of code or information, and capture critical decisions or clarifications. Discard conversational filler, dead-ends, corrected misunderstandings, and intermediate steps that are not relevant to the final outcome.
    *   **Files:** Examine all files detailed in the **File Context Information** and referenced in the chat. Based on both the discussion in the chat *and* the provided content/metadata of the files, determine which of these files are *directly relevant and essential* to the final state or core goal identified in Step 2.
        *   Consider if a file's content was crucial for a decision, part of the final solution, or necessary for understanding the outcome.
        *   Files that were introduced but whose content (as per the File Context Information) proved irrelevant, or files that were superseded, or whose information was fully incorporated elsewhere, should be excluded from the final context list.

4.  **Synthesize Condensed Summary:** Create a concise narrative summarizing the essential parts of the conversation and the role of key files (identified in Step 3). This summary should:
    *   Briefly state the initial goal or problem.
    *   Highlight the key steps, decisions, or refinements made, referencing specific files (using `filename.ext (chat-id: <integer>)`) where their content or discussion was pivotal.
    *   Clearly present the final outcome, solution, or conclusion.
    *   Be understandable on its own, capturing the essence of the original conversation without requiring the reader to go through the full history.

5.  **Compile Relevant Context Files:** Create a list of only the essential files identified in Step 3.
    *   For each essential file, use the exact `filename.ext (chat-id: <integer>)` format. This `chat-id` must correspond to the ID provided in the input **File Context Information**.
    *   List each relevant file on a new line.
    *   If no files are deemed essential for the final context, indicate "None".

6.  **Format Output:** Present the results strictly using the following markdown structure:

    ```markdown
    # Condensed

    <The synthesized summary generated in Step 4>

    # Context

    <The list of relevant files generated in Step 5, using "filename.ext (chat-id: <integer>)" format, or "None" if applicable>
    ```

**Example Scenario (Revised to reflect File Context Input):**

*   **Input:**
    *   **Chat History:** A long chat discussing refactoring `script_main.py (chat-id: 101)`, potentially using `helper_module.py (chat-id: 102)` and `config_data.json (chat-id: 103)`. Also mentions `old_code.py (chat-id: 104)` and `notes.txt (chat-id: 105)`.
    *   **File Context Information:**
        ```
        FILE CONTENT - WORKING DIRECTORY
        Summary: 5 files...
        - script_main.py (chat-id: 101) - [content/metadata showing it's the primary script]
        - helper_module.py (chat-id: 102) - [content/metadata showing useful functions]
        - config_data.json (chat-id: 103) - [content/metadata showing key-value pairs, some of which are discussed as being moved into the script]
        - old_code.py (chat-id: 104) - [content/metadata showing it's an outdated version, confirmed in chat as superseded]
        - notes.txt (chat-id: 105) - [content/metadata showing general ideas, none directly implemented or essential for final code]
        ```
*   **Output:**

    ```markdown
    # Condensed

    The user aimed to refactor `script_main.py (chat-id: 101)` for better organization and to incorporate configuration. After reviewing its content and discussing options, it was decided to integrate functions from `helper_module.py (chat-id: 102)`. Key settings from `config_data.json (chat-id: 103)` were directly embedded into `script_main.py (chat-id: 101)` during the refactoring. The file `old_code.py (chat-id: 104)` was confirmed as outdated and not used. `notes.txt (chat-id: 105)` contained general ideas not critical to the final implementation. The refactored `script_main.py (chat-id: 101)` now utilizes `helper_module.py (chat-id: 102)` and includes the necessary configurations.

    # Context

    script_main.py (chat-id: 101)
    helper_module.py (chat-id: 102)
    ```
    *(Note: `config_data.json (chat-id: 103)` might be excluded if its essential information was fully integrated into `script_main.py` and the file itself is no longer needed to understand the final state. This depends on the assistant's judgment based on the chat and file content.)*
