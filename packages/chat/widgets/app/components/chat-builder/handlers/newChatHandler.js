/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let{ChatUtils,CodeBlockUtils,MessageUtils,ContextUtils}=require("@gitsense/gsc-utils"),{newChat:createNewChat,newChatTree,getChatTemplateMessages,newChatMessage,updateChatMessage}=require("../Dependencies");async function handleAddManageContextMessage(e,t,a){var{widget:t,chat:s}=t,r=await getChatTemplateMessages(t,"manage-context");if(1!==r.length)throw new Error("Expecting to 1 message, but received "+r.length);var r=r[0].content,n=MessageUtils.getLastMessage(s.messages[0]),o=n.id,n=n.model,t=await newChatMessage(t,s.id,o,n,"assistant",r);a&&a(t)}async function handleAddMetadataInsightsMessage(e,t,a){var{widget:t,chat:s}=t,r=await getChatTemplateMessages(t,"metadata-insights");if(1!==r.length)throw new Error("Expecting to 1 message, but received "+r.length);var r=r[0].content,n=ChatUtils.getChatMessages(s).pop().id,o=s.main_model,t=await newChatMessage(t,s.id,n,o,"assistant",r);a&&a(t)}async function handleAddSearchMessage(e,t,a){var{widget:t,chat:s}=t,r=await getChatTemplateMessages(t,"search");if(1!==r.length)throw new Error("Expecting to 1 message, but found "+r.length);var r=r[0].content,n=MessageUtils.getLastMessage(s.messages[0]),o=n.id,n=n.model,t=await newChatMessage(t,s.id,o,n,"assistant",r);a&&a(t)}async function handleCreateNewAnalyzeChat(e,t,a,s){let{relation:r,prompt:n,temperature:o,model:l,bundle:i,autoSave:h}=t;var{chat:a,widget:d}=a,m=t.instructions.toLowerCase().split(" ").pop().replace(/\(|\)/g,"");let g=t.content.toLowerCase().split(" ").pop().replace(/\(|\)/g,"");var c=t.analyzer.toLowerCase().split(" ").pop().replace(/\(|\)/g,""),w=!i,p=w?"<GSC_HOME>/data/analyze/_shared/context-loader":`<GSC_HOME>/data/analyze/${c}/${g}/`+m,C=await getChatTemplateMessages(d,p);if(!C||0===C.length)throw w?new Error("Unable to retrieve context "):new Error(`Invalid analyzer (${c}) and/or content (${g}) and/or instructions (${m})`);p=C.find(e=>"assistant"===e.role);if(!p)throw new Error("No assistant message found");p=p.content.trimStart().split("\n")[0];let u=`${c}::${g}::`+m;if(w){if(!p.includes("`{{analyzer-id}}`"))throw new Error("The first line in the context loader does not contain a template string")}else{var f=p.match(/`([^`]+)`/);if(!f)throw new Error(`The first line does not contain an analyzer id in backtick quotes. Found "${p}" instead`);p=f[1].split("::");if(3!==p.length)throw new Error(`The unique analyzer id is not in format <name>::<content>::<instructions> found ${f[1]} instead`);if(p[0]!==c||p[1]!==g||p[2]!==m)throw new Error("The unique analyzer id in the instructions file is not equal to ${uniqueAnalyzerId}")}let y=null,N={role:"system",message:"<replace with system message>"};if(!w){f=await getChatTemplateMessages(d,"<GSC_HOME>/data/analyze/_shared/start");if(!(y=f&&f.length?f[0]:null))throw new Error("Unable retrieve the start message");c=await getChatTemplateMessages(d,"<GSC_HOME>/data/analyze/_shared/system");if(!(N=c&&c.length?{role:"system",message:c[0].content}:null))throw new Error("Unable retrieve the system message")}var f=w?(e=>{var t=CodeBlockUtils.extractCodeBlocks(e.content,{silent:!0}).blocks;if(1!==t.length)throw new Error("Expecting on code block but received "+t.length);if("gs-tool"!==(t=t[0]).type)throw new Error(`Expecting a gs-tool code block but found one of type "${t.type}"`);if(t.toolParseError)throw new Error("Parse Error: "+t.toolParseError);if("context-loader"!==(t=t.toolData).tool)throw new Error(`Expecting a context-loader tool but found "${t.tool}"`);return t=e.content.replace(/{{analyzer-id}}/g,u),{role:e.role,message:t}})(C[0]):(p=C[0],m=p.content.replace(/{{auto-save}}/,h),{role:p.role,message:m}),v=[N,{role:"user",message:""},f];if(!w){v.push({role:"assistant",message:i});for(let a=1;a<C.length;a++){let{role:e,content:t}=C[a];v.push({role:e,message:t})}v.push({role:"user",message:y.content}),v.push({role:"assistant",message:null})}c={stream:!1,parentId:r?"child"===r.toLowerCase()?a.id:"sibling"===r.toLowerCase()?a.parent_id:0:0,type:w?"analyze-builder":"analyze",name:t.name||"Analyze"+(w?" Builder ":"")+"-`"+u+"`",model:l,temperature:o,prompt:n,messages:v};s(await createNewChat(d,c))}async function handleCreateNewAnalyzeDataChat(e,t,a,s){var{relation:r,prompt:n,temperature:o,model:l}=t,{chat:a,widget:i}=a,t=t.name||"Data Insights",h=await getChatTemplateMessages(i,"analyze-data");if(2!==h.length)throw new Error("Expecting to 2 messages, but received "+h.length);r=r?"child"===r.toLowerCase()?a.id:"sibling"===r.toLowerCase()?a.parent_id:0:0,h.find(e=>"system"===e.role)||h.unshift({role:"system",content:"<replace with system message>"}),a=h.map(e=>({role:e.role,message:e.content})),h={stream:!1,parentId:r,type:"new-analyze-data",name:t,model:l,temperature:o,prompt:n,messages:a};s(await createNewChat(i,h))}async function handleCreateNewCodeChat(e,t,a,s){var{relation:r,prompt:n,temperature:o,model:l,bundle:i}=t,{chat:a,widget:h}=a,t=t.name||"Code",d=await getChatTemplateMessages(h,"code");if(2!==d.length)throw new Error("Expecting to 2 messages, but received "+d.length);i||d[d.length-1].content;i={stream:!1,parentId:r?"child"===r.toLowerCase()?a.id:"sibling"===r.toLowerCase()?a.parent_id:0:0,type:"code",name:t,model:l,temperature:o,prompt:n,messages:[{role:"system",message:"<replace with system message>"},{role:"user",message:d[0].content||""},{role:"assistant",message:d[1].content}]};s(await createNewChat(h,i))}async function handleCreateNewMetadataInsightsChat(e,t,a,s){var{name:t,relation:r,prompt:n,temperature:o,model:l}=t,{chat:a,widget:i}=a,h=await getChatTemplateMessages(i,"metadata-insights");if(1!==h.length)throw new Error("Expecting to find one metadata insights message but found "+h.length);h=h[0],r={stream:!1,parentId:r?"child"===r.toLowerCase()?a.id:"sibling"===r.toLowerCase()?a.parent_id:0:0,name:t,type:"metadata-insights",model:l,temperature:o,prompt:n,messages:[{role:"system",message:"<replace with system message>"},{role:"user",message:""},{role:"assistant",message:h.content}]};s(await createNewChat(i,r))}async function handleCreateNewDemosChat(e,t,a,s){var{name:t,prompt:r,model:n,relation:o}=t,{chat:a,widget:l}=a,o=o?"child"===o.toLowerCase()?a.id:"sibling"===o.toLowerCase()?a.parent_id:0:0;s(await newChatTree(l,"demos",t,o,r,n))}async function handleCreateNewDraftChat(e,t,a,s){var{name:t,relation:r,prompt:n,temperature:o,model:l}=t,{chat:a,widget:i}=a,h=await getChatTemplateMessages(i,"draft"),d=h[0],h=h[1],r={stream:!1,parentId:r?"child"===r.toLowerCase()?a.id:"sibling"===r.toLowerCase()?a.parent_id:0:0,name:t,type:"draft",model:l,temperature:o,prompt:n,messages:[{role:"system",message:"<replace with system message>"},{role:"user",message:d.content||""},{role:"assistant",message:h.content}]};s(await createNewChat(i,r))}async function handleCreateNewFixPatchChat(e,t,a,s){var{name:t,prompt:r,temperature:n,model:o,messages:l}=t,{chat:a,widget:i}=a,h=l[l.length-1];let{blocks:d,warnings:m}=CodeBlockUtils.extractCodeBlocks(h.message,{silent:!0});var g=d.filter(e=>"patch"===e.type);if(1!==g.length)throw new Error("Expecting to find one patch but found "+g.length);g=g[0];if(g.incomplete)throw new Error("Incomplete patch");var g=g.metadata||{},c=g["Source-Block-UUID"],g=g["Target-Block-UUID"];if(!c)throw new Error("No source block UUID found");if(!g)throw new Error("No target block UUID found");let w=null;for(let e=0;e<l.length;e++){var{role:p,message:C}=l[e];if("assistant"===p){let t=CodeBlockUtils.extractCodeBlocks(C,{silent:!0}).blocks;for(let e=0;e<t.length;e++){var u=t[e],f=t[e].header;if(f&&f["Block-UUID"]===c){w=u;break}}if(w)break}}if(!w)throw new Error(`No code block with the source UUID ${c} found`);var y=await getChatTemplateMessages(i,"fix-patch");if(2!==y.length)throw new Error("Expecting two fix patch message but received "+y.length);var N=y[0],y=y[1].content.replace(/{{source-uuid}}/g,c).replace(/{{target-uuid}}/g,g).replace(/{{chat-uuid}}/g,`"${a.uuid}"`).replace(/{{message-id}}/g,h.id),g="```"+w.language+"\n"+w.headerText+"\n\n\n"+w.content+"\n```",N=[{role:"system",message:N.content},{role:"user",message:""},{role:"assistant",message:g},{role:"assistant",message:h.message},{role:"user",message:y},{role:"assistant",message:null}],g={stream:!0,parentId:a.id,name:t,model:o,temperature:n,prompt:r,messages:N};s(await createNewChat(i,g))}async function handleCreateNewHelpChat(e,t,a,s){var{name:t,prompt:r,model:n,relation:o}=t,{chat:a,widget:l}=a,o=o?"child"===o.toLowerCase()?a.id:"sibling"===o.toLowerCase()?a.parent_id:0:0;s(await newChatTree(l,"help",t,o,r,n))}async function handleCreateNewNewAnalyzerChat(e,t,a,s){var{name:t,relation:r,prompt:n,temperature:o,model:l}=t,{chat:a,widget:i}=a,h=await getChatTemplateMessages(i,"new-analyzer"),r={stream:!1,parentId:r?"child"===r.toLowerCase()?a.id:"sibling"===r.toLowerCase()?a.parent_id:0:0,name:t,type:"new-analyzer",model:l,temperature:o,prompt:n,messages:[{role:"system",message:h[0].content},{role:"user",message:""},{role:"assistant",message:h[1].content}]};s(await createNewChat(i,r))}async function handleCreateNewNotesChat(e,t,a,s){var{name:t,relation:r,prompt:n,temperature:o,model:l}=t,{chat:a,widget:i}=a,r=r?"child"===r.toLowerCase()?a.id:"sibling"===r.toLowerCase()?a.parent_id:0:0,a=await getChatTemplateMessages(i,"notes"),r={stream:!1,parentId:r,name:t,type:"notes",model:l,temperature:o,prompt:n,messages:[{role:"system",message:"<replace with system message>"},{role:"user",message:a[0].content||""},{role:"assistant",message:a[1].content}]};s(await createNewChat(i,r))}async function handleCreateNewContextBuilderAskAiChat(e,t,a,s){var{relation:r,prompt:n,temperature:o,model:l}=t,{chat:a,widget:i}=a,t=t.name||"Ask AI",h=await getChatTemplateMessages(i,"context-builder-ask-ai");if(3!==h.length)throw new Error("Expecting to 3 messages, but received "+h.length);r=r?"child"===r.toLowerCase()?a.id:"sibling"===r.toLowerCase()?a.parent_id:0:0,a=e.params?.overview||"";if(!a)throw new Error("No overview provided");e=h[1].content.replace(/{{overview}}/,a),a=h[2].content.replace(/{{model}}/,l),r={parentId:r,type:"regular",name:t,model:l,temperature:o,prompt:n,messages:[{role:"system",message:"<replace with system message>"},{role:"user",message:h[0].content||""},{role:"assistant",message:e},{role:"assistant",message:a}],stream:!1};s(await createNewChat(i,r))}async function handleCreateNewPlanChat(e,t,a,s){var{relation:r,prompt:n,temperature:o,model:l}=t,{chat:a,widget:i}=a,t=t.name||"Plan",h=await getChatTemplateMessages(i,"plan");if(3!==h.length)throw new Error("Expecting to 3 messages, but received "+h.length);r=r?"child"===r.toLowerCase()?a.id:"sibling"===r.toLowerCase()?a.parent_id:0:0,a=e.params?.chatIds?',"chatIds": '+JSON.stringify(e.params.chatIds):"",e=h[2].content.replace(/\{\{Chat-IDs\}\}/,a),a={stream:!1,parentId:r,type:"notes",name:t,model:l,temperature:o,prompt:n,messages:[{role:"system",message:"<replace with system message>"},{role:"user",message:h[0].content||""},{role:"assistant",message:h[1].content},{role:"assistant",message:e}]};s(await createNewChat(i,a))}async function handleCreateNewSearchChat(e,t,a,s){var{name:t,relation:r,prompt:n,temperature:o,model:l}=t,{chat:a,widget:i}=a,h=await getChatTemplateMessages(i,"search");if(1!==h.length)throw new Error("Expecting to find one search message but found "+h.length);h=h[0],r={stream:!1,parentId:r?"child"===r.toLowerCase()?a.id:"sibling"===r.toLowerCase()?a.parent_id:0:0,name:t,type:"regular",model:l,temperature:o,prompt:n,messages:[{role:"system",message:"<replace with system message>"},{role:"user",message:""},{role:"assistant",message:h.content}]};s(await createNewChat(i,r))}async function handleCreateNewChatTree(e,t,a,s){var{name:r,prompt:n,relation:o}=t,{chat:a,widget:l}=a,t=t.tree.toLowerCase(),i="code workspace"===t?"code-workspace":"code project"===t?"code-project":"simple coding task"===t?"code-simple-coding-task":"complex coding task"===t?"code-complex-coding-task":null;if(!i)throw new Error(`Urecognized tree type '${t}'`);t=o?"child"===o.toLowerCase()?a.id:"sibling"===o.toLowerCase()?a.parent_id:0:0;s(await newChatTree(l,i,r,t,n))}module.exports={handleAddManageContextMessage:handleAddManageContextMessage,handleAddMetadataInsightsMessage:handleAddMetadataInsightsMessage,handleAddSearchMessage:handleAddSearchMessage,handleCreateNewAnalyzeChat:handleCreateNewAnalyzeChat,handleCreateNewAnalyzeDataChat:handleCreateNewAnalyzeDataChat,handleCreateNewChatTree:handleCreateNewChatTree,handleCreateNewCodeChat:handleCreateNewCodeChat,handleCreateNewContextBuilderAskAiChat:handleCreateNewContextBuilderAskAiChat,handleCreateNewDemosChat:handleCreateNewDemosChat,handleCreateNewDraftChat:handleCreateNewDraftChat,handleCreateNewFixPatchChat:handleCreateNewFixPatchChat,handleCreateNewHelpChat:handleCreateNewHelpChat,handleCreateNewMetadataInsightsChat:handleCreateNewMetadataInsightsChat,handleCreateNewNotesChat:handleCreateNewNotesChat,handleCreateNewNewAnalyzerChat:handleCreateNewNewAnalyzerChat,handleCreateNewPlanChat:handleCreateNewPlanChat,handleCreateNewSearchChat:handleCreateNewSearchChat};
