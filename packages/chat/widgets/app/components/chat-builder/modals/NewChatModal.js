/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let ContextUtils=require("@gitsense/gsc-utils").ContextUtils,{h,svg}=require("../Dependencies"),{getGitBlobChatMessagesByChatIds,getChatOverviewMessagesByChatIds}=require("../Dependencies"),TreeMenu=require("../menus/TreeMenu"),RelationMenu=require("../menus/RelationMenu"),PromptMenu=require("../menus/PromptMenu"),ModelMenu=require("../menus/ModelMenu"),TemperatureMenu=require("../menus/TemperatureMenu"),AnalyzeInstructionsMenu=require("../menus/analyze/AnalyzeInstructionsMenu"),AnalyzeContentMenu=require("../menus/analyze/AnalyzeContentMenu"),AnalyzeAnalyzerMenu=require("../menus/analyze/AnalyzeAnalyzerMenu"),VALID_CHAT_TYPES=["analyze","analyze-data","context-builder-ask-ai","code","demos","draft","fix-patch","help","metadata-insights","new-analyzer","notes","plan","search","tree"];function NewChatModal(k,e,S,A,t,n={},a={}){if(!VALID_CHAT_TYPES.includes(k))throw new Error(`"${k}" is not a valid chat type`);let{fakeLLMs:I=0,useDefault:E=!0,includeGitSenseNotes:N=!0,name:l,model:O,defaultModel:_,analyzeOptions:q,analyzerId:F,batchSize:ee,autoSave:te,goLabel:P="Go",goOnReady:c=!1,msg:ne,nodes:R,contentType:$,contentOption:G,contextLoadingTitle:ae="Loading bundle...",contextLoadedTitle:le="Bundle",treeType:H=null}=n,U=t.widget,V=a.onGo,W=!!e,Y="analyze"===k;var n="analyze-data"===k,t="code"===k,a="metadata-insights"===k,o="context-builder-ask-ai"===k,r="draft"===k;let K="fix-patch"===k;var i="help"===k;let j="demos"===k;var d="new-analyzer"===k;let J="notes"===k,Q="plan"===k;var s="search"===k;let X="tree"===k,Z=Y?l||"":o?"Context Builder Ask AI":t?"Code":a?"Metadata Insights":r?"Draft":K?"Fix Patch: "+e.name:Q?"Plan":J?"Notes":s?"Ask or Search":i?"Help":X?H:d?"New Analyzer":n?"Data Insights":null,oe=Y?"Analyze":j?"GitSense Chat Demos":Z,re=r||K||d?`Optionally update the name and model, then press ${P}.`:j?`Optionally select another model then press ${P} to start.`:J?`Optionally update the name, then press ${P}.`:X?`Select a type, optionally provide a name, and then press ${P}.`:Y?`Select an analyzer, optionally update model and name, then press ${P}.`:o||Q||t||n||i||s||a?"Optionally update the name and model, then press "+P:null;if(Y&&!q)throw new Error("No analyze options provided. Unable to create an new analyze chat");let u=null;function p(){let v=null,p=null,f=null,w=null,C=null,b=null,x=null,M=null,B=null,z=null,L=null;function D(){if(!R||null!==v){w.value.trim();var t,n,a=M.getSelected();let e=!0;(e=X||a&&!a.toLowerCase().includes("select")?e:!1)&&treeMenu&&(a=treeMenu?treeMenu.getSelected():null,e=!new String(a).toLowerCase().includes("select")),e&&Y&&(a=L?L.getSelected():null,t=z?z.getSelected():null,n=B?B.getSelected():null,e=!new String(n+t+a).toLowerCase().includes("select")),e&&f.classList.contains("disabled")?(f.classList.remove("disabled"),c&&f.click()):e||f.classList.contains("disabled")||f.classList.add("disabled")}}function T(){p.parentNode.removeChild(p)}this.destroy=()=>{p.parentNode.removeChild(p)},this.render=()=>{var{modalBody:e,modal:t,goBtn:n}=(e=>{let t=h.createButton({cls:"btn btn-primary "+(J?"":"disabled"),text:P,style:{marginRight:"5px"}}),n=h.createSpan({append:[svg.x()],style:{cursor:"pointer"}}),a=h.createButton({cls:"btn",text:"Cancel",style:{marginRight:"5px"}}),l=h.createDiv({cls:"gs-chat-modal-header",append:[h.createH2({text:e}),n]}),o=h.createDiv({cls:"gs-chat-modal-body",style:{padding:"30px"}}),r=h.createDiv({cls:"gs-chat-modal-footer",append:[a,t],style:{}}),i=h.createDiv({cls:"gs-chat-modal-content",append:[l,o,r],style:{width:"350px"}}),d=h.createDiv({cls:"gs-chat-modal",append:[i],style:{zIndex:100000002}}),s=(document.body.appendChild(d),!1);return document.addEventListener("mousedown",()=>{s=!1}),document.addEventListener("mousemove",()=>{s=!0}),window.addEventListener("click",e=>{e.target!==d||s||0!==window.getSelection().toString().length||T(),s=!1}),a.onclick=T,n.onclick=T,{modal:d,modalBody:o,goBtn:t}})(oe),t=(p=t,f=n,h.createDiv({style:{textAlign:"center"}})),n=h.createDiv({style:{marginTop:"20px",lineHeight:1.7}}),e=(e.appendChild(t),e.appendChild(n),t),t=h.createDiv({text:ne||re,style:{textAlign:"center",fontSize:"15px"}}),{relationBody:e,treeBody:t,nameBody:n,promptBody:a,tempBody:l,modelBody:o,instructionsBody:r,contentBody:i,analyzerBody:d,bundleBody:s}=(e.appendChild(t),(e=>{var t=h.createDiv({style:{display:"inline-block",marginLeft:"5px"}}),n=Y?h.createDiv({style:{display:"inline-block",marginLeft:"5px"}}):null,a=Y?h.createDiv({style:{display:"inline-block",marginLeft:"5px"}}):null,l=Y?h.createDiv({style:{display:"inline-block",marginLeft:"5px"}}):null,o=R?h.createDiv({style:{margin:"10px",border:"1px solid #ccc",borderRadius:"4px",padding:"12px 15px"}}):null,r=X?h.createDiv({style:{display:"inline-block",marginLeft:"5px"}}):null,i=W?h.createDiv({style:{display:"inline-block",marginLeft:"5px"}}):null,d=h.createDiv({style:{display:"inline-block",marginLeft:"5px"}}),s=h.createDiv({style:{display:K?"none":"inline-block",marginLeft:"5px"}}),u=h.createDiv({style:{display:"inline-block",marginLeft:"5px"}});return j||e.appendChild(c("Name: ",t)),r&&e.appendChild(c("Type: ",r)),l&&e.appendChild(c("Analyzer: ",l)),X||J||e.appendChild(c("Model: ",u)),X||J||K||(e.appendChild(c("Prompt: ",d)),e.appendChild(c("Temperature: ",s))),i&&!K&&e.appendChild(c("Relation: ",i)),o&&e.appendChild(o),{treeBody:r,relationBody:i,nameBody:t,promptBody:d,tempBody:s,modelBody:u,instructionsBody:n,contentBody:a,analyzerBody:l,bundleBody:o};function c(e,t){return h.createDiv({append:[h.createDiv({text:e,style:{display:"inline-block",fontWeight:500,width:"100px",textAlign:"right"}}),t],style:{height:"30px",lineHeight:"30px"}})}})(e=n));if((w=h.createInput({cls:"form-control",style:{width:"400px",padding:"2px 5px"}})).placeholder=X?`Optional. Defaults to ${H.toLowerCase()} type`:Y?"Optional. Defaults to selected analyzer.":Q?"Optional. Defaults to plan":"Optional. Defaults to "+k.charAt(0).toUpperCase()+k.slice(1)+".",w.value=X||j?"":Z,n.appendChild(w),(treeMenu=X?new TreeMenu({showLabel:!1,treeType:H,onChange:e=>{D()}}):null)&&treeMenu.render(t,H),(B=Y?new AnalyzeInstructionsMenu(q.instructions,{showLabel:!1,defaultValue:F?.split("::")[2]||null,onChange:e=>{D()}}):null)&&B.render(r),(z=Y?new AnalyzeContentMenu(q.content,{showLabel:!1,defaultValue:F?.split("::")[1]||null,onChange:e=>{D()}}):null)&&z.render(i),(L=Y?new AnalyzeAnalyzerMenu(q.analyzer,{showLabel:!1,defaultValue:F?.split("::")[0]||null,onChange:e=>{D()}}):null)&&L.render(d),(C=W?new RelationMenu({showLabel:!1}):null)&&C.render(e),(b=new PromptMenu(S,{showLabel:!1,includeNoPrompt:!K})).render(a),(x=new TemperatureMenu({showLabel:!1})).render(l),(M=new ModelMenu(A,{fakeLLMs:I,showLabel:!1,useDefault:E,defaultModel:_||O,includeGitSenseNotes:N,onChange:e=>{D()}})).render(o),R){n=s;let e="working directory"===G?25:100,p=[],l=!1,o=0,r={totalItems:0,loadedCount:0,errorCount:0,totalBytes:0,totalTokens:0,startTime:null,endTime:null},{progresBody:t,statsBody:a}=(e=>{var t=h.createDiv({style:{fontWeight:500,fontSize:"15px",marginBottom:"2px"}}),n=(e.appendChild(t),h.createDiv({style:{fontSize:"13px"}}));return e.appendChild(n),{progresBody:t,statsBody:n}})(n);function u(){if(!t)throw new Error("No progresBody defined");l?t.textContent=ae:t.textContent=le}function c(){let n=a;if(!n)throw new Error("No statsBody defined");var e=r.startTime?((r.endTime||new Date)-r.startTime)/1e3:0,t=[{label:"Files",value:r.loadedCount+" of "+r.totalItems},{label:"Size",value:""+(e=>{var t,n,a;return"number"!=typeof e||isNaN(e)||0===e?"0 bytes":(t=["bytes","KB","MB","GB"],0===(n=Math.floor(Math.log(e)/Math.log(1024)))?e+" "+t[n]:(a=(e=e/Math.pow(1024,n))%1==0?0:1,e.toFixed(a)+" "+t[n]))})(r.totalBytes)},{label:"Tokens",value:"number"!=typeof(t=r.totalTokens)||isNaN(t)||0===t?"0":t<1e3?""+t:t<1e6?(t/1e3).toFixed(1e4<=t?1:0)+"k":t<1e9?(t/1e6).toFixed(1)+"m":(t/1e9).toFixed(1)+"b"},0<e?{label:"Time",value:e.toFixed(2)+"s"}:null];n.innerHTML="",t.forEach(e=>{var t;e&&(t=h.createSpan({text:e.label+": ",style:{}}),e=h.createSpan({text:e.value}),t=h.createDiv({append:[t,e],style:{display:"inline-block",marginRight:"15px"}}),n.appendChild(t))})}function y(e){"loaded"===e.status?(r.loadedCount++,r.totalBytes+=e.size||0,r.totalTokens+=e.tokenCount||0):"error"===e.status&&r.errorCount++,c()}function m(e,t){y({id:e.id,type:e.type,name:e.name,path:e.path||"path/to/"+e.name,meta:e.meta,error:t,status:"error",contentType:$})}{var g=()=>{v=ContextUtils.formatContextContent(p,!0,$,G),D()};n=R.length,r={totalItems:n,loadedCount:0,errorCount:0,totalBytes:0,totalTokens:0,startTime:new Date,endTime:null},c(),p=[],l=!0,o=0;let a=async t=>{if(l){var n=R.slice(t,t+e);if(0===n.length)r.endTime=new Date,l=!1,u(),c(),"function"==typeof g&&g(p);else{try{if("file content"===$)await(async e=>{try{var t="working directory"===G,n=e.map(e=>e.id);let c=await getGitBlobChatMessagesByChatIds(U,n,t);e.forEach(e=>{var{id:t,uuid:n,meta:a}=e,{size:l,path:o,name:r,language:i,highlight:d}=a||{},{message:s=null,repo:u=null}=c[t]||{};s.content?(t={id:t,chatId:s.chat_id,parentId:s.parent_id,messageId:s.id,messageUpdatedAt:s.updated_at,name:r,repo:u,path:o,size:l,chat:n,language:i,highlight:d,content:s.content,tokenCount:a?.tokens?.content?.estimate||0,metadata:{type:e.type,created:e.created_at,updated:e.updated_at},status:"loaded",contentType:$,contentOption:G},p.push(t),y(t)):m(e,"Failed to load file content")})}catch(t){console.error("Error processing file batch:",t),e.forEach(e=>{m(e,t.message||"Failed to load file batch")})}return Promise.resolve()})(n);else{if("overview"!==$)throw new Error("Unrecognized content type: "+$);await(async e=>{try{var t=e.map(e=>e.id);let d=await getChatOverviewMessagesByChatIds(U,t,G);e.forEach((e,t)=>{var{id:n,meta:a}=e,{size:a,path:l,name:o}=a||{},{message:r=null,repo:i=null}=d[n]||{},n={id:n,name:o,repo:i,path:l,size:a||r.content.length,chatId:r.chat_id,parentId:r.parent_id,language:"markdown",highlight:"md",content:r.content||`No ${G} overview`,tokenCount:r.meta?.tokens?.analyzer?.overviews?.[r.type.split("-")[0]]?.estimate||0,metadata:{type:e.type,created:e.created_at,updated:e.updated_at},status:"loaded",contentType:$,contentOption:G};p.push(n),fileList.updateItemRow(n),y(n)})}catch(t){console.error("Error processing overview batch:",t),e.forEach(e=>{m(e,t.message||"Failed to load overview batch")})}return Promise.resolve()})(n)}}catch(t){console.error(`Error processing ${k} batch:`,t),n.forEach(e=>{m(e,t.message||`Failed to load ${k} batch`)})}let e=t+n.length;o=Math.min(100,Math.round(e/R.length*100)),u(),c(),100===o?a(e):setTimeout(()=>a(e),50)}}};u(),c(),a(0)}}D(),f.onclick=()=>{if(V&&!f.classList.contains("disabled")){var{width:e,height:a}=f.getBoundingClientRect(),e=(f.style.width=e,f.style.height=a,f.style.color="black",f.classList.add("disabled"),B?B.getSelected():null),a=z?z.getSelected():null,l=L?L.getSelected():null,o=treeMenu?treeMenu.getSelected():null,r=C?C.getSelected():null,i=w.value.trim()?w.value.trim():X?o:Z;let t=3,n=e=>{(!e||e>t)&&(e=1),f.innerHTML="&middot;".repeat(e),setTimeout(()=>{n(e+1)},500)};n(),V({tree:o,name:i,relation:r,instructions:e,content:a,analyzer:l,bundle:v,batchSize:ee,autoSave:te,prompt:b.getSelected(),model:M.getSelected(),temperature:x.getSelected()})}}}}this.render=()=>{(u=new p).render()},this.destroy=()=>{u.destroy()}}module.exports=NewChatModal;
