/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let ChatUtils=require("@gitsense/gsc-utils").ChatUtils,chatApi=require("../../../../../../Dependencies").chatApi,updateConfig=require("../../../../../../utils/updateConfig").updateConfig,handleSearchError=require("../../../searchUtils/errorHandler").handleSearchError,CHAT_NAME_PREFIX=require("../../constants").CHAT_NAME_PREFIX,{COMPLETED,RESULTS_REVIEW_ORCHESTRATION,ERROR}=require("../../../../../../../common/gitsense/searchStates"),extractRawResultsData=require("./dataExtraction").extractRawResultsData,{selectBatchForReview,formatReviewBatch,getTokenLimitForStage}=require("./batchSelection"),{fetchReviewUserInstructions,fetchReviewSystemPrompt}=require("./promptFetching");async function transitionToNextReviewStage(a,r,n,o,c){var _=n.current_review_stage;let t=null;if("tiny-overviews"===_?(h=n.items_identified_for_review.some(e=>e.short_overview),t=h?"short-overviews":"direct-snippets"):"short-overviews"===_?(h=n.items_identified_for_review.some(e=>e.direct_snippets&&0<e.direct_snippets.length),t=h?"direct-snippets":"inconclusive"):"direct-snippets"===_?t="inconclusive":"meta-search"===_&&(t="completed-meta-search"),"inconclusive"===t||"completed-meta-search"===t){c.completeStage(n.progressStage,"(Inconclusive)"),n.finished_at=(new Date).toISOString();var h=c.renderFinalAnswer("completed-meta-search"===t?"### AI Search Complete\n\nAll identified meta-search results have been reviewed by the AI. The results will be compiled and presented below.":"### Review Inconclusive\n\nThe search results did not provide a definitive answer within the available information and token limits. You may need to refine your query or explore the results manually.");a.message=h+"\n\n"+a.message,r.states.push({type:COMPLETED,created_at:(new Date).toISOString(),finished_at:(new Date).toISOString(),meta_search_completed:"completed-meta-search"===t}),r.states.forEach(e=>{e.items_identified_for_review&&(e.items_identified_for_review=null),e.items_processed_in_stage&&(e.items_processed_in_stage=null),e.last_batch_promising_items&&(e.last_batch_promising_items=null)}),await updateConfig(a,r,o),o.updateChat&&"function"==typeof o.updateChat&&o.updateChat()}else{n.current_review_stage=t,n.current_batch_index=0,n.items_processed_in_stage={message:[],"code-block":[]},n.total_tokens_processed_in_stage=0,n.total_batches_in_stage=0,n.thinking_chat=null,n.last_batch_promising_items=[];let e;try{e=await chatApi.get(o.widget,n.raw_results_chat_uuid)}catch(e){_=`Failed to get raw search results chat (${n.raw_results_chat_uuid}): `+e.message;return void await handleSearchError(a,r,n,_,o.contentBody,o,c)}var h=extractRawResultsData(e),_=getTokenLimitForStage(n.current_review_stage),{batchItems:_,batchTokenCount:d}=selectBatchForReview(n.items_identified_for_review,n.current_review_stage,n.items_processed_in_stage,_,h,n.last_batch_promising_items);if(0<_.length){_.forEach(e=>{n.items_processed_in_stage[e.source_type]||(n.items_processed_in_stage[e.source_type]=[]),n.items_processed_in_stage[e.source_type].includes(e.id)||n.items_processed_in_stage[e.source_type].push(e.id)}),n.total_tokens_processed_in_stage+=d;d=n.items_identified_for_review.filter(e=>!!("tiny-overviews"===n.current_review_stage&&e.tiny_overview||"short-overviews"===n.current_review_stage&&e.short_overview||"meta-search"===n.current_review_stage&&e.extracted_metadata_fields||"direct-snippets"===n.current_review_stage&&e.direct_snippets)).length,d=(n.total_batches_in_stage=0<_.length?Math.ceil(d/_.length):0,formatReviewBatch(_,h));let s;try{s=await chatApi.get(o.widget,n.parent_thinking_chat_uuid)}catch(e){_=`Failed to get parent thinking chat (${n.parent_thinking_chat_uuid}): `+e.message;return void await handleSearchError(a,r,n,_,o.contentBody,o,c)}if(s){let e=null,t=null;try{var u=n.type+"-"+n.current_review_stage;e=await fetchReviewUserInstructions(u,o),t=await fetchReviewSystemPrompt(u,o,r,n.user_query,n.final_queries)}catch(e){return void await handleSearchError(a,r,n,e.message||"Failed to fetch review prompts for new stage.",o.contentBody,o,c)}h=[],_=(h.push({role:"system",message:"<replace with system message>"}),h.push({role:"user",message:`User's original query: "${n.user_query}"
`+`Generated search queries:
\`\`\`json
${JSON.stringify(n.final_queries,null,2)}
\`\`\``}),h.push({role:"assistant",message:`## Search Results Review - Stage: ${n.current_review_stage}, Batch: ${n.current_batch_index+1}

`+d}),h.push({role:"user",message:e}),h.push({role:"assistant",message:null}),{parentId:s.id,name:`${CHAT_NAME_PREFIX} ${a.id} State: ${n.type}-${n.current_review_stage}-batch-`+(n.current_batch_index+1),systemMessageName:n.type+"-"+n.current_review_stage,systemMessage:t,model:r.data.searchCriteria.aiAssistant,temperature:0,forkedFromMessageId:s.messages[0].id,messages:h});let i;try{i=await chatApi.newChat(o.widget,_)}catch(e){u="Failed to create review thinking chat for new stage: "+e.message;return void await handleSearchError(a,r,n,u,o.contentBody,o,c)}n.thinking_chat={id:i.id,uuid:i.uuid,method:"stream",created_at:(new Date).toISOString(),started_at:null,finished_at:null},n.reviews||(n.reviews=[]),n.reviews.push(n.thinking_chat);d=ChatUtils.getChatMessages(i).find(e=>e.message?.includes("## Search Results Review - Stage:"));d&&(n.formatted_results_message_id=d.id),await updateConfig(a,r,o),o.updateChat&&"function"==typeof o.updateChat&&o.updateChat()}else h=`No thinking chat with the UUID ${n.parent_thinking_chat_uuid} found`,await handleSearchError(a,r,n,h,o.contentBody,o,c)}else await transitionToNextReviewStage(a,r,n,o,c)}}module.exports={transitionToNextReviewStage:transitionToNextReviewStage};
