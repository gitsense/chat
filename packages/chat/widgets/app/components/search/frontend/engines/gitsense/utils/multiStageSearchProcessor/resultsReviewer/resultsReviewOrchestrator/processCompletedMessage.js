/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let{CodeBlockUtils,ChatUtils}=require("@gitsense/gsc-utils"),chatApi=require("../../../../../../Dependencies").chatApi,updateConfig=require("../../../../../../utils/updateConfig").updateConfig,{SEARCH_FLOW_BLOCK,HUMAN_PUBLIC_VISIBILITY}=require("../../../../../../../common/gitsense/constants"),handleSearchError=require("../../../searchUtils/errorHandler").handleSearchError,CHAT_NAME_PREFIX=require("../../constants").CHAT_NAME_PREFIX,{RESULTS_REVIEW_ORCHESTRATION,COMPLETED,ERROR}=require("../../../../../../../common/gitsense/searchStates"),extractRawResultsData=require("./dataExtraction").extractRawResultsData,{selectBatchForReview,formatReviewBatch,getTokenLimitForStage}=require("./batchSelection"),META_SEARCH_REVIEW_STAGE=require("./constants").META_SEARCH_REVIEW_STAGE,{fetchReviewUserInstructions,fetchReviewSystemPrompt}=require("./promptFetching"),STATE_TYPE=RESULTS_REVIEW_ORCHESTRATION;async function processCompletedReviewMessage(i,n,_,o,c,d,l,h,e){o.thinking_chat.finished_at=(new Date).toISOString();var u=l._getDuration(o.created_at,o.thinking_chat.finished_at),g=CodeBlockUtils.extractCodeBlocks(i.message,{silent:!0}).blocks,p=g.filter(e=>e.type===SEARCH_FLOW_BLOCK),g=g.findIndex(e=>e.type===SEARCH_FLOW_BLOCK);if(1!==p.length)m="The LLM did did not provide a response in the expected format. "+`Below is the exact response from the LLM.

---

`+i.message,await handleSearchError(n,_,o,m,c,d,l);else{var m=p[0];let r;try{r=JSON.parse(m.content)}catch(e){var p=`Failed to parse '${SEARCH_FLOW_BLOCK}' block: `+e.message;return void await handleSearchError(n,_,o,p,c,d,l)}i.message=CodeBlockUtils.deleteCodeBlockByIndex(i.message,g);let e=null;if("can-answer"===r.type&&o.current_review_stage!==META_SEARCH_REVIEW_STAGE)l.completeStage(o.progressStage,`(${u} seconds)`),e=l.renderFinalAnswer(`### Answer
`+(i.message||r.reason)),o.finished_at=(new Date).toISOString(),_.states.push({type:COMPLETED,created_at:(new Date).toISOString(),finished_at:(new Date).toISOString(),meta_search_completed:o.current_review_stage===META_SEARCH_REVIEW_STAGE,final_answer_content:e});else if("can-answer"===r.type&&o.current_review_stage===META_SEARCH_REVIEW_STAGE){l.completeStage(o.progressStage,`(${u} seconds)`);let a=[];if(r.promising_items&&Array.isArray(r.promising_items)){let s=new Map(o.items_identified_for_review.map(e=>[e.source_type+"-"+e.id,e]));r.promising_items.forEach(e=>{var t=e.source_type+"-"+e.id,t=s.get(t);t?a.push(t):console.warn("processCompletedReviewMessage: Could not find full item for promising meta-search item reference:",e)})}let t="";0<a.length?(t+="```txt\n",a.forEach(e=>{t+=e.file_path+` (chat-id: ${e.chat_id})
`}),t+="```\n"):t+="No relevant files were identified in the meta-search results based on AI review.\n";m=`

`+t;o.finished_at=(new Date).toISOString(),_.states.push({type:COMPLETED,created_at:(new Date).toISOString(),finished_at:(new Date).toISOString(),meta_search_completed:o.current_review_stage===META_SEARCH_REVIEW_STAGE,final_answer_content:m}),e=l.renderFinalAnswer(`### Answer
`+m)}else if("unanswerable"===r.type)l.completeStage(o.progressStage,`(${u} seconds)`),e=l.renderFinalAnswer("### Unaswerable\n"+(r.reason||"The request is unanswerable.")),o.finished_at=(new Date).toISOString(),_.states.push({type:COMPLETED,created_at:(new Date).toISOString(),finished_at:(new Date).toISOString(),meta_search_completed:o.current_review_stage===META_SEARCH_REVIEW_STAGE,final_answer_content:e});else{if("need-more-results"!==r.type)return p=`Unrecognized '${SEARCH_FLOW_BLOCK}' type from review LLM: ${r.type}. Expected 'can-answer', 'unanswerable', or 'need-more-results'.`,void await handleSearchError(n,_,o,p,c,d,l);{if(l.completeStage(o.progressStage,`(${u} seconds)`),r.promising_items&&Array.isArray(r.promising_items)){let s=[],a=new Map(o.items_identified_for_review.map(e=>[e.source_type+"-"+e.id,e]));r.promising_items.forEach(e=>{var t=e.source_type+"-"+e.id,t=a.get(t);t?s.push(t):console.warn("resultsReviewOrchestrator/processCompletedMessage: Could not find full item for promising item reference:",e)}),o.last_batch_promising_items=s}else o.last_batch_promising_items=[];let e;try{e=await chatApi.get(d.widget,o.raw_results_chat_uuid)}catch(h){g=`Failed to get raw search results chat (${o.raw_results_chat_uuid}): `+h.message;return void await handleSearchError(n,_,o,g,c,d,l)}i=extractRawResultsData(e),m=getTokenLimitForStage(o.current_review_stage);let s=o.items_identified_for_review.filter(e=>!o.items_processed_in_stage[e.source_type]?.includes(e.id)),a=o.last_batch_promising_items.filter(t=>s.some(e=>e.source_type===t.source_type&&e.id===t.id));p=[...a,...s.filter(t=>!a.some(e=>e.source_type===t.source_type&&e.id===t.id))];if(0<p.length&&o.total_tokens_processed_in_stage<m){var{batchItems:u,batchTokenCount:g}=selectBatchForReview(p,o.current_review_stage,o.items_processed_in_stage,m-o.total_tokens_processed_in_stage,i,o.last_batch_promising_items);if(0<u.length){o.current_batch_index++,u.forEach(e=>{o.items_processed_in_stage[e.source_type]||(o.items_processed_in_stage[e.source_type]=[]),o.items_processed_in_stage[e.source_type].includes(e.id)||o.items_processed_in_stage[e.source_type].push(e.id)}),o.total_tokens_processed_in_stage+=g;p=o.items_identified_for_review.filter(e=>!!("tiny-overviews"===o.current_review_stage&&e.tiny_overview||"short-overviews"===o.current_review_stage&&e.short_overview||"direct-snippets"===o.current_review_stage&&e.direct_snippets||"meta-search"===o.current_review_stage&&e.extracted_metadata_fields)).length,m=(o.total_batches_in_stage=0<u.length?Math.ceil(p/u.length):0,formatReviewBatch(u,i));let e;try{e=await chatApi.get(d.widget,o.parent_thinking_chat_uuid)}catch(h){g=`Failed to get parent thinking chat (${o.parent_thinking_chat_uuid}): `+h.message;return void await handleSearchError(n,_,o,g,c,d,l)}if(!e)return p=`No thinking chat with the UUID ${o.parent_thinking_chat_uuid} found`,void await handleSearchError(n,_,o,p,c,d,l);let t=null,s=null;try{var w=o.type+"-"+o.current_review_stage;t=await fetchReviewUserInstructions(w,d),s=await fetchReviewSystemPrompt(w,d,_,o.user_query,o.final_queries)}catch(h){return void await handleSearchError(n,_,o,h.message||"Failed to fetch review prompts for next batch.",c,d,l)}u=[],i=(u.push({role:"system",message:"<replace with system message>"}),u.push({role:"user",message:`User's original query: "${o.user_query}"
`+`Generated search queries:
\`\`\`json
${JSON.stringify(o.final_queries,null,2)}
\`\`\``}),u.push({role:"assistant",message:`## Search Results Review - Stage: ${o.current_review_stage}, Batch: ${o.current_batch_index+1}

`+m}),u.push({role:"user",message:t}),u.push({role:"assistant",message:null}),{parentId:e.id,name:`${CHAT_NAME_PREFIX} ${n.id} State: ${o.type}-${o.current_review_stage}-batch-`+(o.current_batch_index+1),systemMessageName:o.type+"-"+o.current_review_stage,systemMessage:s,model:_.data.searchCriteria.aiAssistant,temperature:0,forkedFromMessageId:e.messages[0].id,messages:u});let a;try{a=await chatApi.newChat(d.widget,i)}catch(e){g="Failed to create review thinking chat for next batch: "+e.message;return void await handleSearchError(n,_,o,g,c,d,l)}o.thinking_chat={id:a.id,uuid:a.uuid,method:"stream",created_at:(new Date).toISOString(),started_at:null,finished_at:null},o.reviews||(o.reviews=[]),o.reviews.push(o.thinking_chat),await updateConfig(n,_,d);p=ChatUtils.getChatMessages(a).find(e=>e.message?.includes("## Search Results Review - Stage:"));p&&(o.formatted_results_message_id=p.id)}else await transitionToNextReviewStage(n,_,o,d,l)}else await transitionToNextReviewStage(n,_,o,d,l)}}e&&(n.message=e+"\n\n"+n.message,_.states.forEach(e=>{e.type===COMPLETED&&!e.meta_search_completed&&e.items_identified_for_review&&(e.items_identified_for_review=null,e.items_processed_in_stage&&(e.items_processed_in_stage=null),e.last_batch_promising_items)&&(e.last_batch_promising_items=null)})),await updateConfig(n,_,d),d.updateChat&&"function"==typeof d.updateChat?d.updateChat():console.warn("resultsReviewOrchestrator/processCompletedMessage: Unable to update chat since it is not defined in the context")}}async function transitionToNextReviewStage(r,i,n,_,o){console.warn("resultsReviewOrchestrator/processCompletedMessage: Placeholder transitionToNextReviewStage called.");var c=n.current_review_stage;let t=null;if("tiny-overviews"===c?(d=n.items_identified_for_review.some(e=>e.short_overview),t=d?"short-overviews":"direct-snippets"):"short-overviews"===c?(d=n.items_identified_for_review.some(e=>e.direct_snippets&&0<e.direct_snippets.length),t=d?"direct-snippets":"inconclusive"):"direct-snippets"===c?t="inconclusive":"meta-search"===c&&(t="completed-meta-search"),"inconclusive"===t||"completed-meta-search"===t){o.completeStage(n.progressStage,"(Inconclusive)"),n.finished_at=(new Date).toISOString();var d="completed-meta-search"===t?"":"### Review Inconclusive\n\nThe search results did not provide a definitive answer within the available information and token limits. You may need to refine your query or explore the results manually.";i.states.push({type:COMPLETED,created_at:(new Date).toISOString(),finished_at:(new Date).toISOString(),meta_search_completed:"completed-meta-search"===t,final_answer_content:d}),i.states.forEach(e=>{e.type===COMPLETED&&!e.meta_search_completed&&e.items_identified_for_review&&(e.items_identified_for_review=null),e.items_processed_in_stage&&(e.items_processed_in_stage=null),e.last_batch_promising_items&&(e.last_batch_promising_items=null)}),await updateConfig(r,i,_),_.updateChat&&"function"==typeof _.updateChat&&_.updateChat()}else{n.current_review_stage=t,n.current_batch_index=0,n.items_processed_in_stage={message:[],"code-block":[]},n.total_tokens_processed_in_stage=0,n.total_batches_in_stage=0,n.thinking_chat=null,n.last_batch_promising_items=[];let e;try{e=await chatApi.get(_.widget,n.raw_results_chat_uuid)}catch(e){c=`Failed to get raw search results chat (${n.raw_results_chat_uuid}): `+e.message;return void await handleSearchError(r,i,n,c,_.contentBody,_,o)}var d=extractRawResultsData(e),c=getTokenLimitForStage(n.current_review_stage),{batchItems:c,batchTokenCount:l}=selectBatchForReview(n.items_identified_for_review,n.current_review_stage,n.items_processed_in_stage,c,d,n.last_batch_promising_items);if(0<c.length){c.forEach(e=>{n.items_processed_in_stage[e.source_type]||(n.items_processed_in_stage[e.source_type]=[]),n.items_processed_in_stage[e.source_type].includes(e.id)||n.items_processed_in_stage[e.source_type].push(e.id)}),n.total_tokens_processed_in_stage+=l;l=n.items_identified_for_review.filter(e=>!!("tiny-overviews"===n.current_review_stage&&e.tiny_overview||"short-overviews"===n.current_review_stage&&e.short_overview||"meta-search"===n.current_review_stage&&e.extracted_metadata_fields||"direct-snippets"===n.current_review_stage&&e.direct_snippets)).length,l=(n.total_batches_in_stage=0<c.length?Math.ceil(l/c.length):0,formatReviewBatch(c,d));let a;try{a=await chatApi.get(_.widget,n.parent_thinking_chat_uuid)}catch(e){c=`Failed to get parent thinking chat (${n.parent_thinking_chat_uuid}): `+e.message;return void await handleSearchError(r,i,n,c,_.contentBody,_,o)}if(a){let e=null,t=null;try{var h=n.type+"-"+n.current_review_stage;e=await fetchReviewUserInstructions(h,_),t=await fetchReviewSystemPrompt(h,_,i,n.user_query,n.final_queries)}catch(e){return void await handleSearchError(r,i,n,e.message||"Failed to fetch review prompts for new stage.",_.contentBody,_,o)}d=[],c=(d.push({role:"system",message:"<replace with system message>"}),d.push({role:"user",message:`User's original query: "${n.user_query}"
`+`Generated search queries:
\`\`\`json
${JSON.stringify(n.final_queries,null,2)}
\`\`\``}),d.push({role:"assistant",message:`## Search Results Review - Stage: ${n.current_review_stage}, Batch: ${n.current_batch_index+1}

`+l}),d.push({role:"user",message:e}),d.push({role:"assistant",message:null}),{parentId:a.id,name:`${CHAT_NAME_PREFIX} ${r.id} State: ${n.type}-${n.current_review_stage}-batch-`+(n.current_batch_index+1),systemMessageName:n.type+"-"+n.current_review_stage,systemMessage:t,model:i.data.searchCriteria.aiAssistant,temperature:0,forkedFromMessageId:a.messages[0].id,messages:d});let s;try{s=await chatApi.newChat(_.widget,c)}catch(e){h="Failed to create review thinking chat for new stage: "+e.message;return void await handleSearchError(r,i,n,h,_.contentBody,_,o)}n.thinking_chat={id:s.id,uuid:s.uuid,method:"stream",created_at:(new Date).toISOString(),started_at:null,finished_at:null},n.reviews||(n.reviews=[]),n.reviews.push(n.thinking_chat);l=ChatUtils.getChatMessages(s).find(e=>e.message?.includes("## Search Results Review - Stage:"));l&&(n.formatted_results_message_id=l.id),await updateConfig(r,i,_),_.updateChat&&"function"==typeof _.updateChat&&_.updateChat()}else d=`No thinking chat with the UUID ${n.parent_thinking_chat_uuid} found`,await handleSearchError(r,i,n,d,_.contentBody,_,o)}else await transitionToNextReviewStage(r,i,n,_,o)}}module.exports={processCompletedReviewMessage:processCompletedReviewMessage};
