/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let FIELD_TABLE_MAP=require("../../../constants").FIELD_TABLE_MAP,castJsonExtract=require("../../../../utils/sqlCastingUtils").castJsonExtract;function composeMessagesCTEs(c,e,s,t,a,r,o){if("function"!=typeof c||"function"!=typeof c.raw)throw new TypeError('composeMessagesCTEs: Invalid "db" argument. Expected a Knex database instance.');if("object"==typeof e&&null!==e||null!==e&&"object"!=typeof e&&console.warn('composeMessagesCTEs: "baseQueryBuilder" is not an object or null.'),"object"!=typeof s||null===s)throw new TypeError('composeMessagesCTEs: Invalid "parsedQuery" argument. Expected an object.');if("object"!=typeof t||null===t)throw new TypeError('composeMessagesCTEs: Invalid "parsedOutputs" argument. Expected an object.');if("object"!=typeof a||null===a)throw new TypeError('composeMessagesCTEs: Invalid "matchCTEs" argument. Expected an object.');if("object"!=typeof r||null===r)throw new TypeError('composeMessagesCTEs: Invalid "tableFilters" argument. Expected an object.');e=0<s.keywords.length||0<s.phrases.length,t=t.targetSpecific.messages||[];let i=[],n,p;var l=s.metadataFilters&&s.metadataFilters.length;a.messages?(n=(n=(n=c("cte_matched_messages")).innerJoin("chats","cte_matched_messages.messages_chat_id","chats.id")).innerJoin("groups","chats.group_id","groups.id"),p=l?c.raw("0 as fts_rank"):c.raw("cte_matched_messages.fts_rank as fts_rank"),t.forEach(t=>{var a="string"==typeof t?t:t.field,r=FIELD_TABLE_MAP[a];if(r&&r.outputtable){let e,s=null;if("messages.message"===a&&"object"==typeof t&&!0===t.snippet?.highlight)s="messages_content_snippet",e=c.raw("cte_matched_messages."+s);else if("messages"===r.table||"chats"===r.table)e=c.raw("cte_matched_messages."+r.cteName);else{if("groups"!==r.table)return void console.warn("composeMessagesCTEs: Unexpected field table for output when "+`selecting from cte_matched_messages: ${a}. Skipping.`);e=c.raw("groups."+a.split(".").pop())}s?i.push(c.raw(`'${s}', `+e)):i.push(c.raw(`'${r.cteName}', `+e))}else"object"==typeof t&&t.field&&t.type&&t.field.startsWith("messages.meta.extracted_metadata.")&&(a=t.field.replace(/\./g,"_"),r=c.raw("cte_matched_messages."+a),i.push(c.raw(`'${a}', `+r)))})):(n=(n=c("messages").innerJoin("chats","messages.chat_id","chats.id")).innerJoin("groups","chats.group_id","groups.id"),p=c.raw("0 as fts_rank"),r.messages&&Object.keys(r.messages).length,t.forEach(s=>{var t="string"==typeof s?s:s.field,a=FIELD_TABLE_MAP[t];if(a&&a.outputtable){let e;if("messages.message"===t&&"object"==typeof s&&s.snippet){var r=s.snippet.maxLength||200,o=(e=c.raw("messages.message"),FIELD_TABLE_MAP["messages.message.snippet"]);i.push(c.raw(`'${o.cteName}', substr(messages.message, 1, ?)`,[r]))}else if(a.jsonPath)e=a.sortable&&a.sqlType?castJsonExtract(c,a.table,"meta",a.jsonPath,a.sqlType):c.raw(`json_extract(${a.table}.meta, '${a.jsonPath}')`);else if("object"==typeof s&&s.field&&s.type&&s.field.startsWith("messages.meta.extracted_metadata.")){var o=s.field,r=s.type,n="$.extracted_metadata."+o.substring("messages.meta.extracted_metadata.".length),r="string"===r?"TEXT":"number"===r?"REAL":"boolean"===r?"INTEGER":"TEXT",o=o.replace(/\./g,"_"),n=castJsonExtract(c,"messages","meta",n,r);i.push(c.raw(`'${o}', `+n))}else if("messages"===a.table)e=c.raw("messages."+t.split(".").pop());else if("chats"===a.table)e=c.raw("chats."+t.split(".").pop());else{if("groups"!==a.table)return void console.warn("composeMessagesCTEs: Unexpected field table for output "+`when selecting from base tables: ${t}. Skipping.`);e=c.raw("groups."+t.split(".").pop())}"messages.message"===t&&"object"==typeof s&&s.snippet||i.push(c.raw(`'${a.cteName}', `+e))}})),n=n.select([c.raw(`json_object(${i.map(e=>e.toString()).join(", ")}) as result_json`),p,a.messages?c.raw("cte_matched_messages.messages_chat_id as result_chat_id"):c.raw("chats.id as result_chat_id"),c.raw("'message' as source_type"),c.raw("ROW_NUMBER() OVER () as row_num")]);let m=[];return s.sortBy&&Array.isArray(s.sortBy)&&s.sortBy.forEach(e=>{let s=e.field;if(!e.field.includes(".")){var t,a=[];for(t in FIELD_TABLE_MAP)t.split(/\./).pop()===s&&a.push(t);1===a.length&&(s=a[0])}var r=FIELD_TABLE_MAP[s];r&&r.sortable&&("messages"===r.table||"chats"===r.table)&&m.push({column:r.cteName,order:e.direction})}),0!==m.length||l||(e?m.push({column:"fts_rank",order:"asc"}):m.push({column:"messages.updated_at",order:"desc"})),n.orderBy(m),s.pagination?.limit&&n.limit(s.pagination.limit),n}module.exports={composeMessagesCTEs:composeMessagesCTEs};
