/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let fs=require("fs").promises,path=require("path"),knex=require("knex"),SearchParser=require("./SearchParser"),SearchBuilder=require("./SearchBuilder"),SearchExecutor=require("./SearchExecutor"),{readPromptTemplate,loadAndFormatAllProfiles,loadAndFormatAllAnalyzersForPrompt,readMarkdownContentAfterHeader}=require("./utils/promptUtils"),{getAvailableGitReposAndBranches,formatGitReposAndBranchesForPrompt,getGitChatTypesFromSchema,formatGitChatTypesForPrompt}=require("./utils/gitInfoUtils"),{getAnalyzerSchema,getDBPath}=require("../Dependencies"),BASE_ANALYZERS_DIR=require("../constants").BASE_ANALYZERS_DIR,{QUERY_OPTIMIZATION,RESULTS_REVIEW_ORCHESTRATION}=require("../../common/gitsense/searchStates"),DEBUG_QUERY="TRUE"===process.env.GSC_DEBUG_QUERY?.toUpperCase(),DEBUG_PARSER="TRUE"===process.env.GSC_DEBUG_PARSER?.toUpperCase(),DEBUG_BUILDER="TRUE"===process.env.GSC_DEBUG_BUILDER?.toUpperCase(),DEBUG_EXECUTOR="TRUE"===process.env.GSC_DEBUG_EXECUTOR?.toUpperCase(),search=async r=>{var{query:r,"current-chat-id":t,"results-per-page":e,page:s}=r,a=knex({client:"sqlite3",connection:{filename:getDBPath()},useNullAsDefault:!0}),i=new SearchParser,o=new SearchBuilder(a),n=new SearchExecutor(a);try{DEBUG_QUERY&&(console.log("QUERY"),console.log(r));var l=await i.parse(r,{resultsPerPage:e,page:s});if(DEBUG_PARSER&&(console.log("PARSED QUERY"),console.log(JSON.stringify(l,null,2))),l.isMetaInsights){if(!l.insightFields||0===l.insightFields.length)throw new Error("Meta-insights profile requires at least one insight field.");var c=l.analyzerSchema||await getAnalyzerSchema(BASE_ANALYZERS_DIR,l.analyzerId);if(!c)throw new Error(`Could not retrieve schema for analyzer ID '${l.analyzerId}'.`);var E,R={};let e=0;for(E of l.insightFields){var S,u={...l,insightField:E.field,insightFieldType:E.type,insightFields:void 0},h=(DEBUG_PARSER&&(console.log("PARSED QUERY (SINGLE INSIGHT FOR BUILDER)"),console.log(JSON.stringify(u,null,2))),await o.build(u,t,"main")),p=(DEBUG_BUILDER&&(console.log("SEARCH BUILDER CRITERIA (SINGLE INSIGHT)"),console.log(JSON.stringify(h.searchCriteria,null,2))),await n.execute(h));DEBUG_EXECUTOR&&(console.log(`SEARCH EXECUTOR RESULTS (SINGLE INSIGHT: ${E.field})`),console.log(JSON.stringify(p,null,2))),Array.isArray(p.results)?(R[E.field]=p.results,S=c.properties[E.field],R[E.field]={description:S?.description,results:p.results},e+=p.results.length):(console.warn(`SearchExecutor for insight field '${E.field}' did not return an array of results.`),R[E.field]=[])}return{status:"success",data:{query:r,searchCriteria:l,results:R,totalResultsReturned:e,pagination:{currentPage:1,totalPages:1,totalResults:e,resultsPerPage:e}}}}var d=await o.build(l,t,"main"),T=(DEBUG_BUILDER&&(console.log("SEARCH BUILDER CRITERIA"),console.log(JSON.stringify(d.searchCriteria,null,2)),console.log("SEARCH BUILDER OUTPUT"),console.log(JSON.stringify(d.finalTopLevelOutputs,null,2))),await n.execute(d)),I=(T.query=r,DEBUG_EXECUTOR&&(console.log("SEARCH EXECUTOR RESULTS"),console.log(JSON.stringify(T,null,2))),d.originalSnippetsRequested);if(I&&0<T.totalResultsReturned){var g=T.results.messages.map(e=>e.messages_id),m=T.results.codeBlocks.map(e=>code_blocks_id);if(0===g.length&&0===m.length)T.searchCriteria=l;else{let e=r;0<g.length&&(e+=" msg-id:"+g.join(",")),0<m.length&&(e+=" block-id:"+m.join(",")),DEBUG_QUERY&&(console.log("SNIPPET QUERY"),console.log(e));var _=i.parse(e,{}),U=await o.build(_,t,"snippets"),O=await n.execute(U);T.results=O.results}}return{status:"success",data:T}}catch(e){return console.trace(e),console.error("Search Error: "+e.message||e),{status:"failed",error:e.message||e}}finally{await a.destroy()}},generateSearchSystemPrompt=async r=>{var{"instruction-set":t,"user-query":s,"generated-query":a,"current-chat-id":i}=r,r={[QUERY_OPTIMIZATION]:QUERY_OPTIMIZATION+"-instructions.md",[RESULTS_REVIEW_ORCHESTRATION+"-meta-insights"]:RESULTS_REVIEW_ORCHESTRATION+"-instructions-meta-insights.md",[RESULTS_REVIEW_ORCHESTRATION+"-meta-search"]:RESULTS_REVIEW_ORCHESTRATION+"-instructions-meta-search.md",[RESULTS_REVIEW_ORCHESTRATION+"-tiny-overviews"]:RESULTS_REVIEW_ORCHESTRATION+"-instructions-tiny-overviews.md",[RESULTS_REVIEW_ORCHESTRATION+"-short-overviews"]:RESULTS_REVIEW_ORCHESTRATION+"-instructions-short-overviews.md",[RESULTS_REVIEW_ORCHESTRATION+"-direct-snippets"]:RESULTS_REVIEW_ORCHESTRATION+"-instructions-direct-snippets.md"}[t];if(!r)throw new Error("Unsupported search prompt instruction set: "+t);var o=knex({client:"sqlite3",connection:{filename:getDBPath()},useNullAsDefault:!0});try{let e=await readPromptTemplate(r);switch(t){case QUERY_OPTIMIZATION:case RESULTS_REVIEW_ORCHESTRATION+"-meta-insights":case RESULTS_REVIEW_ORCHESTRATION+"-meta-search":case RESULTS_REVIEW_ORCHESTRATION+"-tiny-overviews":case RESULTS_REVIEW_ORCHESTRATION+"-short-overviews":case RESULTS_REVIEW_ORCHESTRATION+"-direct-snippets":let r="No specific chat context available.";if(null!=i){var n=await o("chats").select("type","meta","parent_id").where("id",i).first();if(n&&(r=`You are currently in a chat of type: \`${n.type}\`.`,n.type.startsWith("git-")))try{var l,c,E=JSON.parse(n.meta);"git-repo"===n.type&&E.owner&&E.name?r+=` This chat is associated with the Git repository: \`${E.owner}/${E.name}\`.`:"git-ref"===n.type&&"branch"===E.type&&E.name&&n.parent_id&&(l=await o("chats").select("meta").where("id",n.parent_id).first())&&l.meta&&(c=JSON.parse(l.meta)).owner&&c.name&&(r+=` This chat is associated with the \`${E.name}\` branch in the Git repository: \`${c.owner}/${c.name}\`.`)}catch(e){console.error(`Error parsing meta for current chat ID ${i}:`,e),r+=" (Error retrieving detailed Git context.)"}}var R=await loadAndFormatAllProfiles(),S=await getAvailableGitReposAndBranches(o),u=formatGitReposAndBranchesForPrompt(S),h=await getGitChatTypesFromSchema(),p=await loadAndFormatAllAnalyzersForPrompt(),d=formatGitChatTypesForPrompt(h);e=(e=(e=(e=(e=(e=(e=e.replace("[User's original natural language query goes here]",s)).replace("[LLM-generated structured search query goes here]",a)).replace("[Placeholder for current chat context]",r)).replace("[Placeholder for the formatted list of available search profiles]",R)).replace("[Placeholder for the formatted list of available Git repositories and branches]",u)).replace("[Placeholder for the formatted list of available GitSense Chat Analyzers]",p)).replace("[Placeholder for the list of supported git-* chat types]",d);break;default:throw new Error("Unsupported search prompt instruction set: "+t)}return{status:"success",data:e}}catch(e){throw console.error("Error generating search system prompt:",e),new Error("Failed to generate search system prompt.")}finally{await o.destroy()}},getSearchUserInstruction=async e=>{var e=e["instruction-set"],r={[QUERY_OPTIMIZATION]:QUERY_OPTIMIZATION+"-user-instructions.md",[RESULTS_REVIEW_ORCHESTRATION+"-meta-insights"]:RESULTS_REVIEW_ORCHESTRATION+"-user-instructions-meta-insights.md",[RESULTS_REVIEW_ORCHESTRATION+"-meta-search"]:RESULTS_REVIEW_ORCHESTRATION+"-user-instructions-meta-search.md",[RESULTS_REVIEW_ORCHESTRATION+"-tiny-overviews"]:RESULTS_REVIEW_ORCHESTRATION+"-user-instructions-tiny-overviews.md",[RESULTS_REVIEW_ORCHESTRATION+"-short-overviews"]:RESULTS_REVIEW_ORCHESTRATION+"-user-instructions-short-overviews.md",[RESULTS_REVIEW_ORCHESTRATION+"-direct-snippets"]:RESULTS_REVIEW_ORCHESTRATION+"-user-instructions-direct-snippets.md"}[e];if(!r)throw new Error("Unsupported search instructionSet: "+e);try{return{status:"success",data:await readPromptTemplate(r)}}catch(e){return console.error(`Error reading user instruction file "${r}":`,e),{status:"failed",error:"Failed to retrieve user instructions: "+e.message}}},getSearchHelp=async e=>{var r=path.join(__dirname,"../../docs/gitsense/search-help.md");try{return{status:"success",data:await fs.readFile(r,"utf8")}}catch(e){return{status:"failed",data:e}}};module.exports={search:search,generateSearchSystemPrompt:generateSearchSystemPrompt,getSearchUserInstruction:getSearchUserInstruction,getSearchHelp:getSearchHelp};
