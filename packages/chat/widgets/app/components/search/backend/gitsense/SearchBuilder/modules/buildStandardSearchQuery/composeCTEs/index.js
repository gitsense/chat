/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let buildChatMessageStatsCTE=require("../../cteBuilders/buildChatMessageStatsCTE").buildChatMessageStatsCTE,composeChatsCTEs=require("./composeChatsCTEs").composeChatsCTEs,composeMessagesCTEs=require("./composeMessagesCTEs").composeMessagesCTEs,composeCodeBlocksCTEs=require("./composeCodeBlocksCTEs").composeCodeBlocksCTEs,applyTableFilters=require("../tableMatcherUtils").applyTableFilters,buildRecursiveChatPathCTE_RawSqlPart=require("../../cteBuilders/buildRecursiveChatPathCTE_RawSqlPart").buildRecursiveChatPathCTE_RawSqlPart,FIELD_TABLE_MAP=require("../../../constants").FIELD_TABLE_MAP,DEBUG="TRUE"===process.env.GSC_DEBUG?.toUpperCase();async function composeCTEs(e,t,s,a,c,l,o,r){if("function"!=typeof e||"function"!=typeof e.raw)throw new TypeError('composeCTEs: Invalid "db" argument. Expected a Knex database instance.');if("object"!=typeof t||null===t)throw new TypeError('composeCTEs: Invalid "coreSearchQueryBuilder" argument. Expected an object.');if(!Array.isArray(s))throw new TypeError('composeCTEs: Invalid "mainTables" argument. Expected an array.');if("object"!=typeof a||null===a)throw new TypeError('composeCTEs: Invalid "parsedQuery" argument. Expected an object.');if("object"!=typeof c||null===c)throw new TypeError('composeCTEs: Invalid "parsedOutputs" argument. Expected an object.');if("object"!=typeof l||null===l)throw new TypeError('composeCTEs: Invalid "tableFilters" argument. Expected an object.');if("string"!=typeof o&&null!==o)throw new TypeError('composeCTEs: Invalid "filterChatIdsCteName" argument. Expected a string or null.');if("object"!=typeof r&&null!==r)throw new TypeError('composeCTEs: Invalid "filterCteQuery" argument. Expected a Knex query builder or null.');var{baseQueryBuilder:s,matchCTEs:t}=t;let _=e.queryBuilder(),h=(o&&r&&(_=_.with(o,r)),t.messages&&(_=_.with("cte_matched_messages",t.messages)),t.cte_matched_chats&&(_=_.with("cte_matched_chats",t.cte_matched_chats)),_=(_=t.cte_matched_code_blocks?_.with("cte_matched_code_blocks",t.cte_matched_code_blocks):_).with("cte_chat_message_stats",buildChatMessageStatsCTE(e,"chats")),null),i=null,u=null;r=a.targets||[];if(r.includes("chats")&&(h=composeChatsCTEs(e,s,a,c,t,l,o),_=_.with("cte_chats_limited_results",h)),r.includes("messages")&&(i=composeMessagesCTEs(e,s,a,c,t,l,o),_=_.with("cte_messages_limited_results",i)),r.includes("code-blocks"))u=composeCodeBlocksCTEs(e,s,a,c,t,l,o),_=_.with("cte_code_blocks_limited_results",u);else if(0===r.length)throw new Error("composeCTEs: No targets specified.");let m=null,d=(h&&(m=e.queryBuilder().from("cte_chats_limited_results").select("*")),i&&(s=e.queryBuilder().from("cte_messages_limited_results").select("*"),m=m?m.unionAll(s):s),u&&(a=e.queryBuilder().from("cte_code_blocks_limited_results").select("*"),m=m?m.unionAll(a):a),_=_.with("cte_matched_results",m),e.queryBuilder().from("cte_matched_results").whereNotNull("result_chat_id"));DEBUG&&(console.log("TABLE_FILTERS"),console.log(JSON.stringify(l,null,2))),d=l.chats&&0<Object.keys(l.chats).length&&(0<Object.keys(l.chats.filters||{}).length||0<Object.keys(l.chats.nullFilters||{}).length||0<Object.keys(l.chats.notNullFilters||{}).length)?(d=e.queryBuilder().from("cte_matched_results").join("chats","cte_matched_results.result_chat_id","chats.id"),(d=applyTableFilters(e,d,l.chats.filters||{},l.chats.nullFilters||{},l.chats.notNullFilters||{},"chats")).select(e.raw("DISTINCT chats.id as chat_id"))):d.select(e.raw("DISTINCT result_chat_id as chat_id")),_=_.with("cte_result_chat_ids",d);c=buildRecursiveChatPathCTE_RawSqlPart(e,"cte_result_chat_ids");_=_.with("chat_path",c);let n=e.queryBuilder().select(e.raw("0 as total_chat_matches, 0 as total_message_matches, 0 as total_code_block_matches"));t.cte_matched_chats&&(o=e.queryBuilder().from("cte_matched_chats").select(e.raw("COUNT(*) as total_chat_matches, 0 as total_message_matches, 0 as total_code_block_matches")),n=n.unionAll(o)),t.messages&&(r=e.queryBuilder().from("cte_matched_messages").select(e.raw("0 as total_chat_matches, COUNT(*) as total_message_matches, 0 as total_code_block_matches")),n=n.unionAll(r)),t.cte_matched_code_blocks&&(s=e.queryBuilder().from("cte_matched_code_blocks").select(e.raw("0 as total_chat_matches, 0 as total_message_matches, COUNT(*) as total_code_block_matches")),n=n.unionAll(s));a=e.queryBuilder().from(n.as("counts_union")).select(e.raw("SUM(total_chat_matches) as total_chat_matches, SUM(total_message_matches) as total_message_matches, SUM(total_code_block_matches) as total_code_block_matches"));return{finalQuery:(_=_.with("cte_total_counts",a)).from("cte_matched_results as t1").orderBy([{column:"row_num",order:"asc"},{column:"result_chat_id",order:"asc"}]).leftJoin("chat_path as t2","t1.result_chat_id","t2.original_chat_id").crossJoin("cte_total_counts as t3").select("t1.result_json","t1.source_type","t1.fts_rank","t1.row_num","t2.path","t3.total_chat_matches","t3.total_message_matches","t3.total_code_block_matches")}}module.exports={composeCTEs:composeCTEs};
