/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let{sortKidsCriteria,chevronRightSvg,chevronDownSvg}=require("../constants"),createRow=require("./row/tableRow").createRow,{findNodeById,findLatestChild,getPathToNode,sortNodes}=require("../utils/treeUtils"),updateRow=require("./row/tableRow").updateRow,highlightRow=require("./row/tableRow").highlightRow;async function handleNodeExpansion(t){let{nodeId:a,button:d,container:l,state:s,decorator:i,columns:c,handlers:h}=t,n=l.querySelector(`tr[data-id="${a}"]`);if(n){let e=s.findNodeById(a);if(e){if(!("git-ref"!==e.type||e.kids&&0!==e.kids.length||s.hasFetchedDescendants(a))&&h.chatApi?.getGitRefChatDescendants){var t=e.name,o=n.querySelector(".node-name")?.childNodes?.[0]||null;o&&(o.innerText=t+" (fetching descendants...)");try{s.addFetchedDescendants(a);var r=await h.chatApi.getGitRefChatDescendants(a);s.addChildrenToNode(a,r)}finally{o.innerText=t}}r="collapsed"===d.dataset.state||"false"===d.dataset.expanded;if(r?(d.innerHTML=chevronDownSvg,d.dataset.state="expanded",d.dataset.expanded="true"):(d.innerHTML=chevronRightSvg,d.state="collapsed",d.dataset.expanded="false"),s.toggleNodeExpansion(a),r){let t=l.querySelector(`tr[data-id="${a}"]`);if(t){s.getData();let e=findNodeById(s.getNodeMap(),a);if(e&&e.kids){o=sortNodes([...e.kids],sortKidsCriteria);let r=s.getExpandedDescendants(a);o.forEach(e=>{!function t(a,d,e){let n=l.querySelector(`tr[data-id="${a.id}"]`);var o;n?n.classList.remove("hidden"):(n=createRow({node:a,level:d,decorator:i,handlers:h,parentId:e,columns:c,isExpanded:s.isNodeExpanded(a.id)}),(0<(o=l.querySelectorAll(`tr[data-parent="${e}"]`)).length?o[o.length-1]:l.querySelector(`tr[data-id="${e}"]`)).insertAdjacentElement("afterend",n)),r.includes(a.id)&&a.kids&&((o=n.querySelector(".expand-button"))&&(o.innerHTML=chevronDownSvg,o.dataset.state="expanded",o.dataset.expanded="true"),a.kids.forEach(e=>{t(e,d+1,a.id)}))}(e,parseInt(t.dataset.level)+1,a)})}}}else getAllDescendantRows(l,a).forEach(e=>e.classList.add("hidden"))}}}function updateChildCheckboxes(t,e,a){let d=[];!function a(e){t.querySelectorAll(`tr[data-parent="${e}"]`).forEach(e=>{var t=e.dataset.id;(e=e.querySelector('input[type="checkbox"]'))&&!e.disabled&&(d.push(e),a(t))})}(e),d.forEach(e=>e.checked=a);e=new CustomEvent("checkbox-batch-update",{detail:{checkboxes:d,isSelected:a}});t.dispatchEvent(e)}function getAllDescendantRows(t,e){let a=[];return t.querySelectorAll(`tr[data-parent="${e}"]`).forEach(e=>{a.push(e);e=getAllDescendantRows(t,e.dataset.id);a.push(...e)}),a}function handleExpandToChild(e){let{rootNodeId:t,childNodeId:d,data:a,container:n,state:o,decorator:r,columns:l,handlers:s}=e;var i,e=a.find(e=>e.id===t);if(e){let a=getPathToNode(e,d);if(a)return a.forEach((e,t)=>{t<a.length-1&&(t=n.querySelector(`tr[data-id="${e}"]`))&&(t=t.querySelector(".expand-button"))&&("collapsed"===t.dataset.state||"false"===t.dataset.expanded)&&handleNodeExpansion({nodeId:e,button:t,container:n,state:o,decorator:r,columns:l,handlers:s})}),(i=n.querySelector(`tr[data-id="${d}"]`))&&0!==e.parent_id&&(i.scrollIntoView({behavior:"smooth",block:"center"}),highlightRow(i)),i}}function handleExpandToLatest(t){let{rootNodeId:a,data:e,container:d,state:n,decorator:o,columns:r,handlers:l}=t;var t=e.find(e=>e.id===a);if(t){let{latestNode:e,path:a}=findLatestChild(t);e&&(a.forEach((e,t)=>{t<a.length-1&&(t=d.querySelector(`tr[data-id="${e}"]`))&&(t=t.querySelector(".expand-button"))&&("collapsed"===t.dataset.state||"false"===t.dataset.expanded)&&handleNodeExpansion({nodeId:e,button:t,container:d,state:n,decorator:o,columns:r,handlers:l})}),t=d.querySelector(`tr[data-id="${e.id}"]`))&&(t.scrollIntoView({behavior:"smooth",block:"center"}),highlightRow(t))}}function handleExpandAllNodesWithChildren(e){let{container:a,state:d}=e;d.expandAllNodesWithChildren(),a.querySelectorAll("tr").forEach(e=>{var t=e.dataset.id;d.isNodeExpanded(t)&&(e=e.querySelector(".expand-button"))&&("collapsed"===e.dataset.state||"false"===e.dataset.expanded)&&(e.innerHTML=chevronDownSvg,e.dataset.state="expanded",e.dataset.expanded="true",a.querySelectorAll(`tr[data-parent="${t}"]`).forEach(e=>e.classList.remove("hidden")))})}module.exports={handleNodeExpansion:handleNodeExpansion,handleExpandToChild:handleExpandToChild,handleExpandToLatest:handleExpandToLatest,handleExpandAllNodesWithChildren:handleExpandAllNodesWithChildren};
