/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let Dropdown=require("../../../../../../../Dependencies").Dropdown,MetadataFilterConfig=require("./MetadataFilterConfig"),MetadataFilterState=require("./MetadataFilterState");class MetadataFilterUI{constructor(e,t,n){e||console.error("MetadataFilterUI: Container element is required."),t||console.error("MetadataFilterUI: MetadataFilterState instance is required."),n||console.error("MetadataFilterUI: MetadataFilterConfig instance is required."),this.container=e,this.state=t,this.config=n,this.uiElements={},this.uiElements.analyzerDropdown=null,this._ruleDomMap=new Map}renderInitialStructure(){this.uiElements.addConditionLink=this.container.querySelector(".add-metadata-condition-link"),this.uiElements.rulesContainer=this.container.querySelector(".metadata-filter-rules-container"),this.uiElements.resetLink=this.container.querySelector(".reset-metadata-filter-link"),this.uiElements.saveLink=this.container.querySelector(".load-metadata-query-link"),this.uiElements.editLink=this.container.querySelector(".edit-metadata-query-link"),this.uiElements.messageContainer=this.container.querySelector(".metadata-filter-message"),this.uiElements.helpLink=this.container.querySelector(".help-metadata-query-link");var e=this.container.querySelector(".metadata-analyzer-select");e&&e.parentElement?(this.uiElements.analyzerDropdownContainer=document.createElement("div"),this.uiElements.analyzerDropdownContainer.className="metadata-analyzer-dropdown-container",e.parentElement.insertBefore(this.uiElements.analyzerDropdownContainer,e),e.parentElement.removeChild(e)):(this.uiElements.analyzerDropdownContainer=document.createElement("div"),this.uiElements.analyzerDropdownContainer.className="metadata-analyzer-dropdown-container",(e=this.container.querySelector(".metadata-filter-controls"))&&this.uiElements.addConditionLink?e.insertBefore(this.uiElements.analyzerDropdownContainer,this.uiElements.addConditionLink):this.container&&this.container.appendChild(this.uiElements.analyzerDropdownContainer));let t=this.container.querySelector(".metadata-apply-button-container");t||((t=document.createElement("div")).className="metadata-apply-button-container",this.container.appendChild(t)),this.uiElements.resetButton=t.querySelector(".metadata-filter-reset-button"),this.uiElements.resetButton||(this.uiElements.resetButton=document.createElement("button"),this.uiElements.resetButton.className="secondary-button metadata-filter-reset-button",this.uiElements.resetButton.textContent="Reset Filter",(e=t.querySelector(".metadata-filter-apply-button"))?t.insertBefore(this.uiElements.resetButton,e):t.appendChild(this.uiElements.resetButton)),this.uiElements.insightsButton=t.querySelector(".metadata-filter-insights-button"),this.uiElements.insightsButton||(this.uiElements.insightsButton=document.createElement("button"),this.uiElements.insightsButton.className="secondary-button metadata-filter-insights-button metadata-filter-insights-button-disabled",this.uiElements.insightsButton.textContent="Insights",(e=t.querySelector(".metadata-filter-apply-button"))?t.insertBefore(this.uiElements.insightsButton,e):t.appendChild(this.uiElements.insightsButton)),this.uiElements.applyButton=t.querySelector(".metadata-filter-apply-button"),this.uiElements.applyButton||(this.uiElements.applyButton=document.createElement("button"),this.uiElements.applyButton.className="secondary-button metadata-filter-apply-button metadata-filter-apply-button-disabled",this.uiElements.applyButton.textContent="Apply Filter",t.appendChild(this.uiElements.applyButton)),t.style.display="none",this.uiElements.addConditionLink&&(this.uiElements.addConditionLink.style.pointerEvents="none",this.uiElements.addConditionLink.style.opacity="0.5")}populateAnalyzerDropdown(e,n){if(this.uiElements.analyzerDropdownContainer){this.uiElements.analyzerDropdown&&"function"==typeof this.uiElements.analyzerDropdown.destroy&&(this.uiElements.analyzerDropdown.destroy(),this.uiElements.analyzerDropdown=null,this.uiElements.analyzerDropdownContainer.innerHTML="");let t=[this.config.defaultAnalyzerOption];e.forEach(e=>{t.push({value:e.id,text:e.label})}),this.uiElements.analyzerDropdown=new Dropdown(this.uiElements.analyzerDropdownContainer,{options:t,initialValue:this.state.getSelectedAnalyzerId()||""},n)}else console.error("MetadataFilterUI: Analyzer dropdown container not found.")}getAnalyzerDropdownValue(){return this.uiElements.analyzerDropdown?this.uiElements.analyzerDropdown.getValue():null}setAnalyzerDropdownValue(e,t=!0){this.uiElements.analyzerDropdown&&this.uiElements.analyzerDropdown.setValue(e,t)}populateFieldDropdown(a){let i=this.state.getCurrentAnalyzerSchema();var e;a&&i&&i.properties&&(a.innerHTML="",(e=document.createElement("option")).value=this.config.defaultFieldOption.value,e.textContent=this.config.defaultFieldOption.text,a.appendChild(e),Object.keys(i.properties).forEach(e=>{var t=i.properties[e],n=document.createElement("option");n.value=e,n.textContent=t.title||e,a.appendChild(n)}))}populateOperatorDropdown(n,e){n&&(n.innerHTML="",(this.config.operators[e]||this.config.operators.any).forEach(e=>{var t=document.createElement("option");t.value=e.value,t.textContent=e.text,n.appendChild(t)}))}_createRuleRow(e){var t=document.createElement("div");return t.className="metadata-filter-rule-row",t.dataset.ruleId=e.id,t.innerHTML=`
            <select class="metadata-field-select"></select>
            <select class="metadata-operator-select"></select>
            <div class="metadata-value-input-area">
                <!-- Input element(s) or dropdown will be added here dynamically -->
                <span class="metadata-value-count"></span>
            </div>
            <span class="metadata-value-type-indicator"></span>
            <a href="#" class="fetch-metadata-values-link">Fetch Values</a>
            <button class="remove-metadata-condition-button">&times;</button>
        `,this.uiElements.rulesContainer.appendChild(t),this._ruleDomMap.set(e.id,t),t}_removeRuleRow(e){var t=this._ruleDomMap.get(e);t&&t.parentElement&&(t.parentElement.removeChild(t),this._ruleDomMap.delete(e))}renderRules(e){if(this.uiElements.rulesContainer){var n=new Set(Array.from(this._ruleDomMap.keys()));let t=new Set(e.map(e=>e.id));n.forEach(e=>{t.has(e)||this._removeRuleRow(e)}),e.forEach(e=>{let t=this._ruleDomMap.get(e.id);var n=(t=t||this._createRuleRow(e)).querySelector(".metadata-field-select"),a=t.querySelector(".metadata-operator-select"),i=t.querySelector(".metadata-value-input-area"),s=t.querySelector(".metadata-value-type-indicator"),l=t.querySelector(".fetch-metadata-values-link"),o=t.querySelector(".remove-metadata-condition-button"),n=(this.populateFieldDropdown(n),n&&e.field&&(n.value=e.field),this.state.getCurrentAnalyzerSchema()),n=n&&n.properties?n.properties[e.field]:null,r=n?n.type:"any";s.textContent=n?`(${n.type})`:"",this.populateOperatorDropdown(a,r),a&&e.operator&&(a.value=e.operator),this.updateValueInputArea(i,r,e.operator,n,e.value,t),l&&(s=!!e.field,a="string"===r||"boolean"===r,i=!["is_null","is_not_null"].includes(e.operator),l.style.display=s&&a&&i?"inline":"none"),o&&(o.style.display="inline-block")}),this.updateApplyButtonState()}}getRuleElements(){return this.uiElements.rulesContainer?Array.from(this.uiElements.rulesContainer.querySelectorAll(".metadata-filter-rule-row")):[]}updateValueInputArea(e,t,n,a,i=null,s){var l,o,r;e&&(e.innerHTML="","is_null"===n||"is_not_null"===n?((o=document.createElement("span")).textContent="- no value needed -",o.style.fontStyle="italic",e.appendChild(o)):("range"===n&&"number"===t?((o=document.createElement("input")).type="number",o.placeholder="Min",o.className="metadata-value-input-min",null!==i&&"object"==typeof i&&i.hasOwnProperty("min")&&(o.value=null!==i.min?i.min:""),(l=document.createElement("span")).textContent=" to ",(r=document.createElement("input")).type="number",r.placeholder="Max",r.className="metadata-value-input-max",null!==i&&"object"==typeof i&&i.hasOwnProperty("max")&&(r.value=null!==i.max?i.max:""),e.appendChild(o),e.appendChild(l),e.appendChild(r)):"boolean"===t?((o=document.createElement("select")).className="metadata-value-input",(l=document.createElement("option")).value="",l.textContent=this.config.defaultValueOption.text,o.appendChild(l),(r=document.createElement("option")).value="true",r.textContent="True",o.appendChild(r),(l=document.createElement("option")).value="false",l.textContent="False",o.appendChild(l),null!==i&&(o.value=String(i)),e.appendChild(o)):"string"===t||"number"===t||"any"===t||"array"===t&&("is"===n||"is_not"===n)?((r=document.createElement("input")).id=t+":"+(new Date).getTime(),r.type="number"===t&&"range"!==n?"number":"text",r.placeholder=`Enter value or click 'Fetch Values' to load available choices (${t})`,r.className="metadata-value-input",null!==i&&(r.value=String(i)),e.appendChild(r)):"array"!==t||"includes"!==n&&"excludes"!==n||((l=document.createElement("input")).id=t+":"+(new Date).getTime(),l.type="text",l.placeholder=`Enter comma-separated values (e.g., val1, val2) (${t})`,l.className="metadata-value-input",null!==i&&(l.value=Array.isArray(i)?i.join(", "):String(i)),e.appendChild(l)),(o=e.querySelector(".metadata-value-count"))?o.textContent="":((r=document.createElement("span")).className="metadata-value-count",e.appendChild(r)),n=new CustomEvent("valueInputAreaUpdated",{detail:{ruleId:s.dataset.ruleId}}),s.dispatchEvent(n)))}populateValueDropdown(e,t,n=null,a){if(e){e.innerHTML="";var i,s,l=document.createElement("select"),o=(l.className="metadata-value-input",document.createElement("option"));o.value="",o.textContent=this.config.defaultValueOption.text,l.appendChild(o);for([i,s]of t.entries()){var r=document.createElement("option"),u=null===i?"--NULL--":String(i);r.value=u,r.textContent=`${u} (${s})`,l.appendChild(r)}null!==n&&(l.value=null===n?"--NULL--":String(n)),e.appendChild(l);o=new CustomEvent("valueInputAreaUpdated",{detail:{ruleId:a.dataset.ruleId}});a.dispatchEvent(o)}}updateApplyButtonState(){var e,t,n=this.container.querySelector(".metadata-apply-button-container");n&&this.uiElements.applyButton&&this.uiElements.insightsButton&&(e=!!this.state.getSelectedAnalyzerId(),t=0<this.getRuleElements().length,e&&t?(n.style.display="flex",null!==this.state.getFilterState()?(this.uiElements.applyButton.classList.remove("secondary-button"),this.uiElements.applyButton.classList.remove("metadata-filter-apply-button-disabled"),this.uiElements.applyButton.classList.add("primary-button"),this.uiElements.applyButton.disabled=!1):(this.uiElements.applyButton.classList.remove("primary-button"),this.uiElements.applyButton.classList.add("secondary-button"),this.uiElements.applyButton.classList.add("metadata-filter-apply-button-disabled"),this.uiElements.applyButton.disabled=!0),0<this.state.getUniqueSelectedFields().size?(this.uiElements.insightsButton.classList.remove("metadata-filter-insights-button-disabled"),this.uiElements.insightsButton.disabled=!1):(this.uiElements.insightsButton.classList.add("metadata-filter-insights-button-disabled"),this.uiElements.insightsButton.disabled=!0),this.uiElements.resetButton&&(this.uiElements.resetButton.disabled=!1)):(n.style.display="none",this.uiElements.resetButton&&(this.uiElements.resetButton.disabled=!0),this.uiElements.applyButton&&(this.uiElements.applyButton.disabled=!0),this.uiElements.insightsButton&&(this.uiElements.insightsButton.disabled=!0)))}setSearchInProgress(t){var e;this.uiElements.applyButton&&((this.uiElements.applyButton.disabled=t)&&"Applying..."!==this.uiElements.applyButton.textContent?this.uiElements.applyButton.textContent="Applying...":this.uiElements.applyButton.textContent="Apply Filter"),this.container.querySelectorAll("select, input, textarea, a, button").forEach(e=>{e!==this.uiElements.applyButton&&e!==this.uiElements.resetButton&&e!==this.uiElements.insightsButton&&(e.disabled=t)}),this.uiElements.addConditionLink&&(t?(this.uiElements.addConditionLink.style.pointerEvents="none",this.uiElements.addConditionLink.style.opacity="0.5"):(e=!!this.state.getSelectedAnalyzerId(),this.uiElements.addConditionLink.style.pointerEvents=e?"auto":"none",this.uiElements.addConditionLink.style.opacity=e?"1":"0.5"))}showSearchMessage(e,t=!1){this.uiElements.messageContainer&&(this.uiElements.messageContainer.textContent=e,this.uiElements.messageContainer.className=t?"metadata-filter-message error":"metadata-filter-message info",this.uiElements.messageContainer.style.display="block")}hideSearchMessage(){this.uiElements.messageContainer&&(this.uiElements.messageContainer.textContent="",this.uiElements.messageContainer.className="metadata-filter-message",this.uiElements.messageContainer.style.display="none")}clearRules(){this.uiElements.rulesContainer&&(this._ruleDomMap.forEach((e,t)=>{e.parentElement&&e.parentElement.removeChild(e)}),this._ruleDomMap.clear())}reset(){this.setAnalyzerDropdownValue("",!1),this.clearRules();var e=this.container.querySelector(".metadata-apply-button-container");e&&(e.style.display="none"),this.uiElements.addConditionLink&&(this.uiElements.addConditionLink.style.pointerEvents="none",this.uiElements.addConditionLink.style.opacity="0.5"),this.hideSearchMessage(),this.updateApplyButtonState()}setDisabled(s){var e;this.container.classList.toggle("disabled",s),this.uiElements.analyzerDropdown&&"function"==typeof this.uiElements.analyzerDropdown.setDisabled&&this.uiElements.analyzerDropdown.setDisabled(s),this.container.querySelectorAll("select, input, textarea, a, button").forEach(e=>{var t=this.container.querySelector(".metadata-apply-button-container"),n=e===this.uiElements.resetButton,a=e===this.uiElements.applyButton,i=e===this.uiElements.insightsButton;!s&&t&&"none"!==t.style.display&&n?e.disabled=!1:e.disabled=!s&&a?s||this.uiElements.applyButton.classList.contains("metadata-filter-apply-button-disabled"):!s&&i?s||this.uiElements.insightsButton.classList.contains("metadata-filter-insights-button-disabled"):s}),this.uiElements.addConditionLink&&(s?(this.uiElements.addConditionLink.style.pointerEvents="none",this.uiElements.addConditionLink.style.opacity="0.5"):(e=!!this.state.getSelectedAnalyzerId(),this.uiElements.addConditionLink.style.pointerEvents=e?"auto":"none",this.uiElements.addConditionLink.style.opacity=e?"1":"0.5"))}renderState(e,t){this.reset(),e&&e.analyzerId&&t?(this.setAnalyzerDropdownValue(e.analyzerId,!1),this.uiElements.addConditionLink&&(this.uiElements.addConditionLink.style.pointerEvents="auto",this.uiElements.addConditionLink.style.opacity="1"),this.renderRules(e.rules||[]),this.updateApplyButtonState()):console.warn("MetadataFilterUI: Cannot render state. Invalid state or missing schema.")}updateFetchValuesLink(e,t,n,a=!1){e=e.querySelector(".fetch-metadata-values-link");e&&(e.textContent=t,e.style.pointerEvents=n?"none":"auto",e.style.opacity=n?"0.5":"1",e.style.display=a?"none":"inline")}}module.exports=MetadataFilterUI;
