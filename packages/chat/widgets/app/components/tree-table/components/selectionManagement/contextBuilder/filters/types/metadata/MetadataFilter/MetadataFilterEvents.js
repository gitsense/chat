/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let MetadataFilterUI=require("./MetadataFilterUI"),MetadataFilterState=require("./MetadataFilterState"),MetadataFilterApi=require("./MetadataFilterApi"),MetadataSearch=require("../../../../utils/MetadataSearch");class MetadataFilterEvents{constructor(e,t,a,i,n,l,s,r,u){e&&t&&a&&i&&"function"==typeof n&&"function"==typeof l&&"function"==typeof s&&"function"==typeof r&&"function"==typeof u||console.error("MetadataFilterEvents: Missing required dependencies or callbacks for constructor."),this.metadataSearch=t,this.ui=e,this.state=a,this.api=i,this.onApplySearchClick=n,this.onFilterChange=l,this.initializeAnalyzerDropdown=s,this.resetCallback=r,this.onInsightsClick=u,this._ruleEventListeners=new Map}addEventListeners(){this.ui.uiElements.addConditionLink&&this.ui.uiElements.addConditionLink.addEventListener("click",this.handleAddCondition.bind(this)),this.ui.uiElements.resetLink&&this.ui.uiElements.resetLink.addEventListener("click",this.handleResetClick.bind(this)),this.ui.uiElements.resetButton&&this.ui.uiElements.resetButton.addEventListener("click",this.handleResetClick.bind(this)),this.ui.uiElements.applyButton&&this.ui.uiElements.applyButton.addEventListener("click",this.handleApplySearchClick.bind(this)),this.ui.uiElements.insightsButton&&this.ui.uiElements.insightsButton.addEventListener("click",this.handleInsightsClick.bind(this)),this.ui.uiElements.saveLink&&this.ui.uiElements.saveLink.addEventListener("click",this.handleSaveClick.bind(this)),this.ui.uiElements.loadLink&&this.ui.uiElements.loadLink.addEventListener("click",this.handleLoadClick.bind(this)),this.ui.uiElements.editLink&&this.ui.uiElements.editLink.addEventListener("click",this.handleEditClick.bind(this)),this.ui.uiElements.helpLink&&this.ui.uiElements.helpLink.addEventListener("click",this.handleHelpClick.bind(this))}addEventListenersToRules(){this.ui.getRuleElements().forEach(e=>{var t=this._ruleEventListeners.get(e),i=Array.from(e.querySelectorAll("input, select"));let n=!1;if(t){if(t.lastKnownInputs){let a=t.lastKnownInputs;n=i.length!==a.length||i.some((e,t)=>e!==a[t])}}else n=!0;n&&(t&&this._removeEventListenersFromRuleRow(e,t),this._addEventListenersToRuleRow(e))})}_addEventListenersToRuleRow(t){var e=t.querySelector(".metadata-field-select"),a=t.querySelector(".metadata-operator-select");let i=t.querySelector(".metadata-value-input-area");var n=t.querySelector(".fetch-metadata-values-link"),l=t.querySelector(".remove-metadata-condition-button");let s={},r=t.dataset.ruleId;e&&(s.fieldChange=this.handleFieldChange.bind(this,r,t),e.removeEventListener("change",s.fieldChange),e.addEventListener("change",s.fieldChange)),a&&(s.operatorChange=this.handleOperatorChange.bind(this,r,t),a.removeEventListener("change",s.operatorChange),a.addEventListener("change",s.operatorChange)),i&&((e=()=>{var e=i.querySelectorAll("input, select");s.valueInput=this.handleValueInput.bind(this,r,t),s.valueChange=this.handleValueChange.bind(this,r,t),e.forEach(e=>{e.removeEventListener("input",s.valueInput),e.removeEventListener("change",s.valueChange),e.addEventListener("input",s.valueInput),e.addEventListener("change",s.valueChange)})})(),s.attachValueInputListeners=e),s.lastKnownInputs=Array.from(t.querySelectorAll("input, select")),n&&(s.fetchValuesClick=this.handleFetchValuesClick.bind(this,r,t),n.removeEventListener("click",s.fetchValuesClick),n.addEventListener("click",s.fetchValuesClick)),l&&(s.removeClick=this.handleRemoveCondition.bind(this,r,t),l.removeEventListener("click",s.removeClick),l.addEventListener("click",s.removeClick)),this._ruleEventListeners.set(t,s)}removeRuleEventListeners(){this._ruleEventListeners.forEach((e,t)=>{this._removeEventListenersFromRuleRow(t,e)}),this._ruleEventListeners.clear()}_removeEventListenersFromRuleRow(e,t){var a=e.querySelector(".metadata-field-select"),i=e.querySelector(".metadata-operator-select"),n=e.querySelector(".metadata-value-input-area"),l=e.querySelector(".fetch-metadata-values-link"),e=e.querySelector(".remove-metadata-condition-button");a&&t.fieldChange&&a.removeEventListener("change",t.fieldChange),i&&t.operatorChange&&i.removeEventListener("change",t.operatorChange),n&&(t.valueInput||t.valueChange)&&n.querySelectorAll("input, select").forEach(e=>{t.valueInput&&e.removeEventListener("input",t.valueInput),t.valueChange&&e.removeEventListener("change",t.valueChange)}),l&&t.fetchValuesClick&&l.removeEventListener("click",t.fetchValuesClick),e&&t.removeClick&&e.removeEventListener("click",t.removeClick)}async handleAnalyzerChange(){var e,t=this.ui.getAnalyzerDropdownValue();try{await this.state.selectAnalyzer(t),this.metadataSearch.setAnalyzerSchema(this.state.getCurrentAnalyzerSchema()),this.state.resetRules(),this.removeRuleEventListeners(),this.ui.clearRules(),this.ui.uiElements.addConditionLink&&(e=!!this.state.getSelectedAnalyzerId(),this.ui.uiElements.addConditionLink.style.pointerEvents=e?"auto":"none",this.ui.uiElements.addConditionLink.style.opacity=e?"1":"0.5"),this.ui.updateApplyButtonState(),"function"==typeof this.onFilterChange&&this.onFilterChange()}catch(e){console.error("MetadataFilterEvents: Error handling analyzer change (fetching schema):",e),this.ui.showSearchMessage("Failed to load analyzer schema. Please try again.",!0),this.ui.reset(),this.state.reset(),this.removeRuleEventListeners(),this.metadataSearch.setAnalyzerSchema(null),"function"==typeof this.onFilterChange&&this.onFilterChange()}}handleAddCondition(e){e.preventDefault(),this.state.getCurrentAnalyzerSchema()?(this.state.addRule({field:"",operator:"",dataType:"any",value:null}),this.ui.renderRules(this.state.getRules()),this.addEventListenersToRules(),this.ui.updateApplyButtonState()):console.warn("MetadataFilterEvents: Cannot add condition. No analyzer schema loaded.")}handleFieldChange(e,t){var t=t.querySelector(".metadata-field-select").value,a=this.state.getCurrentAnalyzerSchema(),a=a&&a.properties?a.properties[t]:null,a=a?a.type:"any",i=this.ui.config.operators[a]?.[0]?.value||this.ui.config.operators.any[0].value;this.state.updateRule(e,{field:t,dataType:a,operator:i,value:null}),this.ui.renderRules(this.state.getRules()),this.addEventListenersToRules(),this.ui.updateApplyButtonState()}handleOperatorChange(t,e){e=e.querySelector(".metadata-operator-select").value;this.state.getRules().find(e=>e.id===t)&&(this.state.updateRule(t,{operator:e,value:null}),this.ui.renderRules(this.state.getRules()),this.addEventListenersToRules(),this.ui.updateApplyButtonState())}_getInputValue(a,i,n){if("range"!==i)return"boolean"===n?"true"===(n=(i=a.querySelector(".metadata-value-input"))?i.value:null)||"false"!==n&&null:(i=a.querySelector(".metadata-value-input"))?"number"===i.type?(n=parseFloat(i.value),isNaN(n)?null:n):""===(n=i.value.trim())?null:n:null;{i=a.querySelector(".metadata-value-input-min"),n=a.querySelector(".metadata-value-input-max");let e=i?parseFloat(i.value):null,t=n?parseFloat(n.value):null;return isNaN(e)&&(e=null),isNaN(t)&&(t=null),{min:e,max:t}}}handleValueInput(t,e){var e=e.querySelector(".metadata-value-input-area"),a=this.state.getRules().find(e=>e.id===t);a&&(e=this._getInputValue(e,a.operator,a.dataType),this.state.updateRule(t,{value:e}),this.ui.updateApplyButtonState())}handleValueChange(t,e){var e=e.querySelector(".metadata-value-input-area"),a=this.state.getRules().find(e=>e.id===t);a?(e=this._getInputValue(e,a.operator,a.dataType),this.state.updateRule(t,{value:e}),this.ui.updateApplyButtonState()):console.warn("Value changed but there is no rule associated with "+t)}async handleFetchValuesClick(t,i,a){a.preventDefault();let e=i.querySelector(".metadata-field-select");var a=i.querySelector(".metadata-value-input-area"),n=this.state.getSelectedAnalyzerId(),l=e?e.value:null;if(n&&l){this.ui.updateFetchValuesLink(i,"Fetching...",!0),this.ui.hideSearchMessage();try{var s=await this.metadataSearch.fetchDistinctValues(n,l,(e,t,a)=>{this.ui.updateFetchValuesLink(i,`Fetching... (${e}/${t})`,!0);e=i.querySelector(".metadata-value-count");e&&(e.textContent=`(${a} unique)`)}),r=this.state.getRules().find(e=>e.id===t),u=r?r.value:null,h=(this.ui.populateValueDropdown(a,s,u,i),this.ui.updateFetchValuesLink(i,"Fetch Values",!1,!0),this._ruleEventListeners.get(i));h&&h.attachValueInputListeners&&h.attachValueInputListeners(),this.ui.updateApplyButtonState()}catch(e){console.error(`MetadataFilterEvents: Failed to fetch distinct values for "${l}":`,e),this.ui.showSearchMessage(`Failed to fetch values for "${l}". Error: `+e.message,!0),this.ui.updateFetchValuesLink(i,"Fetch Values",!1);i.querySelector(".metadata-field-select");var o=i.querySelector(".metadata-operator-select"),d=this.state.getRules().find(e=>e.id===t),c=this.state.getCurrentAnalyzerSchema()?.properties?.[d?.field],v=c?c.type:"any",p=(this.ui.updateValueInputArea(a,v,o.value,c,d?.value,i),this._ruleEventListeners.get(i));p&&p.attachValueInputListeners&&p.attachValueInputListeners()}finally{this.ui.updateApplyButtonState()}}else console.warn("MetadataFilterEvents: Cannot fetch values. Analyzer or field missing.")}handleRemoveCondition(e,t){var a=this._ruleEventListeners.get(t);a&&(this._removeEventListenersFromRuleRow(t,a),this._ruleEventListeners.delete(t)),this.state.removeRule(e),this.ui.renderRules(this.state.getRules()),this.ui.updateApplyButtonState(),"function"==typeof this.onFilterChange&&this.onFilterChange()}handleResetClick(e){e.preventDefault(),"function"==typeof this.resetCallback?this.resetCallback():(console.error("MetadataFilterEvents: Reset callback not provided."),this.state.reset(),this.ui.reset(),this.removeRuleEventListeners(),this.addEventListenersToRules())}handleApplySearchClick(e){e.preventDefault(),"function"==typeof this.onApplySearchClick?this.onApplySearchClick():console.error("MetadataFilterEvents: onApplySearchClick callback not provided.")}handleInsightsClick(e){e.preventDefault();e=this.state.getUniqueSelectedFields();"function"==typeof this.onInsightsClick?this.onInsightsClick(Array.from(e)):console.error("MetadataFilterEvents: onInsightsClick callback not provided.")}handleSaveClick(e){e.preventDefault(),console.warn("Save not implemented")}handleLoadClick(e){e.preventDefault(),console.warn("Load not implemented")}handleEditClick(e){e.preventDefault(),console.warn("Edit JSON not implemented")}handleHelpClick(e){e.preventDefault(),console.warn("Help not implemented")}}module.exports=MetadataFilterEvents;
