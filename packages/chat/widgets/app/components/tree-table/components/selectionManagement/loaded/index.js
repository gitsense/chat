/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let svg=require("../../../Dependencies").svg,{getLoadedSelections,deleteRecentSelection,updateRecentSelectionName,addOrUpdateRecentSelection,updateLoadedSelectionName,deleteLoadedSelection}=require("./loadedStorage.js"),{getDisplayName,getDetailedDescription}=require("./loadedItem.js"),dayjs=require("dayjs"),relativeTime=require("dayjs/plugin/relativeTime");function formatCompactRelativeTime(e){var t=dayjs(),e=dayjs(e),n=t.diff(e,"second"),l=t.diff(e,"minute"),a=t.diff(e,"hour"),c=t.diff(e,"day"),d=t.diff(e,"week"),o=t.diff(e,"month"),t=t.diff(e,"year");return n<60?n+"s ago":l<60?l+"m ago":a<24?a+"h ago":c<7?c+"d ago":d<5?d+"w ago":o<12?o+"mo ago":t+"y ago"}dayjs.extend(relativeTime);let INITIAL_ITEMS_TO_SHOW=5,LOADED_HIDDEN_STATE_KEY="treeTable_loadedSelectionsHiddenState";function createLoadedSelections(e){let{onItemClick:r,container:t,showCheckboxes:m=!1}=e;var e=document.createElement("div"),n=(e.className="loaded-selections",document.createElement("div")),l=(n.className="loaded-selections-header",document.createElement("h3")),n=(l.className="loaded-selections-title",l.textContent="Loaded",n.appendChild(l),document.createElement("div")),l=(n.className="loaded-selections-content",document.createElement("div"));l.className="options-menu",l.innerHTML=`
        <ul>
            <li><button class="rename-option">Rename</button></li>
            <li><button class="delete-option">Delete</button></li>
        </ul>
    `,document.body.appendChild(l);let p=document.createElement("table");p.className="loaded-selections-table";l=document.createElement("thead");let u=document.createElement("tr"),a=null,h=null;m&&((h=document.createElement("th")).className="checkbox-column",(a=document.createElement("input")).type="checkbox",a.id="select-all-checkbox",a.className="select-all-checkbox",a.title="Select all",h.appendChild(a),u.appendChild(h));var c=document.createElement("th"),d=(c.className="name-column",c.textContent="Context",document.createElement("th")),o=(d.className="time-column",d.textContent="Loaded",document.createElement("th")),i=(o.className="selection-icon-column",o.innerHTML=svg.check({style:{marginLeft:"5px"}}).outerHTML,document.createElement("th")),c=(i.className="options-column",u.appendChild(c),u.appendChild(d),u.appendChild(o),u.appendChild(i),l.appendChild(u),document.createElement("tbody"));c.className="loaded-selections-items",p.appendChild(l),p.appendChild(c);let y=c,E=document.createElement("div"),v=(E.className="loaded-selections-summary",document.createElement("div")),f=(v.className="loaded-selections-show-more",v.style.display="flex",v.style.justifyContent="center",v.style.alignItems="center",v.style.gap="5px",document.createElement("a")),g=(f.href="#",f.className="loaded-selections-hide-link",f.textContent="Hide contexts",f.style.fontSize="12px",f.style.textDecoration="none",document.createElement("a")),S=(g.href="#",g.className="loaded-selections-show-more-link",g.textContent="Show more",g.addEventListener("click",e=>{e.preventDefault(),C=!C,b()}),document.createElement("span")),C=(S.textContent="|",S.style.margin="0 5px",S.style.color="#ccc",S.style.fontSize="12px",v.appendChild(g),v.appendChild(S),v.appendChild(f),n.appendChild(p),e.appendChild(n),n.appendChild(E),n.appendChild(v),t.appendChild(e),!1),L=[],x=!1;try{x="true"===localStorage.getItem(LOADED_HIDDEN_STATE_KEY)}catch(e){console.error("Error reading loaded hidden state from localStorage:",e)}let k=new Set;function s(e){var e=e.target.checked,t=y.querySelectorAll(".item-checkbox");e?t.forEach(e=>{e.checked=!0,k.add(e.dataset.id)}):t.forEach(e=>{e.checked=!1,k.delete(e.dataset.id)}),D()}function N(e){var e=e.target,t=e.dataset.id;e.checked?k.add(t):k.delete(t),T(),D()}function T(e=!0){var n=document.getElementById("select-all-checkbox"),l=y.querySelectorAll(".item-checkbox");if(n)if(0===l.length)n.checked=!1,n.indeterminate=!1;else{let t=0;l.forEach(e=>{e.checked&&t++}),0===t?(n.checked=!1,n.indeterminate=!1):t===l.length?(n.checked=!0,n.indeterminate=!1):(n.checked=!1,n.indeterminate=!0)}else e&&setTimeout(T(!1),100)}function D(){y.querySelectorAll("tr.loaded-item").forEach(e=>{k.has(e.dataset.id)?e.classList.add("selected"):e.classList.remove("selected")})}function b(){if(y.innerHTML="",L=getLoadedSelections(),x&&0<L.length)p.style.display="none",v.style.display="none",E.style.display="block",e=1===(a=L.length)?"context":"contexts",E.innerHTML="",a=document.createTextNode(a+` ${e}. `),E.appendChild(a),(e=document.createElement("a")).href="#",e.textContent="Click here to view.",e.style.textDecoration="none",e.style.cursor="pointer",e.addEventListener("click",e=>{e.preventDefault(),x=!1;try{localStorage.setItem(LOADED_HIDDEN_STATE_KEY,"false")}catch(e){console.error("Error saving hidden state to localStorage:",e)}b()}),E.appendChild(e);else{p.style.display="",E.style.display="none";var t=C?L.length:Math.min(INITIAL_ITEMS_TO_SHOW,L.length);if(0===L.length)a=document.createElement("tr"),(e=document.createElement("td")).colSpan=m?5:4,e.style.textAlign="center",e.style.fontStyle="italic",e.className="loaded-selections-no-items",e.textContent="No saved contexts",a.appendChild(e),y.appendChild(a),k.clear(),T(),v.style.display="none";else{for(let e=0;e<t;e++){let a=L[e];var n=document.createElement("tr"),l=(n.className="loaded-item",n.dataset.id=a.id,k.has(a.id)&&n.classList.add("selected"),m&&n.classList.add("selected"),m&&((c=document.createElement("td")).className="checkbox-cell",(l=document.createElement("input")).type="checkbox",l.className="item-checkbox",l.dataset.id=a.id,l.checked=k.has(a.id),l.addEventListener("change",N),c.appendChild(l),n.appendChild(c),h)&&u.appendChild(h),document.createElement("td")),c=(l.className="name-cell",document.createElement("a")),d=(c.href="#",c.className="loaded-item-link",c.textContent=getDisplayName(a),c.title=getDetailedDescription(a),c.addEventListener("click",e=>{e.preventDefault(),r(a,!1)}),l.appendChild(c),document.createElement("td")),o=(d.className="time-cell",document.createElement("span")),o=(o.className="relative-time",o.dataset.timestamp=a.lastLoaded||a.timestamp,o.textContent=I(a.lastLoaded||a.timestamp),o.title=new Date(a.lastLoaded||a.timestamp).toLocaleString(),d.appendChild(o),document.createElement("td")),i=(o.className="selection-icon-cell",document.createElement("div")),i=(i.className="selection-icon-container",i.innerHTML=svg.check().outerHTML,i.title="Select selection",i.style.cursor="pointer",i.addEventListener("click",e=>{e.stopPropagation(),r(a,!0)}),o.appendChild(i),document.createElement("td")),s=(i.className="options-cell",document.createElement("button"));s.className="options-button",s.innerHTML='<svg viewBox="0 0 24 24" width="16" height="16"><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/></svg>',s.title="Options",s.addEventListener("click",e=>{var t,n,l;e.stopPropagation(),e=e,t=a,e.stopPropagation(),(n=document.querySelector(".options-menu")).dataset.id=t.id,e=e.target.getBoundingClientRect(),n.style.top=e.bottom+window.scrollY+"px",n.style.left=e.left+window.scrollX-100+"px",n.classList.add("visible"),e=n.querySelector(".rename-option"),l=n.querySelector(".delete-option"),e.replaceWith(e.cloneNode(!0)),l.replaceWith(l.cloneNode(!0)),e=n.querySelector(".rename-option"),l=n.querySelector(".delete-option"),e.addEventListener("click",()=>{H();var a=t,e=y.querySelector(`tr[data-id="${a.id}"]`);if(e){let l=e.querySelector(".name-cell");if(l){let t=document.createElement("input"),n=(t.type="text",t.className="rename-input",t.value=getDisplayName(a),l.innerHTML);l.innerHTML="",l.appendChild(t),t.focus(),t.select(),t.addEventListener("blur",()=>{w(a,t.value,l,n)}),t.addEventListener("keydown",e=>{"Enter"===e.key?w(a,t.value,l,n):"Escape"===e.key&&(l.innerHTML=n)})}}}),l.addEventListener("click",()=>{var e;H(),e=t,deleteLoadedSelection(e.id)&&(k.delete(e.id),b())}),setTimeout(()=>{document.addEventListener("click",A)},0)}),i.appendChild(s),h&&u.appendChild(h),n.appendChild(l),n.appendChild(d),n.appendChild(o),n.appendChild(i),y.appendChild(n)}T();var e=L.length,a=e>INITIAL_ITEMS_TO_SHOW,e=0<e;v.style.display=a||e?"flex":"none",g.style.display=a?"":"none",g.textContent=C?"Show less":"Show more",f.style.display=e?"":"none",S.style.display=a&&e?"":"none"}}}function I(e){return formatCompactRelativeTime(e)}function _(){y.querySelectorAll(".relative-time").forEach(e=>{var t=e.dataset.timestamp;e.textContent=I(t)})}let q=null;function H(){document.querySelector(".options-menu").classList.remove("visible"),document.removeEventListener("click",A)}function A(e){document.querySelector(".options-menu").contains(e.target)||e.target.closest(".options-button")||H()}function w(e,t,n,l){""!==t.trim()&&updateLoadedSelectionName(e.id,t)?b():n.innerHTML=l}return a&&a.addEventListener("change",s),f.addEventListener("click",e=>{e.preventDefault(),x=!0;try{localStorage.setItem(LOADED_HIDDEN_STATE_KEY,"true")}catch(e){console.error("Error saving hidden state to localStorage:",e)}b()}),q&&clearInterval(q),q=setInterval(_,3e4),b(),{refresh:()=>{b(),_()},getSelectedItems:()=>Array.from(k),clearSelections:()=>{k.clear(),y.querySelectorAll(".item-checkbox").forEach(e=>{e.checked=!1}),T(),D()},selectAllItems:()=>{L.forEach(e=>{k.add(e.id)}),y.querySelectorAll(".item-checkbox").forEach(e=>{e.checked=!0}),T(),D()},getSelectionCount:()=>k.size,destroy:()=>{q&&(clearInterval(q),q=null),a&&a.removeEventListener("change",s);var e=document.querySelector(".options-menu");e&&document.body.removeChild(e),k.clear()}}}module.exports={createLoadedSelections:createLoadedSelections};
