/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let dayjs=require("dayjs"),{formatFileSize,formatTokens}=require("../../../utils/formatterUtils"),copyToClipboard=require("../../../utils/clipboard").copyToClipboard;class ContextBuilderTable{constructor({container:e,onItemSelectionChange:t,onItemNameClick:l,md:s,getContent:a,showKeywords:n=!1}){this.container=e,this.onItemSelectionChange=t,this.onItemNameClick=l,this.showKeywords=n,this.md=s,this.getContent=a,this.table=document.createElement("table"),this.table.className="context-builder-table",this.tbody=null,this.allItems=[],this.selectedItemIds=new Set,this.itemRowMap=new Map,this.container.appendChild(this.table)}loadItems(e,t,l){this.allItems=e,this.selectedItemIds.clear(),this.itemRowMap.clear(),this.render(t,l)}async render(l,e){if(this.table.innerHTML="",this.itemRowMap.clear(),this.allItems&&0!==this.allItems.length){var t=this.allItems.filter(e=>"loaded"===e.status).length;this.createTableHeader(t,this.selectedItemIds.size,l),this.tbody=this.table.createTBody();for(let e=0;e<this.allItems.length;e++){0!==e&&e%100==0&&await sleep(100);let t=this.allItems[e];var s=this.tbody.insertRow(),a=(s.className="context-builder-item-row",s.dataset.id=t.id,this.itemRowMap.set(t.id,s),"error"===t.status&&s.classList.add("error"),"review"===l?s.insertCell():null),n=s.insertCell(),i=s.insertCell(),o=s.insertCell(),d=s.insertCell(),r=s.insertCell();if(a&&(a.className="col-status",a.style.textAlign="center"),"loaded"===t.status){let e=document.createElement("input");e.type="checkbox",e.checked=this.selectedItemIds.has(t.id),e.disabled="review"!==l||null,e.addEventListener("change",()=>{this.handleItemSelectionChange(t.id,e.checked)}),a&&a.appendChild(e),t.row=s}else"error"===t.status?((s=document.createElement("span")).textContent="❌",s.title=t.error||"Failed to load item",a&&a.appendChild(s)):((s=document.createElement("span")).textContent="⏳",s.title="Loading...",a&&a.appendChild(s));i.className="col-name",i.style.paddingLeft="review"===l?null:"15px";var a=document.createElement("span"),s=(a.textContent=t.name,a.className="item-name-link",a.style.cursor="pointer",a.title=t.name,getParentPathName(t.path)),c=document.createElement("span");c.style.color="#555",c.style.fontSize="0.8em",c.innerHTML=s,i.appendChild(c),i.appendChild(document.createElement("br")),i.appendChild(a),a.addEventListener("click",()=>{this.handleItemNameClick(t.id)}),o.className="col-description","loaded"===t.status?((s=document.createElement("div")).className="item-purpose",s.textContent=t.purpose||"No purpose or keywords analysis.",o.appendChild(s),c=document.createElement("div"),a=0===(i=t.path?t.path.split("/"):[]).length||1===i.length&&""===i[0]?"<root>":i.slice(0,i.length-1).join(" / "),c.className="item-directory",c.textContent=""===a?"<root>":a,this.showKeywords&&((s=document.createElement("div")).className="item-keywords",s.textContent="Keywords: "+(t.keywords?.join(", ")||"None."),o.appendChild(s))):o.textContent="N/A",n.className="col-tokens",n.textContent="loaded"===t.status?formatTokens(t.tokenCount||0):"N/A",d.className="col-repo",d.textContent=t.repo?.fullName?.split("/").pop()||"N/A",d.title=t.repo?.fullName||"N/A",r.className="col-committed",r.textContent=t.commit?dayjs().to(1e3*t.commit.timestamp):"N/A",r.title=t.commit?new Date(1e3*t.commit.timestamp).toISOString():"No commit information"}}else this.createTableHeader(0,0),(t=this.table.insertRow().insertCell()).colSpan=6,t.textContent="No items loaded.",t.style.textAlign="center",t.style.fontStyle="italic";e&&"function"==typeof e&&e()}createTableHeader(e,t,s){let a=this.table.createTHead().insertRow();var l=document.createElement("th"),n=(l.id="context-builder-select-all-header",l.className="col-status",document.createElement("input"));n.type="checkbox",n.disabled=0===e||"review"!==s,n.checked=0<e&&e===t,n.addEventListener("change",e=>{this.handleItemSelectionChange("all",e.target.checked)}),l.appendChild(n),"review"===s&&a.appendChild(l);[{text:"Tokens",className:"col-tokens"},{text:"File",className:"col-name"},{text:"Description",className:"col-description"},{text:"Repository",className:"col-repo"},{text:"Committed",className:"col-committed"}].forEach((e,t)=>{var l=document.createElement("th");l.textContent=e.text,l.className=e.className,0===t&&"reivew"!==s&&(l.style.paddingLeft="15px"),a.appendChild(l)})}handleItemSelectionChange(e,t){"all"===e?this.allItems.filter(e=>"none"!==e.row?.style.display&&"loaded"===e.status).forEach(e=>{t?this.selectedItemIds.add(e.id):this.selectedItemIds.delete(e.id);var e=this.itemRowMap.get(e.id);e&&(e=e.querySelector('input[type="checkbox"]'))&&(e.checked=t)}):t?this.selectedItemIds.add(e):this.selectedItemIds.delete(e);var e=this.allItems.filter(e=>"none"!==e.row?.style.display&&"loaded"===e.status),l=e.length,e=e.filter(e=>this.selectedItemIds.has(e.id)).length;this.updateSelectAllCheckbox(l,e),"function"==typeof this.onItemSelectionChange&&this.onItemSelectionChange(Array.from(this.selectedItemIds))}handleItemNameClick(t){var e,l=this.allItems.find(e=>e.id===t);l&&(e="loaded"===l.status?l.content:"Error loading content: "+(l.error||"Unknown error"),this.toggleItemContent(t,e)),"function"==typeof this.onItemNameClick&&this.onItemNameClick(l)}async toggleItemContent(l,e){var s=this.itemRowMap.get(l);if(s){var a=s.expandedRow;if(a&&a.classList.contains("expanded-content-row"))this.tbody.removeChild(a),delete s.expandedRow;else{a=this.tbody.insertRow(s.rowIndex),s=(a.className="expanded-content-row",a.dataset.parentId=l,(s.expandedRow=a).insertCell()),a=this.table.querySelector("thead tr"),a=a?a.cells.length:6;s.colSpan=a;let{metadata:e,content:t}=await this.getContent(l);var a=document.createElement("div"),l=(a.className="expanded-content",document.createElement("div")),n=(l.className="content",l.style.padding="5px",l.innerHTML=this.md.render("```"+(e.highlight||"text")+"\n"+t+"\n```"),document.createElement("div"));n.className="metadata",n.style.padding="5px",n.innerHTML=this.md.render("```json\n"+JSON.stringify(e||{},null,2)+"\n```"),a.appendChild(l),s.appendChild(a),[l,n].forEach(e=>{e=e.querySelector("pre");e&&(e.style.padding="15px")})}}}async handleCopyItemContent(e){if(e&&"loaded"===e.status&&e.content)try{if(await copyToClipboard(e.content)){var l=this.itemRowMap.get(e.id);if(l){let t=l.querySelector(".copy-item-icon");if(t){let e=t.textContent;t.textContent="✅",setTimeout(()=>{t.textContent=e},1500)}}}else console.error("Failed to copy item content."),alert("Failed to copy content to clipboard.")}catch(e){console.error("Failed to copy item content: ",e),alert("Failed to copy content to clipboard.")}}updateSelectAllCheckbox(e,t){var l=this.table.querySelector('#context-builder-select-all-header input[type="checkbox"]');l&&(l.checked=0<e&&e===t,l.disabled=0===e)}updateDisplayedItems(e){let l=new Set(e);this.itemRowMap.forEach((e,t)=>{t=l.has(t);e.style.display=t?null:"none",e.expandedRow&&(e.expandedRow.style.display=t?null:"none")});e=this.allItems.filter(e=>"none"!==e.row?.style.display&&"loaded"===e.status);this.updateSelectAllCheckbox(e.length,e.filter(e=>this.selectedItemIds.has(e.id)).length)}getSelectedItems(){return this.allItems.filter(e=>this.selectedItemIds.has(e.id)&&"loaded"===e.status)}getVisibleAndSelectedItems(){return this.allItems.filter(e=>"none"!==e.row?.style.display&&this.selectedItemIds.has(e.id)&&"loaded"===e.status)}getSelectedTotalTokens(){return this.allItems.reduce((e,t)=>this.selectedItemIds.has(t.id)&&"loaded"===t.status?e+(t.tokenCount||0):e,0)}getSelectedTotalSize(){return this.allItems.reduce((e,t)=>this.selectedItemIds.has(t.id)&&"loaded"===t.status?e+(t.size||0):e,0)}clear(){this.allItems=[],this.selectedItemIds.clear(),this.itemRowMap.clear(),this.table.innerHTML="",this.tbody=null}}function sleep(t){return new Promise(e=>setTimeout(e,t))}function getParentPathName(e){e=e.split("/");return 1===e.length?"/":(e.pop(),e.join(" / ")+" /")}module.exports={ContextBuilderTable:ContextBuilderTable};
