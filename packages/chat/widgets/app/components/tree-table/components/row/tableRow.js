/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let formatAge=require("../../utils/dateUtils").formatAge,getLatestChildTime=require("../../utils/treeUtils").getLatestChildTime,{chevronRightSvg,chevronDownSvg,zapSvg}=require("../../constants");function createExpandButton({node:t,handlers:n}){if(!(t.kids&&0<t.kids.length||"git-ref"===t.type&&n.chatApi?.getGitRefChatDescendants))return null;let a=document.createElement("span");a.className="expand-button";var e=n.state.isNodeExpanded(t.id);return a.innerHTML=e?chevronDownSvg:chevronRightSvg,a.dataset.expanded=e,a.dataset.state=e?"expanded":"collapsed",a.addEventListener("click",e=>{e.stopPropagation(),n.toggleChildren(t.id,a)}),a}function createRow({node:t,level:n=0,decorator:a={},handlers:d={},parentId:e=null,columns:i=[]}){let r=document.createElement("tr");return r.dataset.id=t.id,r.dataset.level=n,r.dataset.hasChildren=t.kids&&0<t.kids.length,t.kids&&0<t.kids.length&&(r.dataset.expanded=d.state.isNodeExpanded(t.id)),t.current_node&&(r.style.fontWeight=600,r.style.backgroundColor="#f4f4f4"),e&&(r.dataset.parent=e,d.state.isNodeExpanded(e)||r.classList.add("hidden")),i.forEach(e=>{e.visible&&(e=createCell({node:t,column:e,level:n,decorator:a,handlers:d}),r.appendChild(e))}),r}function updateRow(a,{node:d,decorator:i={},columns:e=[]}){e.forEach(e=>{if(e.visible){var t=a.querySelector(`td[data-column="${e.key}"]`);if(t)switch(e.key){case"created_at":t.textContent=e.render?.(d,i)||formatAge(d.created_at);break;case"latest_child":t.textContent=e.render?.(d)||getLatestChildTime(d);break;default:if(e.render){var n=e.render(d,i);if("string"==typeof n)t.textContent=n;else{if(!(n instanceof HTMLElement))throw new Error("Unable return type for "+n);t.innerHTML="",t.appendChild(n)}}}}})}function highlightRow(e,t=2e3){e.classList.add("highlight"),setTimeout(()=>e.classList.remove("highlight"),t)}function createCell({node:n,column:e,level:t,decorator:a,handlers:d}){var i,r,l,o=document.createElement("td");if(o.dataset.column=e.key,e.width&&(o.style.width=e.width),e.textAlign&&(o.style.textAlign=e.textAlign),"selection"===e.key){if(n.type&&n.type.match(/^git-/)){let t=document.createElement("input");t.type="checkbox",t.checked=d.state.isNodeSelected(n.id),d.state.isNodeSelectableByType?.(n)?t.addEventListener("click",e=>{e.stopPropagation();e=t.checked;d.toggleNodeSelection(n.id,e)}):(t.disabled=!0,t.style.opacity="0.5",t.title="This node cannot be selected with current options"),o.appendChild(t),o.style.textAlign="center"}}else if("name"===e.key)(i=document.createElement("div")).className="tree-node",i.dataset.level=t,(t=document.createElement("div")).className="tree-node-content",d.toggleButtonInColumn||(r=createExpandButton({node:n,handlers:d}))&&(r.dataset.nodeId=n.id,t.appendChild(r)),r=e.render(n,a),t.appendChild(r),i.appendChild(t),o.appendChild(i);else switch(e.key){case"toggle_button":var s=e.render(n,a,d);s&&o.appendChild(s);break;case"current_node_indicator":n.current_node&&(o.className="current-node-indicator",o.textContent="â†’");break;case"chats":o.textContent=n.kids?n.kids.length+1:1,o.style.textAlign="center";break;case"created_at":var s=e.render?.(n,a)||formatAge(n.created_at);s instanceof HTMLElement?o.appendChild(s):o.textContent=s;break;case"latest_child":s=e.render?.(n)||getLatestChildTime(n);s instanceof HTMLElement?o.appendChild(s):o.textContent=s;break;case"actions":0===n.parent_id&&n.kids&&0<n.kids.length&&((s=(new DOMParser).parseFromString(zapSvg,"application/xml").children[0]).style.position="relative",s.style.left="-5px",(l=document.createElement("span")).className="expand-to-latest-icon",l.innerHTML=s.outerHTML,l.title="Expand to Latest Child",l.addEventListener("click",e=>{e.stopPropagation(),d.expandToLatestChild(n.id)}),o.appendChild(l));break;default:s=e.render?.(n,a)||"";s instanceof HTMLElement?o.appendChild(s):o.textContent=s}return o}module.exports={createRow:createRow,updateRow:updateRow,highlightRow:highlightRow,createExpandButton:createExpandButton};
