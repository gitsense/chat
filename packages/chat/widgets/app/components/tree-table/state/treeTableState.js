/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let utilsFindNodeById=require("../utils/treeUtils").findNodeById;function createTreeTableState(e,t){let o={id:(new Date).getTime(),data:e,currentPage:1,rowsPerPage:t,expandedNodes:new Set,expandedState:new Map,nodeMap:new Map,descendantsFetched:new Set,selectionState:new Map,updateInterval:null,recursiveSelection:!0,fileSelectionEnabled:!0,directorySelectionEnabled:!0,buildNodeMap:n};function n(e,t=!1){function d(e){e&&(o.nodeMap.set(e.id,e),e.kids)&&e.kids.forEach(d)}t&&o.nodeMap.clear(),Array.isArray(e)?e.forEach(e=>d(e)):d(e)}function r(e){return!(!e||!e.type)&&("git-blob"===e.type?o.fileSelectionEnabled:("git-tree"===e.type||"git-ref"===e.type)&&o.directorySelectionEnabled)}function a(e,t=!1){var d=utilsFindNodeById(o.nodeMap,e);if(!d||!d.kids)return[];if((t||!o.recursiveSelection)&&!o.selectionState.has(e))return[];for(var n=[],a=[...d.kids];0<a.length;){var i=a.pop();!r(i)||t&&!o.selectionState.has(i.id)||(n.push(i.id),!i.kids)||t&&!o.selectionState.get(i.id)||a.push(...i.kids)}return n}function d(t){if(o.selectionState.has(t))return o.selectionState.get(t);if(o.recursiveSelection){t=utilsFindNodeById(o.nodeMap,t);if(t&&0!==t.parent_id){let e=t.parent_id;for(;0!==e;){var d=utilsFindNodeById(o.nodeMap,e);if(!d)break;if(o.selectionState.has(e))return o.selectionState.get(e);e=d.parent_id}}}return!1}function i(){var e,t=[];for(e of o.nodeMap.values())d(e.id)&&t.push(e.id);return Array.from(t)}return o.nodeMap.set("node map id",o.id),n(e),{getId:()=>o.id,getData:()=>o.data,getNodeMap:()=>o.nodeMap,getCurrentPage:()=>o.currentPage,getRowsPerPage:()=>o.rowsPerPage,isNodeExpanded:e=>o.expandedNodes.has(e),isNodeSelected:d,setCurrentPage:e=>{o.currentPage=e},setRowsPerPage:e=>{o.rowsPerPage=e},clearSelectedNodes:function(){o.selectionState.clear()},toggleNodeExpansion:e=>{if(o.expandedNodes.has(e)){{var d=e;let t=new Set;a(d).forEach(e=>{o.expandedNodes.has(e)&&t.add(e)}),o.expandedState.set(d,t)}o.expandedNodes.delete(e)}else o.expandedNodes.add(e),d=e,(e=o.expandedState.get(d))&&(e.forEach(e=>o.expandedNodes.add(e)),o.expandedState.delete(d))},setNodeSelection:function(e,t){o.selectionState.set(e,t)},toggleNodeSelection:function(e,t){var d=utilsFindNodeById(o.nodeMap,e);d&&r(d)&&(t?o.selectionState.set(e,!0):(o.recursiveSelection&&a(e,!0).forEach(e=>o.selectionState.delete(e)),o.selectionState.set(e,!1)))},getSelectedNodeIds:i,getSelectedNodes:function(){return i().map(e=>utilsFindNodeById(o.nodeMap,e)).filter(Boolean)},getSelectedNodesCount:function(){return i().length},getDescendantIds:a,setRecursiveSelection:function(e){o.recursiveSelection=e},isRecursiveSelectionEnabled:function(){return o.recursiveSelection},setFileSelectionEnabled:function(e){if(!(o.fileSelectionEnabled=e)){var t,d,n,a=[];for([t,d]of o.selectionState.entries())d&&(n=utilsFindNodeById(o.nodeMap,t))&&"git-blob"===n.type&&a.push(t);a.forEach(e=>o.selectionState.delete(e))}},setDirectorySelectionEnabled:function(e){if(!(o.directorySelectionEnabled=e)){var t,d,n,a=[];for([t,d]of o.selectionState.entries())!d||!(n=utilsFindNodeById(o.nodeMap,t))||"git-tree"!==n.type&&"git-ref"!==n.type||a.push(t);a.forEach(e=>o.selectionState.delete(e))}},addFetchedDescendants:e=>{o.descendantsFetched.add(e)},addChildrenToNode:(e,t,d)=>{e=o.nodeMap.get(e);e&&Array.isArray(e.kids)&&(e.kids.push(...t),n(t,!1))},hasFetchedDescendants:e=>o.descendantsFetched.has(e),isNodeSelectableByType:r,getExpandedDescendants:e=>a(e).filter(e=>o.expandedNodes.has(e)),expandAllNodesWithChildren:()=>{o.data.forEach(e=>function t(e){e.kids&&0<e.kids.length&&(o.expandedNodes.add(e.id),e.kids.forEach(e=>t(e)))}(e))},setUpdateInterval:e=>{o.updateInterval=e},getUpdateInterval:()=>o.updateInterval,clearUpdateInterval:()=>{o.updateInterval&&(clearInterval(o.updateInterval),o.updateInterval=null)},findNodeById:(e,t)=>utilsFindNodeById(o.nodeMap,e,o.buildNodeMap,t),clearSelections:()=>{o.selectionState.clear()},updateStateProperty:function(e,t){o[e]=t},buildNodeMap:n}}module.exports={createTreeTableState:createTreeTableState};
