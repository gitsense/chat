/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let DropDownMenu=require("../../../../devboard/components/drop-down-menu.js"),{MessageUtils,GSToolBlockUtils}=require("@gitsense/gsc-utils"),h=require("../../../../devboard/utils/html.js"),svg=require("../../../../devboard/utils/svg.js"),Breadcrumbs=require("./breadcrumbs.js").Breadcrumbs,ConversationView=require("./components/conversation-view").ConversationView,History=require("./history.js").History,FloatingDiv=require("./floating_div.js"),ConfirmationBox=require("./components/ui/confirmation-box").ConfirmationBox,formatAge=require("./components/tree-table/utils/dateUtils").formatAge,TreeTable=require("./components/tree-table/TreeTable"),{arrayToTree,findNodeById}=require("./components/tree-table/utils/treeUtils"),RenameChatModal=require("./components/chat-builder/modals/RenameChatModal"),QuickChatButtons=require("./components/chat-builder/QuickChatButtons"),{get:getChat,set:setChat,updateChats,updateChatName,newChat,newChatTree,newChatMessage,deleteChat,getAnalyzers,getAnalyzerSchema,getChatOverviewMessagesByChatIds,getGitBlobChatMessagesByChatIds,getGitRefChatByFamilyMember,getTinyChatOverviewPurpose,search}=require("./chat"),CHAT_WIDTH_KEY="gs-chat-width",LEFT_FLOATING_WIN_KEY="gs-chat-left-floating-window",RIGHT_FLOATING_WIN_KEY="gs-chat-right-floating-window",IDEAL_RIGHT_WIN_WIDTH=450;function ChatPage(u,m,g,y,e={}){var{}=u;let w=localStorage.getItem(CHAT_WIDTH_KEY)||"820px";let{centerMain:v=!1,chatInputStyle:f,chatOptionsStyle:x,disableChatOptions:o=!1,disableFloatingWindows:C=!1,mainStyle:b,minConversationWidth:T,maxConversationWidth:k,scrollableElement:B,showBreadcrumbs:S=!0,showChat:I=!0,showChatOptions:A=!1,showHeader:D=!0,showInsights:M=!0,showMenus:_=!0,showName:N=!1,showNewChatOptions:L=!0,inSideBySide:W,isAnalysis:Y,noResizeTablerContainer:Q=!1,noFixedWidth:E=!1}=e,{chatInputBody:R,chatInputMsgBody:H}=e,z=null,G=null,P=null;let F=null,O=null,q=null;async function U(e){"regular"===(g=await getChat(u,g.uuid,y)).type&&(new History).save(g),F&&F.update(g),q&&q.update(g),O&&O.update(g),e&&e(g)}function j(e){e.appendChild(K(y,24)),e.appendChild(h.createDiv({text:y,style:{fontSize:"22px",fontWeight:500,marginTop:"10px",marginBottom:"5px"}})),e.appendChild(h.createDiv({text:g.prompt,style:{fontSize:"14px"}}))}function K(e,t=16){t={height:t+"px",width:t+"px",marginRight:"7px",verticalAlign:"middle"};return e.match(/gpt/i)?svg.openAI({style:t}):e.match(/claude/i)?svg.claude({style:t}):e.match(/deepseek/i)?svg.deepSeek({style:t}):e.match(/llama/i)?svg.meta({style:t}):svg.aiModel({style:t})}function V(){this.render=function(s){s=s;{let a="Rename chat",n="Delete chat",e=[{value:""},{value:a}],t=(m.permissions.deleteChat&&e.push({value:n}),e.push({value:"<div style='display:inline-block;width:100%;padding:0px 0px 7px 0px;border-bottom:1px solid #888;border-top:1px solid #888;padding-top:5px;margin-top:2px;margin-bottom:2px;font-size:13px;'>Conversation Width</div>",selectable:!1}),e.push({value:"768px"}),e.push({value:"820px"}),e.push({value:"880px"}),e.push({value:"960px"}),e.push({value:"1024px"}),new DropDownMenu(e,"Options",{alignment:"sw",dropDownClass:"",dropDownStyle:{marginLeft:"4px"},menuStyle:{marginTop:"10px",width:"175px",zIndex:1e8,textAlign:"left",left:"-150px"},callback:async(e,t)=>{if(!t.toString().match(/^----/))if(setTimeout(()=>{i.childNodes[0].removeAttribute("open")},50),t===a)new RenameChatModal(u,g,m.models,e=>{window.location.reload()}).render();else if(t===n)(new ConfirmationBox).show({message:"Are you sure you want to delete this chat?"},async()=>{await deleteChat(u,g),(new History).rm(g.uuid);var e=g.lineage,{pathname:t,search:a}=window.location,a=new URLSearchParams(a),e=(e?a.set("chat",e[e.length-1].uuid):a.delete("chat"),a.delete("model"),a.toString());window.location.assign((""===t?"/":t)+(e?"?"+e:""))});else{if(!t.match(/^\d+(px|%)/))throw new Error("Unrecognized new value "+t);localStorage.setItem(CHAT_WIDTH_KEY,t),z.style.width=t,z.style.marginLeft=null,G.style.width=t,R.style.width=t,H.style.width=t,setTimeout(()=>{z.style.marginLeft=calculateIdealLeftMargin(z,IDEAL_RIGHT_WIN_WIDTH)},25)}}})),i=t.create();i.style.display="inline-block",i.style.verticalAlign="middle",s.appendChild(svg.gear({style:{marginLeft:"5px"}})),s.appendChild(i)}}}function $(){var e=new URLSearchParams(window.location.search),t=m.prompts.find(e=>e.default),a=m.prompts.find(e=>e.name===g.prompt);let i=(a||t).name,n=(l(e.get("temperature")),null),s=null;function l(e){if(null!=e)return parseFloat(e)}this.getAllSelected=function(){return{prompt:n.getSelected(),model:s.getSelected().split(" [").shift(),temperature:l(temperaturesMenu.getSelected())}},this.render=function(e){var{promptsBody:e,modelsBody:t}=(e=>{var t=h.createDiv({style:{display:W?"none":"inline-block",width:"50%",textAlign:"left"}}),a=h.createDiv({style:{display:W?null:"inline-block",width:W?null:"50%",textAlign:"left"===W?"left":"right"}});return e.appendChild(t),e.appendChild(a),{promptsBody:t,modelsBody:a}})(e=e);function a(e,t,a,n,i={}){var{width:i=200,alignment:s}=i,t=new DropDownMenu(t,"",{alignment:s,dropDownClass:"",dropDownStyle:{fontWeight:"normal",fontSize:"14px"},menuStyle:{marginTop:"15px",width:i+"px",zIndex:1e6,textAlign:"left",fontWeight:"normal"},callback:(e,t)=>{t.toString().match(/^----/)||a(t)}}),s=t.create(),i=(s.style.display="inline-block",s.style.verticalAlign="middle",e.style.marginRight="5px",h.createDiv({cls:"btn",append:[e,s],style:{display:"inline-block",padding:"6px 10px"}}));return n.appendChild(i),t}n=a(svg.comment(),(()=>{let a=[{value:"No system prompt"}],n;return m.prompts.forEach(e=>{var{name:e,default:t}=e,t=i?i===e:t;o&&!t||(a.push({value:e,selected:t}),t&&(n=e))}),a})(),async function(e){var t=g.messages[0].kids[0]||null,a=g.messages[0].kids[0]?.kids[0]||null;if(!t)throw new Error("No user message found");if(!a)throw new Error("No assistant message");var n,i=g.group_id;function s(e){var{pathname:t,search:a}=window.location,a=new URLSearchParams(a),e=(a.set("chat",e),(""===t?"/":t)+"?"+a.toString());window.location.assign(e)}(n=(await getChat(u,null,y,i,e)||{}).uuid)?s(n):(n={action:"new-chat","group-id":i,model:y,temperature:a.temperature,"system-message-name":e,"user-message":t.message,stream:!0},!(i=await fetch(u.dataURL,{method:"POST",body:JSON.stringify(n),headers:{"Content-Type":"application/json"}})).ok||({status:a,data:e}=await i.json(),"failed"===a)?console.log("FIXME: Implement"):s(e.uuid))},e,{width:400}),s=a(svg.aiModel(),(()=>{var{models:e,fakeLLMs:t=0}=m;let a="--------------------------------------",n=[{value:"GitSense Notes"},{value:a}];if(e.forEach(e=>{var t,e=e.name;e.match(/^---/)?n.push({value:a}):(t=e===y,n.push({value:e,selected:t}))}),t){n.push({value:a});for(let e=1;e<=t;e++){var i="Fake LLM Simulator "+e;n.push({value:i,selected:y===i})}}return n})(),async function(i){var e,t,a,n=g.messages[0].kids[0]?.kids||null;if(!n)throw new Error("No level 1 kids found");let s=null;for(let e=0;e<n.length;e++){var l=n[e];if(l.model===i){s=l;break}}function o(){var{pathname:e,search:t}=window.location,t=new URLSearchParams(t),a=t.get("chats")?t.get("chats").split(","):[],n=a[0]===g.uuid?0:1,n=(a.length?((a=t.get("models").split(","))[n]=i,t.set("models",a.join(","))):i===g.main_model?t.delete("model"):t.set("model",i),(e?"":"/")+"?"+t.toString());window.location.assign(n)}s||(g.group_id,{parent_id:e,role:t,temperature:a}=n[0],await newChatMessage(u,g.id,e,i,t,null,{temperature:a,stream:!0})),o()},t,{width:275,alignment:"left"===W?"se":"sw"})}}function J(d){let p=null,c=null,u=null,a=null;function n(e,t){var n,a,i,s,l=(s=>{let l={},o={responses:0,cost:0,models:0,messages:0};return Array.from(function t(e,a){let{model:n,kids:i}=e;n&&a.add(n);for(let e=0;e<i.length;e++)t(i[e],a);return a}(s,new Set)).forEach(e=>{var t={system:0,user:0,assistant:0},a=[],{inputPMT:n=0,outputPMT:i=0}=(!function t(e,a,n,i){let{role:s,kids:l,message:o}=e;if(e.model&&e.model!==a)return;null!=o&&i.push({role:s,content:o});"system"===s&&""!==o?n.system++:"user"===s?n.user++:"assistant"===s&&n.assistant++;for(let e=0;e<l.length;e++)t(l[e],a,n,i);return n}(s,e,t,a),(t=>{var a=m.models;for(let e=0;e<a.length;e++){var{name:n,providers:i}=a[e];if(n===t)return{inputPMT:n=0,outputPMT:i=0}=i[0].prices||{},{inputPMT:n,outputPMT:i}}})(e)||{}),n=((t,e,a)=>{if(!Array.isArray(t)||0===t.length)throw new Error("Messages must be a non-empty array.");if("number"!=typeof e||e<0)throw new Error("Input token cost must be a non-negative number.");if("number"!=typeof a||a<0)throw new Error("Output token cost must be a non-negative number.");let n=0,i=0,s=0,l=[];for(let e=0;e<t.length;e++){var o=t[e],r=Math.ceil(o.content.length/4);"user"===o.role||"system"===o.role?(i+=r,l.push({role:o.role,tokens:r})):"assistant"===o.role&&(s+=r,l.push({role:o.role,tokens:r}),0<e)&&"user"===t[e-1].role&&n++}var e=parseFloat((i/1e6*e).toFixed(6)),a=parseFloat((s/1e6*a).toFixed(6)),d=parseFloat((e+a).toFixed(6));return{apiCalls:n,inputTokens:i,outputTokens:s,inputCost:e,outputCost:a,totalCost:d,breakdown:l}})(a,n,i),i=a.length;o.messages+=i,o.cost+=n.totalCost,o.responses+=t.assistant,o.models++,l[e]={roles:t,messages:a,cost:n,overview:{messages:i,cost:n.totalCost}}}),l[y]||(l[y]={name:y,cost:{totalCost:0,inputCost:0,outputCost:0},messages:[],overview:{messages:0,cost:0},roles:{system:0,user:0,assistant:0}}),{overview:o,models:l}})(d.messages[0]),{settingsBody:l,metricsBody:e,modelsBody:o}=(p=d.report,c=l.models,u=l.overview,l=e,e=h.createDiv({style:{textAlign:"center",lineHeight:1.7,marginTop:"10px"}}),o=h.createDiv({style:{marginTop:"10px",textAlign:"center",lineHeight:1.6,whiteSpace:"nowrap"}}),a=h.createDiv({style:{marginTop:"20px",textAlign:"center",whiteSpace:"nowrap",backgroundColor:"#f4f4f4",padding:"10px 10px"}}),i=h.createDiv({style:{marginTop:"20px",lineHeight:1.9,textAlign:"left",fontSize:"15px"}}),l.appendChild(e),l.appendChild(o),l.appendChild(i),{settingsBody:e,metricsBody:o,costsBody:a,modelsBody:i});j(l),n=e,a=new Intl.NumberFormat,i=(e=>(e=e.split(/\s+/).filter(Boolean).length,Math.ceil(1.33*e)))(function e(t,a=[]){let{message:n,kids:i}=t;a.push(n);i&&i.length&&e(i[0],a);return a}(d.messages[0]).join("")),(a=[{text:"Tokens",value:a.format(i)}]).forEach((e,t)=>{var{text:e,value:a}=e,a=h.createDiv({append:[h.createSpan({text:a,style:{fontWeight:500,fontSize:"30px"}}),e.match(/^Po/)?h.createSpan({text:"%",style:{fontSize:"16px"}}):null,h.createBreak(),h.createSpan({text:e,style:{fontSize:"14px"}})],style:{display:"inline-block",textAlign:"center",lineHeight:1.6,marginLeft:0===t?"10px":"15px",minWidth:"75px"}});n.appendChild(a)});{l=o;let{context:e,others:t}=(()=>{var e,t,a=[];for(e in c)e!==y&&((t=c[e]).name=e,a.push(t));a.sort((e,t)=>{t.overview.messages,e.overview.messages}),a.unshift(c[y]);let n=[];return m.models.forEach(e=>{var t=e.name;c[t]||t.match(/^---/)||((t={...e}).overview={messages:0},n.push(t))}),n.sort((e,t)=>e.name-t.name),{context:a,others:n}})();function r(e){var{search:t,pathname:a}=window.location,t=new URLSearchParams(t);return t.set("model",e),(""===a?"/":a)+"?"+t.toString()}1<e.length&&(s=l,e.sort((e,t)=>t.overview.messages-e.overview.messages).forEach((e,t)=>{var{name:e,overview:a}=e,n={append:[K(e||y),h.createSpan({text:e||y,style:{verticalAlign:"middle"}})],href:r(e),style:{display:"inline-block",width:"calc(100% - 20px)",overflow:"hidden",textOverflow:"ellipsis",color:"black"}},e=e?h.createLink(n):h.createSpan(n),n=h.createSpan({text:a.messages,style:{display:"inline-block",width:"20px",textAlign:"right",verticalAlign:"top"}}),a=h.createDiv({append:[e,n],style:{whiteSpace:"nowrap",verticalAlign:"top"}});s.appendChild(a)})),t.length}t&&t()}this.render=e=>{n(a=e)},this.update=e=>{d=e;let t=h.createDiv({style:{display:"none"}});document.body.appendChild(t),n(t,()=>{t.style.display=null,setTimeout(()=>{h.updateDOM(t,a)},10),t.parentNode.removeChild(t)})}}this.render=function(d){{let{breadcrumbsBody:e,menusBody:t,quickChatButtonsBody:a,settingsBody:n,titleBody:s,conversationBody:i}=(e=>{Q||(a=document.querySelectorAll(".tblr-container-xxl"),Array.from(a).forEach(e=>{e.style.maxWidth="100%"}));var t,a=h.createDiv({style:{display:"inline-block",width:"calc(100% - 300px)",textAlign:"left"}}),n=h.createDiv({style:{display:"inline-block",width:"300px",textAlign:"right"}}),i=h.createDiv({cls:"gs-chat-header",append:[S?a:null,_?n:null]}),s=h.createDiv({id:"chat-options-body",style:x||{display:W?null:"inline-block",width:W?null:"100%",marginTop:W?"2px":"20px",padding:W?"10px 10px 15px 10px":"17px 20px 17px 20px",paddingTop:W?"5px":"18px",verticalAlign:"top",textAlign:"left",top:W?null:-1,zIndex:W?null:100,backgroundColor:W?null:"white"}}),l=h.createDiv({style:{textAlign:"center"}}),o=h.createDiv({text:g.name,style:{fontSize:"16px",textAlign:"center",marginBottom:"30px"}}),r=h.createDiv({style:{}});if(G=h.createDiv({style:{verticalAlign:"top",padding:"20px",textAlign:"left",display:W?null:"inline-block",width:W||E?null:w}}),R=R||h.createDiv({style:{position:"fixed",bottom:"0px",left:"right"===W?"calc(50% + 20px)":null,right:"left"===W?"calc(50% + 20px)":null,width:W?"calc(50% - 40px)":E?null:w,zIndex:1e4}}),H=H||h.createDiv({style:{position:"fixed",bottom:"0px",left:"right"===W?"calc(50% + 20px)":null,right:"left"===W?"calc(50% + 20px)":null,width:W?"calc(50% - 40px)":E?null:w,backgroundColor:"white",height:"29px",lineHeight:"29px"}}),z=h.createDiv({id:"main-body",append:[A&&"notes"!==g.type&&"workspace"!==g.type&&"project"!==g.type&&"task"!==g.type?s:null,W?o:null,W?l:null,G,R,H],style:b||{width:W||E?null:w,display:W||E?null:"inline-block",textAlign:"center"}}),W||(e.parentNode.parentNode.parentNode.parentNode.style.paddingTop="5px",stickyTrigger=h.createDiv({}),e.appendChild(stickyTrigger)),D&&e.appendChild(i),N&&({type:i,name:d}=g,{pathname:c,search:t}=window.location,(t=new URLSearchParams(t)).delete("chats"),t.delete("models"),t.set("chat",g.uuid),p=i.charAt(0).toUpperCase()+i.slice(1),i=h.createLink({text:Y?""+p:"regular"===i?d+" "+(d.match(/^chat-/),""):p,href:(""===c?"/":c)+"?"+t.toString(),style:{color:"black"}}),e.appendChild(h.createDiv({append:i,style:{textAlign:"center",fontSize:"16px",fontWeight:500}}))),v?e.appendChild(h.createDiv({append:[z],style:{textAlign:"center"}})):e.appendChild(z),!W&&!C){var d=calculateIdealLeftMargin(z,IDEAL_RIGHT_WIN_WIDTH);z.style.marginLeft=d;let a="calc(100% - 66px)";P=new FloatingDiv({width:IDEAL_RIGHT_WIN_WIDTH,height:a,minWidth:300,position:{right:20},style:{borderLeft:"1px solid #666"},storageKey:RIGHT_FLOATING_WIN_KEY}).init();var p={threshold:1,root:null,rootMargin:"0px"},c=(new IntersectionObserver((e,t)=>{e.forEach(e=>{e.isIntersecting?P&&(P.elements.container.style.height=a):P&&(P.elements.container.style.height="calc(100% - 53px)")})},p).observe(stickyTrigger),(e,t)=>{e.forEach(e=>{e.isIntersecting})});new IntersectionObserver(c,p).observe(s)}return{breadcrumbsBody:a,menusBody:n,quickChatButtonsBody:s,settingsBody:l,metricsBody:r,titleBody:o,conversationBody:G}})(d),l=new Breadcrumbs(g),o=(l.render(e),new V),r=(o.render(t),new $);r.render(a),W&&j(n);var{deleteChatMessage:p,editChatMessage:c}=m.permissions;(F=new ConversationView(u,m,g,y,U,{chatInputBody:R,chatInputStyle:f,chatInputMsgBody:H,inSideBySide:W,minWidth:T,maxWidth:k,scrollableElement:B||(W?d:null),showChat:I,showEdit:c,showTryAgain:p,showInsights:M,showNewChatOptions:L},{onStreamMessageComplete:async t=>{if(g.is_default_name&&2===t.level){var{generateChatTitle:t={enable:!1}}=m;let{enable:e,model:a}=t;if(e){if(!a||"default"===a){var{models:n=[]}=m;let t=null;for(let e=0;e<n.length;e++){var i=n[e];if(i.default){t=i;break}}if(!t)return void console.warn("Generate chat title enabled, but no default model defined");a=t.name}t=(await updateChatName(u,g.uuid,null,null,!0,a)).chat;l.update(t),s.innerText=t.name,(new History).save(t)}}}})).render(i),P&&(async e=>{let t=g.lineage?"git-repos"===g.lineage[0].type:"Repositories"===g.name,a=null;var n,i;t?(a=await getChat(u,{uuid:"repositories",model:"GitSense Notes",maxDepth:3}),(n=g.lineage?g.lineage.find(e=>"git-ref"===e.type):null)&&(n=await getGitRefChatByFamilyMember(u,{id:n.id}),a.descendants.push(...n.descendants))):(n=(0===g.parent_id?g:g.lineage[0]).uuid,a=await getChat(u,{uuid:n,model:y}));let s=[...a.descendants],l=(s.unshift(a),arrayToTree(s)),o=null;for(i of l)if(findNodeById(i,g.id)){o=i;break}if(!o)throw new Error(`No root chat tree for chat #${g.id}/${g.uuid} found`);var r=[o],{overviewBody:e,chatsTreeBody:d,quickChatButtonsBody:p}=(t||r.push(await(async()=>{var e,t=await getChat(u,{uuid:"repositories",model:"GitSense Notes",maxDepth:3});if(t)return(e=[...t.descendants]).unshift(t),arrayToTree(e)[0]})()),(e=>{var t=h.createDiv({style:{marginTop:"20px"}}),a=h.createDiv({style:{}}),n=h.createDiv({style:{display:"flex",flexWrap:"wrap",alignItems:"center",justifyContent:"center",gap:"10px",marginTop:"25px",marginBottom:"15px"}});return e.appendChild(t),e.appendChild(n),e.appendChild(a),{overviewBody:t,chatsTreeBody:a,quickChatButtonsBody:n}})(e)),e=((O=new J(g)).render(e),(async(t,a,n)=>{let i=[{key:"current_node_indicator",label:"",visible:!1,width:"20px"},{key:"name",label:"Name",visible:!0,width:"100%"},{key:"chats",label:"Chats",visible:!1},{key:"created_at",label:"Created",visible:!0,width:"60px",textAlign:"right"},{key:"latest_child",label:"Latest",visible:!1},{key:"actions",visible:!1,width:"30px"},{key:"selection",visible:!0,width:"20px"}],s={name:e=>{var t,a,n=e.uuid,{pathname:i,search:s}=window.location,s=new URLSearchParams(s),l=(W?(t=s.get("chats").split(","),a=s.get("models").split(","),t[l="left"===W?0:1]=n,a[l]=main_model,s.set("chats",t.join(",")),s.set("models",a.join(","))):(s.set("chat",n),s.delete("model")),h.createLink({html:e.name.replace(/^\[\s*\] /,"[&nbsp; ] "),href:(""===i?"/":i)+"?"+s.toString(),style:{color:"black"}}));return l},createdAt:e=>formatAge(e.created_at).replace(/ ago/,"")};setTimeout(()=>{var e=TreeTable(n,t,{decorator:s,showHeader:!1,showPagination:!1,rowsPerPage:10,styles:"nav",autoExpandRoot:!0,currentNodeId:g.id,columns:i,visualDayBreaks:!1,sortRootBy:"order_weight",sortRootOrder:"asc",onAddContext:async(e,t)=>{t={tool:"context-loader",config:{container:{style:{marginTop:"20px"}},actions:{load:{type:"link",text:"Review, load, and add",showCopy:!0,showSave:!0},copy:{type:"link"},paste:{type:"link"}},postLoad:{show:!0},showManage:!0,chatIds:t.map(e=>e.id)}},e+="\n\n```txt\n"+GSToolBlockUtils.formatToolBlock(t)+"\n```",t=MessageUtils.getLastMessage(g.messages[0]),t={type:"context",parentId:t.id,model:g.main_model,role:"assistant",temperature:0,stream:!1,message:e};await newChatMessage(u,g.id,t),U()},onSelectionChange:(e,t)=>{},onSelectionStateChange:(e,t)=>{F.treeTableStateChanged(e,t)},chatApi:{createAskAIChat:async e=>{let t=h.createDiv({style:"display:none"});document.body.appendChild(t);var e={type:"context-builder-ask-ai",params:{overview:e},onDone:()=>{t.remove()}},a={widget:u,chat:g,settings:m},a=new QuickChatButtons([e],a);a.render(t),a.click(e)},getAnalyzers:async()=>getAnalyzers(u),getAnalyzerSchema:async e=>getAnalyzerSchema(u,e),getGitRefChatDescendants:async e=>{var e=await getGitRefChatByFamilyMember(u,{id:e}),t=[...e.descendants];return t.unshift(e),arrayToTree(t,"desc",e.id)},getGitRefChatByFamilyMember:async e=>getGitRefChatByFamilyMember(u,{id:e}),getGitBlobChatMessagesByChatIds:async(e,t)=>getGitBlobChatMessagesByChatIds(u,e,t),getChatOverviewMessagesByChatIds:async(e,t="short")=>getChatOverviewMessagesByChatIds(u,e,t),getTinyChatOverviewPurpose:async e=>getTinyChatOverviewPurpose(u,e),search:async e=>search(u,e)},fetchDescendants:async e=>{console.log("nodeId: ",e)}});F.setTreeTableComponent(e),e.expandToChild(a.id,g.id)},100)})(d,a,r),p),d=o,r=[{type:"notes"},{type:"draft"},{type:"organize"},{type:"edit"},{type:"context",onNewMessage:e=>{U(()=>{F.scrollToBottom()})}},{type:"task"},{type:"code"},{type:"analyze"},{type:"search",label:"Ask or Search<span style='font-size:.6em;margin-left:5px;'>▼</span>",onNewMessage:e=>{U(()=>{F.scrollToBottom()})},style:{width:"48.5%",minWidth:"48.5%",maxWidth:"48.5%"}},{type:"analyzers",style:{width:"48.5%",minWidth:"48.5%",maxWidth:"48.5%"}}],d={widget:u,chat:g,rootChat:d,inSideBySide:W,settings:m};(q=new QuickChatButtons(r,d)).render(e)})(P.elements.content)}}}function calculateIdealLeftMargin(e,t){var a=window.innerWidth,e=e.getBoundingClientRect(),n=e.width;return Math.max(0,(a-n-t)/2-e.left-10)}module.exports={ChatPage:ChatPage};
