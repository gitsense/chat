#!/bin/bash

# Component: gscb CLI Wrapper
# Block-UUID: 5de3bb2e-f29e-4690-8960-149bda9006b4
# Parent-UUID: 6d24ef6d-e43b-42bf-9138-c45ec0d3b1aa
# Version: 1.1.0
# Description: A wrapper script to execute the @gitsense/gscb-cli from node_modules.
# Language: Bash
# Created-at: 2025-08-14T04:30:15.764Z
# Authors: Gemini 2.5 Flash Thinking (v1.0.0), Gemini 2.5 Flash Thinking (v1.1.0)

# Resolve the directory where this script is located
SCRIPT_DIR=$(dirname "$(readlink -f "$0")")

# Define the hardcoded database path
# This path is relative to the directory containing the 'gscb' executable
DB_PATH="${SCRIPT_DIR}/../data/chats.sqlite3"

# Define the path to the gscb.js executable relative to the script's directory
GSCB_CLI_PATH="${SCRIPT_DIR}/../node_modules/@gitsense/gscb-cli/dist/bin/gscb.js"

# Check if the gscb.js file exists
if [ ! -f "$GSCB_CLI_PATH" ]; then
  echo "Error: @gitsense/gscb-cli not found at $GSCB_CLI_PATH" >&2
  echo "Please ensure you have run 'npm install' in the parent directory." >&2
  exit 1
fi

# Build new arguments, ensuring --db-path is always set to the hardcoded value
NEW_ARGS=()
SKIP_NEXT=false
for arg in "$@"; do
  if [ "$SKIP_NEXT" = true ]; then
    SKIP_NEXT=false
    continue
  fi

  if [[ "$arg" == "--db-path" ]]; then
    SKIP_NEXT=true
    continue
  elif [[ "$arg" == "--db-path="* ]]; then # Handle --db-path=value
    continue
  fi
  NEW_ARGS+=("$arg")
done

# Append the hardcoded --db-path ONLY if more than 2 arguments were originally provided
if [ "$#" -gt 2 ]; then
  NEW_ARGS+=("--db-path" "$DB_PATH")
fi

# Execute the gscb.js script using node, passing the modified arguments
node "$GSCB_CLI_PATH" "${NEW_ARGS[@]}"
